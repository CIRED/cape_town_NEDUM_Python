<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Technical documentation &mdash; NEDUM-2D for CoCT  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Appendix" href="appendix.html" />
    <link rel="prev" title="API reference" href="api_ref.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            NEDUM-2D for CoCT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="readme_link.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="guidelines.html">General framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_case_nb.html">Notebook: use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="main_nb.html">Notebook: run model</a></li>
<li class="toctree-l1"><a class="reference internal" href="calib_nb.html">Notebook: run calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_ref.html">API reference</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Technical documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#code-walk-through">Code walk-through</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inputs">Inputs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#parameters-and-options">Parameters and options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#assumptions">Assumptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data">Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#land-use-data">Land use data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#flood-data">Flood data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#transport-data">Transport data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#equilibrium">Equilibrium</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#initial-state">Initial state</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#solving-for-equilibrium">Solving for equilibrium</a></li>
<li class="toctree-l4"><a class="reference internal" href="#functional-assumptions">Functional assumptions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#equilibrium-dwelling-size">Equilibrium dwelling size</a></li>
<li class="toctree-l4"><a class="reference internal" href="#equilibrium-rent">Equilibrium rent</a></li>
<li class="toctree-l4"><a class="reference internal" href="#equilibrium-housing-supply">Equilibrium housing supply</a></li>
<li class="toctree-l4"><a class="reference internal" href="#equilibrium-number-of-households">Equilibrium number of households</a></li>
<li class="toctree-l4"><a class="reference internal" href="#iteration-and-results">Iteration and results</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#subsequent-periods">Subsequent periods</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#outputs">Outputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#calibration">Calibration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#housing-production-function-parameters">Housing production function parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#incomes-and-gravity-parameter">Incomes and gravity parameter</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#transport-costs">Transport costs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#income-calculation">Income calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#parameter-selection">Parameter selection</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#utility-function-parameters">Utility function parameters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#external-calibration">External calibration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fit-on-exogenous-amenities">Fit on exogenous amenities</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fit-on-income-sorting">Fit on income sorting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fit-on-dwelling-sizes">Fit on dwelling sizes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#smooth-optimization">Smooth optimization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#disamenity-index">Disamenity index</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="license_rst.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">NEDUM-2D for CoCT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Technical documentation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/technical_doc.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <a class="reference internal image-reference" href="_images/banner_crop.png"><img alt="Sponsors' logo banner" src="_images/banner_crop.png" style="width: 100%;" /></a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="technical-documentation">
<h1>Technical documentation<a class="headerlink" href="#technical-documentation" title="Permalink to this heading"></a></h1>
<div class="section" id="code-walk-through">
<h2>Code walk-through<a class="headerlink" href="#code-walk-through" title="Permalink to this heading"></a></h2>
<p>The project repository is composed of a <code class="docutils literal notranslate"><span class="pre">main_nb</span></code> script, a <code class="docutils literal notranslate"><span class="pre">calib_nb</span></code> script (a static version of which is shown in <a class="reference internal" href="main_nb.html"><span class="doc">Notebook: run model</span></a> and <a class="reference internal" href="calib_nb.html"><span class="doc">Notebook: run calibration</span></a>), and <code class="docutils literal notranslate"><span class="pre">plots</span></code> scripts, themselves calling on several secondary scripts and custom packages. Those packages in turn include modules that are used at different steps of the code:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">inputs</span></code>: contains the modules used to import default parameters and options, as well as pre-treated data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">equilibrium</span></code>: contains the modules used to compute the static equilibrium allocation, as well as the dynamic simulations.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">outputs</span></code>: contains the modules used to visualize results and data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">calibration</span></code>: contains the modules used to re-run the calibration of parameters if necessary.</p></li>
</ul>
<p>All the scripts placed at the root start with a preamble that imports (python and custom) packages to be used, and defines the file paths that integrate the repository to the local system of the user. They then go on calling the packages described above. They make almost all the same calls on the <code class="docutils literal notranslate"><span class="pre">inputs</span></code> package, then specific calls depending on the script (<code class="docutils literal notranslate"><span class="pre">main_nb</span></code> mostly draws on <code class="docutils literal notranslate"><span class="pre">equilibrium</span></code>, <code class="docutils literal notranslate"><span class="pre">calib_nb</span></code> on <code class="docutils literal notranslate"><span class="pre">calibration</span></code>, and <code class="docutils literal notranslate"><span class="pre">plots</span></code> scripts on <code class="docutils literal notranslate"><span class="pre">outputs</span></code>). Let us start describing those packages by following along the <code class="docutils literal notranslate"><span class="pre">main_nb</span></code> script (we refer the reader to <a class="reference internal" href="api_ref.html"><span class="doc">API reference</span></a> for detailed information on the functions we will use).</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="inputs">
<h2>Inputs<a class="headerlink" href="#inputs" title="Permalink to this heading"></a></h2>
<div class="section" id="parameters-and-options">
<h3>Parameters and options<a class="headerlink" href="#parameters-and-options" title="Permalink to this heading"></a></h3>
<p>In this part, the code calls on the <code class="docutils literal notranslate"><span class="pre">parameters_and_options.py</span></code> module that imports the default parameters and options, then sets the timeline for the simulations, and overwrites the default parameters and options according to the specific scenario one is interested in. The detail of key parameters and options is given in <a class="reference internal" href="input_tables.html"><span class="doc">Input tables</span></a> (there are other technical parameters and options that should be of no interest for the end user) <a class="footnote-reference brackets" href="#f1" id="id1">1</a>. Typically, one may set options allowing or not agents to anticipate floods, take climate climate change into account, or new informal settlements to be built.</p>
<p>Note that, on top of the <code class="docutils literal notranslate"><span class="pre">import_options</span></code> and <code class="docutils literal notranslate"><span class="pre">import_param</span></code> functions, the code later calls on a <code class="docutils literal notranslate"><span class="pre">import_construction_parameters</span></code> function that makes use of imported data to define additional parameter variables.</p>
<p>The key ones are the <code class="docutils literal notranslate"><span class="pre">mini_lot_size</span></code> parameter and the <code class="docutils literal notranslate"><span class="pre">agricultural_rent</span></code> variable (defined through <code class="docutils literal notranslate"><span class="pre">compute_agricultural_rent</span></code> as a function of other parameters). Here is how to interpret the value of agricultural rent. We assume that the price of agricultural land (corresponding to landlords’ outside options / opportunity cost, here <code class="docutils literal notranslate"><span class="pre">agricultural_price_baseline</span></code> parameter) is fixed and that agricultural land is undeveloped. Since we assume that developers make zero profit in equilibrium due to pure and perfect competition, this gives us a relation to obtain the minimum rent developers would be willing to accept if this land were urbanized <a class="footnote-reference brackets" href="#fagri" id="id2">2</a>:</p>
<div class="math notranslate nohighlight">
\[R_A = \frac{(\delta P_A)^a (\rho + \delta)^{1-a}}{\kappa a^a (1-a)^{1-a}}\]</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">compute_agricultural_rent</span></code> function, this corresponds to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">663</span>        <span class="n">agricultural_rent</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">664</span>            <span class="n">rent</span> <span class="o">**</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_a&quot;</span><span class="p">]</span>
<span class="linenos">665</span>            <span class="o">*</span> <span class="n">interest_rate</span> <span class="o">**</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_a&quot;</span><span class="p">]</span>
<span class="linenos">666</span>            <span class="o">*</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;depreciation_rate&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">interest_rate</span><span class="p">)</span> <span class="o">**</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_b&quot;</span><span class="p">]</span>
<span class="linenos">667</span>            <span class="o">/</span> <span class="p">(</span><span class="n">scale_fact</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_b&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_b&quot;</span><span class="p">]</span>
<span class="linenos">668</span>                <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_a&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_a&quot;</span><span class="p">])</span>
<span class="linenos">669</span>            <span class="p">)</span>
</pre></div>
</div>
<p>Below this rent, it is therefore never profitable to build housing. Agricultural rent defines a floor on equilibrium rent values as well as an endogenous city edge.</p>
<p>To store the output in a dedicated folder, we create a name associated to the parameters and options used. This name is a code associated to the options, parameters, and scenarios that we changed across our main simulation runs. They can be safely updated by the end user.</p>
</div>
<div class="section" id="assumptions">
<h3>Assumptions<a class="headerlink" href="#assumptions" title="Permalink to this heading"></a></h3>
<p>Note that, in the model, we consider three endogenous housing markets (whose allocation is computed in equilibrium) - namely, formal private housing, informal backyards (erected in the backyard of formal subsidized housing dwelling units), and informal settlements (in predetermined locations) <a class="footnote-reference brackets" href="#f2" id="id3">3</a> - one exogenous housing market (whose allocation is directly taken from the data) - the RDP (Reconstruction and Development Programme) formal subsidized housing <a class="footnote-reference brackets" href="#f3" id="id4">4</a> - and four income groups.</p>
<p>By default, only agents from the poorest income group have access to RDP housing units. Without loss of generality, we assume that the price of such dwellings is zero, and that they are allocated randomly to the fraction of poorest agents they can host, the rest being rationed out of the formal subsidized housing market. Then, the two poorest income groups sort across formal private housing, informal backyards, and informal settlements; whereas the two richest only choose to live in the formal private housing units. Those assumptions are passed into the code through the <code class="docutils literal notranslate"><span class="pre">income_class_by_housing_type</span></code> parameter. We believe that this is a good approximation of reality. Also note that, although the two richest income groups are identical in terms of housing options, we distinguish between them to better account for income heterogeneity and spatial sorting along income lines in our simulations, while keeping the model sufficiently simple to be solved numerically.</p>
<div class="figure align-center" id="id63">
<a class="reference internal image-reference" href="_images/inc_group_distrib.png"><img alt="summary table of the modeling assumptions regarding housing" src="_images/inc_group_distrib.png" style="width: 463.2px; height: 259.8px;" /></a>
<p class="caption"><span class="caption-text">Modeling assumptions regarding housing (<em>Source</em>: <span id="id5">Pfeiffer <em>et al.</em> [<a class="reference internal" href="bibliography.html#id43" title="B. Pfeiffer, C. Rabe, H. Selod, and V. Viguie. Assessing Urban Policies Using a Simulation Model with Formal and Informal Housing. World Bank Policy Research Working Paper Series, 2019.">2019</a>]</span>)</span><a class="headerlink" href="#id63" title="Permalink to this image"></a></p>
</div>
</div>
<div class="section" id="data">
<h3>Data<a class="headerlink" href="#data" title="Permalink to this heading"></a></h3>
<p>Then, the code calls on the <code class="docutils literal notranslate"><span class="pre">data.py</span></code> module. This allows to import basic geographic data, macro data, households and income data, land use projections, flood data, scenarios for time-dependent variables, and transport data (see <a class="reference internal" href="readme_link.html"><span class="doc">Setup</span></a> for the appropriate tree structure where to locate the data folder). The databases used are presented in <a class="reference internal" href="data_bases.html"><span class="doc">Data bases</span></a>. A more detailed view on the specific data sets called in the code, and their position in the folder architecture, is given in <a class="reference internal" href="data_sets.html"><span class="doc">Key data sets</span></a> <a class="footnote-reference brackets" href="#fdata" id="id6">5</a>.</p>
<p>It should be noted that, by default, housing type data (used for validation) has already been converted from the SAL (Small Area Level) dimension to the grid dimension (500x500m pixels) with the <code class="docutils literal notranslate"><span class="pre">import_sal_data</span></code> and <code class="docutils literal notranslate"><span class="pre">gen_small_areas_to_grid</span></code> functions, and that income net of commuting costs for each income group and each grid cell (from transport data) has already been computed from the calibrated incomes for each income group and each job center with the <code class="docutils literal notranslate"><span class="pre">import_transport_data</span></code> function. If one wants to run the process again, one needs to overwrite the associated default options (please note that this may take some time to run). The import of flood data (through the <code class="docutils literal notranslate"><span class="pre">import_full_floods_data</span></code> function) is also a little time-consuming when agents are set to anticipate floods.</p>
<p>A bit counter-intuitively, the scenario for the interest rate does not only serve to define future values of the variable (more on that in <a class="reference internal" href="#subsequent-periods"><span class="std std-ref">Subsequent periods</span></a>), but also its value at the initial state (as the raw data contains both past and future values). As part of the <code class="docutils literal notranslate"><span class="pre">import_macro_data</span></code> function, the <code class="docutils literal notranslate"><span class="pre">interest_rate</span></code> variable is defined as an average over the past three years, through the <code class="docutils literal notranslate"><span class="pre">interpolate_interest_rate</span></code> function defined in the <code class="docutils literal notranslate"><span class="pre">functions_dynamic.py</span></code> module (included in the <code class="docutils literal notranslate"><span class="pre">equilibrium</span></code> package). This allows to smooth outcomes around a supposed equilibrium value:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">338</span>    <span class="c1">#  Import interest rate history + scenario until 2040</span>
<span class="linenos">339</span>    <span class="n">scenario_interest_rate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
<span class="linenos">340</span>        <span class="n">path_scenarios</span> <span class="o">+</span> <span class="s1">&#39;Scenario_interest_rate_1.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<span class="linenos">341</span>    <span class="c1">#  Fit linear regression spline centered around baseline year</span>
<span class="linenos">342</span>    <span class="n">spline_interest_rate</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
<span class="linenos">343</span>        <span class="n">scenario_interest_rate</span><span class="o">.</span><span class="n">Year_interest_rate</span><span class="p">[</span>
<span class="linenos">344</span>            <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">scenario_interest_rate</span><span class="o">.</span><span class="n">real_interest_rate</span><span class="p">)]</span>
<span class="linenos">345</span>        <span class="o">-</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;baseline_year&quot;</span><span class="p">],</span>
<span class="linenos">346</span>        <span class="n">scenario_interest_rate</span><span class="o">.</span><span class="n">real_interest_rate</span><span class="p">[</span>
<span class="linenos">347</span>            <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">scenario_interest_rate</span><span class="o">.</span><span class="n">real_interest_rate</span><span class="p">)],</span>
<span class="linenos">348</span>        <span class="s1">&#39;linear&#39;</span>
<span class="linenos">349</span>        <span class="p">)</span>
<span class="linenos">350</span>    <span class="c1">#  Get interest rate as the mean (in %) over (3) last years</span>
<span class="linenos">351</span>    <span class="n">interest_rate</span> <span class="o">=</span> <span class="n">eqdyn</span><span class="o">.</span><span class="n">interpolate_interest_rate</span><span class="p">(</span><span class="n">spline_interest_rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">292</span><span class="k">def</span> <span class="nf">interpolate_interest_rate</span><span class="p">(</span><span class="n">spline_interest_rate</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="linenos">293</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">294</span><span class="sd">    Return real interest rate used in model, for a given year.</span>
<span class="linenos">295</span>
<span class="linenos">296</span><span class="sd">    Parameters</span>
<span class="linenos">297</span><span class="sd">    ----------</span>
<span class="linenos">298</span><span class="sd">    spline_interest_rate : interp1d</span>
<span class="linenos">299</span><span class="sd">        Linear interpolation for the interest rate (in %) over the years</span>
<span class="linenos">300</span><span class="sd">    t : int</span>
<span class="linenos">301</span><span class="sd">        Year for which we want to run the function</span>
<span class="linenos">302</span>
<span class="linenos">303</span><span class="sd">    Returns</span>
<span class="linenos">304</span><span class="sd">    -------</span>
<span class="linenos">305</span><span class="sd">    float64</span>
<span class="linenos">306</span><span class="sd">        Real interest rate used in the model, and defined as the average over</span>
<span class="linenos">307</span><span class="sd">        past (3) years to convey the structural (as opposed to conjonctural)</span>
<span class="linenos">308</span><span class="sd">        component of the interest rate</span>
<span class="linenos">309</span>
<span class="linenos">310</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">311</span>    <span class="n">nb_years</span> <span class="o">=</span> <span class="mi">3</span>
<span class="linenos">312</span>    <span class="n">interest_rate_n_years</span> <span class="o">=</span> <span class="n">spline_interest_rate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">nb_years</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
<span class="linenos">313</span>    <span class="n">interest_rate_n_years</span><span class="p">[</span><span class="n">interest_rate_n_years</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="linenos">314</span>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">interest_rate_n_years</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span>
</pre></div>
</div>
<p>The imported files can be modified directly in the data repository, to account for changes in scenarios for instance, as long as the format used remains the same (see <a class="reference internal" href="api_ref.html"><span class="doc">API reference</span></a> for more details on each function requirements). Before going to the next step of the code, we would like to give more details on the imports of land use, flood, and transport data, which we think are not as transparent as the rest of the imports.</p>
<div class="section" id="land-use-data">
<span id="land-avail-desc"></span><h4>Land use data<a class="headerlink" href="#land-use-data" title="Permalink to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">import_land_use</span></code> and <code class="docutils literal notranslate"><span class="pre">import_coeff_land</span></code> functions define exogenous land availability <span class="math notranslate nohighlight">\(L^h(x)\)</span> for each housing type <span class="math notranslate nohighlight">\(h\)</span> and each grid cell <span class="math notranslate nohighlight">\(x\)</span>. Indeed, we assume that different kinds of housing do not get built in the same places to account for insecure property rights (in the case of informal settlements vs. formal private housing) and housing specificities (in the case of non-market formal subsidized housing and informal backyards located in the same premises) <a class="footnote-reference brackets" href="#fmixed" id="id7">6</a>. Furthermore, <span class="math notranslate nohighlight">\(L\)</span> varies with <span class="math notranslate nohighlight">\(x\)</span> to account for both natural and regulatory constraints, infrastructure and other non-residential uses.</p>
<p>As <span class="math notranslate nohighlight">\(L^h(x)\)</span> is going to vary across time periods, the first part of the <code class="docutils literal notranslate"><span class="pre">import_land_use</span></code> function imports estimates for historical and projected land uses. It then defines linear regression splines over time for a set of variables, the key ones being the share of pixel area available for formal subsidized housing, informal backyards, informal settlements, and unconstrained development. Note that, in our benchmark (allowing for informal settlement expansion), land availability for informal settlements is defined over time by the intersection between the timing map below and the high and very high probability areas (also defined below).</p>
<div class="figure align-center" id="id64">
<a class="reference internal image-reference" href="_images/WBUS2_Land_occupation_timing.png"><img alt="map for estimated timing of future informal settlements" src="_images/WBUS2_Land_occupation_timing.png" style="width: 495.0px; height: 382.5px;" /></a>
<p class="caption"><span class="caption-text">Estimated timing of future new informal settlements (<em>Source</em>: expert estimates)</span><a class="headerlink" href="#id64" title="Permalink to this image"></a></p>
</div>
<div class="figure align-center" id="id65">
<a class="reference internal image-reference" href="_images/WBUS2_Land_occupation_probability.png"><img alt="map for estimated probability of future informal settlements" src="_images/WBUS2_Land_occupation_probability.png" style="width: 495.0px; height: 382.5px;" /></a>
<p class="caption"><span class="caption-text">Estimated probability of future new informal settlements (<em>Source</em>: expert estimates)</span><a class="headerlink" href="#id65" title="Permalink to this image"></a></p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">import_coeff_land</span></code> function then takes those outputs as arguments and reweight them by a housing-specific maximum land-use parameter. This parameter allows to reduce the development potential of each area to its housing component (accounting for roads, for instance). The share of pixel area available for formal private housing (in a given period) is simply defined as the share of pixel area available for unconstrained development, minus the shares dedicated to the other housing types, times its own maximum land use parameter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">944</span>    <span class="n">coeff_land_private</span> <span class="o">=</span> <span class="p">(</span><span class="n">spline_land_constraints</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="linenos">945</span>                          <span class="o">-</span> <span class="n">spline_land_backyard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="linenos">946</span>                          <span class="o">-</span> <span class="n">spline_land_informal</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="linenos">947</span>                          <span class="o">-</span> <span class="n">spline_land_RDP</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;max_land_use&quot;</span><span class="p">]</span>
<span class="linenos">948</span>    <span class="n">coeff_land_private</span><span class="p">[</span><span class="n">coeff_land_private</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">949</span>
<span class="linenos">950</span>    <span class="n">coeff_land_backyard</span> <span class="o">=</span> <span class="p">(</span><span class="n">spline_land_backyard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="linenos">951</span>                           <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;max_land_use_backyard&quot;</span><span class="p">])</span>
<span class="linenos">952</span>    <span class="n">coeff_land_RDP</span> <span class="o">=</span> <span class="n">spline_land_RDP</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;max_land_use&quot;</span><span class="p">]</span>
<span class="linenos">953</span>    <span class="n">coeff_land_settlement</span> <span class="o">=</span> <span class="p">(</span><span class="n">spline_land_informal</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="linenos">954</span>                             <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;max_land_use_settlement&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>The outputs are stored in a <code class="docutils literal notranslate"><span class="pre">coeff_land</span></code> matrix that yields the values of <span class="math notranslate nohighlight">\(L^h(x)\)</span> for each time period when multiplied by the area of a pixel. Results are shown in the figure below.</p>
<div class="figure align-center" id="id66">
<a class="reference internal image-reference" href="_images/land_avail.png"><img alt="map of land availability ratios per housing type" src="_images/land_avail.png" style="width: 886.5px; height: 297.90000000000003px;" /></a>
<p class="caption"><span class="caption-text">Share of available land for each housing type (<em>Source</em>: <span id="id8">Pfeiffer <em>et al.</em> [<a class="reference internal" href="bibliography.html#id43" title="B. Pfeiffer, C. Rabe, H. Selod, and V. Viguie. Assessing Urban Policies Using a Simulation Model with Formal and Informal Housing. World Bank Policy Research Working Paper Series, 2019.">2019</a>]</span>)</span><a class="headerlink" href="#id66" title="Permalink to this image"></a></p>
</div>
</div>
<div class="section" id="flood-data">
<h4>Flood data<a class="headerlink" href="#flood-data" title="Permalink to this heading"></a></h4>
<p>Flood data is processed through the <code class="docutils literal notranslate"><span class="pre">import_init_floods_data</span></code>, <code class="docutils literal notranslate"><span class="pre">compute_fraction_capital_destroyed</span></code>, and <code class="docutils literal notranslate"><span class="pre">import_full_floods_data</span></code> functions.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">import_init_floods_data</span></code> function imports the pre-processed flood maps from FATHOM <span id="id9">[<a class="reference internal" href="bibliography.html#id48" title="C. C. Sampson, A. M. Smith, P. D. Bates, L. Neal, J. C. abd Alfieri, and J. E. Freer. A High-resolution Global Flood Hazard Model. Water Resources Research, 51(9):7358-81, 2015.">Sampson <em>et al.</em>, 2015</a>]</span> for fluvial and pluvial risks, and DELTARES <span id="id10">[<a class="reference internal" href="bibliography.html#id49" title="Deltares. Planetary Computer and Deltares Global Data - Flood Hazard Maps. Technical Report 11206409-003-ZWS-0003, AIforEarthDataSets, 2021.">Deltares, 2021</a>]</span> for coastal risks. Those maps yield for each grid cell an estimate of the pixel share that is exposed to a flood of some maximum depth level, reached in a given year with a probability equal to the inverse of their return period. For instance, a flood map corresponding to a return period of 100 years considers events that have a 1/100 chance of occurring in any given year.</p>
<div class="figure align-center" id="id67">
<a class="reference internal image-reference" href="_images/P_100yr_map_depth.png"><img alt="map of land availability ratios per housing type" src="_images/P_100yr_map_depth.png" style="width: 700.0px; height: 489.99999999999994px;" /></a>
<p class="caption"><span class="caption-text">Maximum pluvial flood depth (in meters) for a 100-year return period (<em>Source</em>: FATHOM)</span><a class="headerlink" href="#id67" title="Permalink to this image"></a></p>
</div>
<p>Note that the return periods considered are not the same for FATHOM and DELTARES data, and that different flood maps are available depending on the digital elevation model (DEM) considered, whether we account for sea-level rise, and whether we account for defensive infrastructure with respect to fluvial floods <a class="footnote-reference brackets" href="#f4" id="id11">7</a>.</p>
<p>The function then imports depth-damage estimates from the existing literature. Those estimates, used in the insurance market, link levels of maximum flood depth to fractions of capital destroyed, depending on the materials affected by floods <a class="footnote-reference brackets" href="#f5" id="id12">8</a>. More specifically, we use estimates from <span id="id13">Englhardt <em>et al.</em> [<a class="reference internal" href="bibliography.html#id14" title="J. Englhardt, H. de Moel, C.K. Huyck, M.C. de Ruiter, J.C.J.H. Aerts, and P.J. Ward. Enhancement of Large-scale Flood Risk Assessments using Building-material-based Vulnerability Curves for an Object-based Approach in Urban and Rural Areas. Natural Hazards and Earth System Sciences, 19:1703-22, 2019.">2019</a>]</span> for damages to housing structures (depending on housing type), and from <span id="id14">de Villiers <em>et al.</em> [<a class="reference internal" href="bibliography.html#id15" title="G. de Villiers, M.F. Viljoen, and H.J. Booysen. Standard Residential Flood Damage Functions for South African Conditions. Suid-Afrikaanse Tydskrif vir Natuurwetenskap en Tegnologie, 26(1):26-36, 2007.">2007</a>]</span> for damages to housing contents.</p>
<p>On this basis, the <code class="docutils literal notranslate"><span class="pre">compute_fraction_capital_destroyed</span></code> function integrates flood damages over the full range of return periods, for each flood type and damage function <a class="footnote-reference brackets" href="#f6" id="id15">9</a>. This yields an annualized fraction of capital destroyed, corresponding to its expected value in a given year <a class="footnote-reference brackets" href="#f7" id="id16">10</a>.</p>
<p>Finally, the <code class="docutils literal notranslate"><span class="pre">import_full_floods_data</span></code> function uses those outputs to define the depreciation term <span class="math notranslate nohighlight">\(\rho_{h}^{d}(x)\)</span> that is specific to housing type <span class="math notranslate nohighlight">\(h\)</span>, damage type (structures or contents) <span class="math notranslate nohighlight">\(d\)</span>, and location <span class="math notranslate nohighlight">\(x\)</span> (stored in the <code class="docutils literal notranslate"><span class="pre">fraction_capital_destroyed</span></code> matrix), by taking the maximum across fractions of capital destroyed for all flood types considered (a conservative assumption). When multiplied by some capital value, this term yields the expected economic cost from flood risks that is considered by anticipating agents when solving for equilibrium. It is also equal to the risk premium in the case of a perfect risk-based insurance market (leading to full insurance with actuarially fair prices) <a class="footnote-reference brackets" href="#f8" id="id17">11</a>.</p>
<div class="figure align-center" id="id68">
<a class="reference internal image-reference" href="_images/structure_informal_settlements_fract_K_destroyed.png"><img alt="map of annualized fraction of capital destroyed for structures in informal settlements" src="_images/structure_informal_settlements_fract_K_destroyed.png" style="width: 700.0px; height: 489.99999999999994px;" /></a>
<p class="caption"><span class="caption-text">Annualized fraction of capital destroyed for structures in informal settlements</span><a class="headerlink" href="#id68" title="Permalink to this image"></a></p>
</div>
</div>
<div class="section" id="transport-data">
<h4>Transport data<a class="headerlink" href="#transport-data" title="Permalink to this heading"></a></h4>
<p>Transport data is processed through the <code class="docutils literal notranslate"><span class="pre">import_transport_data</span></code> function. It imports monetary and time transport costs, and pre-calibrated incomes (<code class="docutils literal notranslate"><span class="pre">income_centers_init</span></code> parameter) per income group and job center (more on that in <a class="reference internal" href="#transport-costs"><span class="std std-ref">Transport costs</span></a>), for a given dimension (grid-cell level or Small Place level) and a given simulation year (zero at initial state):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1955</span>    <span class="c1"># Import (monetary and time) transport costs</span>
<span class="linenos">1956</span>    <span class="p">(</span><span class="n">timeOutput</span><span class="p">,</span> <span class="n">distanceOutput</span><span class="p">,</span> <span class="n">monetaryCost</span><span class="p">,</span> <span class="n">costTime</span>
<span class="linenos">1957</span>     <span class="p">)</span> <span class="o">=</span> <span class="n">calcmp</span><span class="o">.</span><span class="n">import_transport_costs</span><span class="p">(</span>
<span class="linenos">1958</span>         <span class="n">grid</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">yearTraffic</span><span class="p">,</span> <span class="n">households_per_income_class</span><span class="p">,</span>
<span class="linenos">1959</span>         <span class="n">spline_inflation</span><span class="p">,</span> <span class="n">spline_fuel</span><span class="p">,</span> <span class="n">spline_population_income_distribution</span><span class="p">,</span>
<span class="linenos">1960</span>         <span class="n">spline_income_distribution</span><span class="p">,</span> <span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">path_precalc_transp</span><span class="p">,</span>
<span class="linenos">1961</span>         <span class="n">dim</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1982</span>    <span class="c1"># Update average income and number of households per income group</span>
<span class="linenos">1983</span>    <span class="c1"># for considered year</span>
<span class="linenos">1984</span>    <span class="n">incomeGroup</span><span class="p">,</span> <span class="n">households_per_income_class</span> <span class="o">=</span> <span class="n">eqdyn</span><span class="o">.</span><span class="n">compute_average_income</span><span class="p">(</span>
<span class="linenos">1985</span>        <span class="n">spline_population_income_distribution</span><span class="p">,</span> <span class="n">spline_income_distribution</span><span class="p">,</span>
<span class="linenos">1986</span>        <span class="n">param</span><span class="p">,</span> <span class="n">yearTraffic</span><span class="p">)</span>
<span class="linenos">1987</span>
<span class="linenos">1988</span>    <span class="c1"># We import expected income associated with each income center and income</span>
<span class="linenos">1989</span>    <span class="c1"># group (from calibration)</span>
<span class="linenos">1990</span>    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;load_precal_param&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">1991</span>        <span class="n">income_centers_init</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span>
<span class="linenos">1992</span>            <span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;incomeCentersKeep.mat&#39;</span><span class="p">)[</span><span class="s1">&#39;incomeCentersKeep&#39;</span><span class="p">]</span>
<span class="linenos">1993</span>    <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;load_precal_param&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">1994</span>        <span class="n">income_centers_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
<span class="linenos">1995</span>            <span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;incomeCentersKeep.npy&#39;</span><span class="p">)</span>
<span class="linenos">1996</span>    <span class="c1"># income_centers_init[income_centers_init == -np.inf] = np.nan</span>
<span class="linenos">1997</span>
<span class="linenos">1998</span>    <span class="c1"># We correct the level of incomes per job center when overall average</span>
<span class="linenos">1999</span>    <span class="c1"># income per income group changes with time (only used as an initial</span>
<span class="linenos">2000</span>    <span class="c1"># value for the algorithm)</span>
<span class="linenos">2001</span>    <span class="n">incomeCenters</span> <span class="o">=</span> <span class="n">income_centers_init</span> <span class="o">*</span> <span class="n">incomeGroup</span> <span class="o">/</span> <span class="n">average_income</span>
</pre></div>
</div>
<p>From there, it computes several outputs, of which the key variable is the expected income net of commuting costs <span class="math notranslate nohighlight">\(\tilde{y}_i(x)\)</span>, earned by a household of income group <span class="math notranslate nohighlight">\(i\)</span> choosing to live in <span class="math notranslate nohighlight">\(x\)</span> (stored in the <code class="docutils literal notranslate"><span class="pre">income_net_of_commuting_costs</span></code> matrix). It is obtained by recursively solving for the optimal transport mode choice and job center choice of households characterized by <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(x\)</span> (see <a class="reference internal" href="math_appendix.html"><span class="doc">Commuting choice model</span></a> for more details).</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="equilibrium">
<span id="equilibrium-desc"></span><h2>Equilibrium<a class="headerlink" href="#equilibrium" title="Permalink to this heading"></a></h2>
<p>This part of the <code class="docutils literal notranslate"><span class="pre">main_nb</span></code> script simply calls on two functions that return the key outputs of the model: <code class="docutils literal notranslate"><span class="pre">compute_equilibrium</span></code> solves the static equilibrium for baseline year, and <code class="docutils literal notranslate"><span class="pre">run_simulation</span></code> solves its dynamic version for all pre-defined subsequent years. Those functions in turn call on modules in the <code class="docutils literal notranslate"><span class="pre">sub</span></code> directory.</p>
<div class="section" id="initial-state">
<h3>Initial state<a class="headerlink" href="#initial-state" title="Permalink to this heading"></a></h3>
<p>Let us first dig into the <code class="docutils literal notranslate"><span class="pre">compute_equilibrium</span></code> function. Our main input is the total population per income group in the city at baseline year (2011). Since we took the non-employed (earning no income over the year) out to define our four income groups (with the <code class="docutils literal notranslate"><span class="pre">inputs.data.import_income_classes_data</span></code> function), we need to reweight total population to account for the overall number of households <a class="footnote-reference brackets" href="#active-pop" id="id18">12</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">145</span>        <span class="n">ratio</span> <span class="o">=</span> <span class="n">population</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">households_per_income_class</span><span class="p">)</span>
<span class="linenos">146</span>        <span class="n">households_per_income_class</span> <span class="o">=</span> <span class="n">households_per_income_class</span> <span class="o">*</span> <span class="n">ratio</span>
</pre></div>
</div>
<p>The associated distribution is given below:</p>
<div class="figure align-center" id="id69">
<a class="reference internal image-reference" href="_images/households_per_income_class.png"><img alt="summary table of income groups characteristics" src="_images/households_per_income_class.png" style="width: 425.4px; height: 166.2px;" /></a>
<p class="caption"><span class="caption-text">Income groups used in the simulation (<em>Source</em>: <span id="id19">Pfeiffer <em>et al.</em> [<a class="reference internal" href="bibliography.html#id43" title="B. Pfeiffer, C. Rabe, H. Selod, and V. Viguie. Assessing Urban Policies Using a Simulation Model with Formal and Informal Housing. World Bank Policy Research Working Paper Series, 2019.">2019</a>]</span>)</span><a class="headerlink" href="#id69" title="Permalink to this image"></a></p>
</div>
<p>Then, considering that all formal subsidized housing belongs to the poorest income group, we substract the corresponding number of households from this class to keep only the ones whose allocation in the housing market is going to be determined endogenously:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">167</span>    <span class="n">households_per_income_class</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
<span class="linenos">168</span>        <span class="n">households_per_income_class</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">total_RDP</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we shorten the grid to consider only habitable pixels (according to land availability and expected income net of commuting costs) to reduce numeric computations, and initialize a few key variables before starting the optimization per se:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">171</span>    <span class="c1">#  We select pixels with constructible shares for all housing types &gt; 0.01</span>
<span class="linenos">172</span>    <span class="c1">#  and a positive maximum income net of commuting costs across classes</span>
<span class="linenos">173</span>    <span class="c1">#  NB: we will have no output in other pixels (numeric simplification)</span>
<span class="linenos">174</span>    <span class="n">selected_pixels</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">175</span>        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coeff_land</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos">176</span>        <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">income_net_of_commuting_costs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">177</span>        <span class="p">)</span>
</pre></div>
</div>
<div class="section" id="solving-for-equilibrium">
<span id="solving-desc"></span><h4>Solving for equilibrium<a class="headerlink" href="#solving-for-equilibrium" title="Permalink to this heading"></a></h4>
<p>Note that, among those variables, we define arbitrary values for utility levels across income groups:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">218</span>    <span class="c1">#  We take arbitrary utility levels, not too far from what we would expect,</span>
<span class="linenos">219</span>    <span class="c1">#  to make computation quicker</span>
<span class="linenos">220</span>    <span class="n">utility</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">4800</span><span class="p">,</span> <span class="mi">16000</span><span class="p">,</span> <span class="mi">77000</span><span class="p">])</span>
</pre></div>
</div>
<p>This relates to the way this class of models is solved: as a closed-city equilibrium model, <strong>NEDUM-2D</strong> takes total population (across income groups) as exogenous, and utility levels (across income groups) as endogenous <a class="footnote-reference brackets" href="#f9" id="id20">13</a>.</p>
<p>It is then solved iteratively in four steps:</p>
<ul class="simple">
<li><p>We first derive housing demand for each housing type</p></li>
<li><p>We deduce rents for each housing type</p></li>
<li><p>We then compute housing supply for each housing type</p></li>
<li><p>From there, we obtain population in all locations for all housing types.</p></li>
</ul>
<p>We update initial utility levels depending on the gap between the target and simulated population, and re-iterate the process until we reach a satisfying error level <a class="footnote-reference brackets" href="#f10" id="id21">14</a>, according to the values of the parameters <code class="docutils literal notranslate"><span class="pre">precision</span></code> and <code class="docutils literal notranslate"><span class="pre">max_iter</span></code>. Of course, the closer the initial guess is to the final values, the quicker the algorithm converges. We will see below how each of the intermediate steps is computed.</p>
<p>A last word on the choice of a closed vs. open-city model: within a static framework, it is generally considered that closed-city models are a better representation of short-term outcomes and open-city models of long-term outcomes, as population takes time to adjust through migration. Here, we rely on scenarios from the CoCT (informed by more macro parameters than open-city models usually are) to adjust total population across time periods. Sticking to the closed-city model in those circumstances allows us to make welfare assessments based on utility changes without renouncing to the possibility that migrations occur.</p>
</div>
<div class="section" id="functional-assumptions">
<span id="functional-assumpt"></span><h4>Functional assumptions<a class="headerlink" href="#functional-assumptions" title="Permalink to this heading"></a></h4>
<p>Then, the <code class="docutils literal notranslate"><span class="pre">compute_equilibrium</span></code> function calls on the <code class="docutils literal notranslate"><span class="pre">compute_outputs</span></code> function for each endogenous housing type, which in turn calls on functions defined as part of the <code class="docutils literal notranslate"><span class="pre">functions_solver.py</span></code> module. This module applies formulas derived from the optimization process described in <span id="id22">Pfeiffer <em>et al.</em> [<a class="reference internal" href="bibliography.html#id43" title="B. Pfeiffer, C. Rabe, H. Selod, and V. Viguie. Assessing Urban Policies Using a Simulation Model with Formal and Informal Housing. World Bank Policy Research Working Paper Series, 2019.">2019</a>]</span>.</p>
<p>Let us just rephrase the main assumptions here (refer to the paper for a discussion on those <a class="footnote-reference brackets" href="#fcd" id="id23">15</a>). The parameters highlighted in green are specific to a model with agents that perfectly anticipate flood risks.</p>
<p>On the one hand, households maximize Stone-Geary preferences:</p>
<div class="math notranslate nohighlight">
\[U(z,q,x,h) = z^\alpha (q-q_0)^{1-\alpha}A(x)B^h(x)\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(z\)</span> is the quantity of composite good consumed (in monetary terms) and <span class="math notranslate nohighlight">\(q\)</span> is the quantity of housing consumed (in m²). They are the choice variables <a class="footnote-reference brackets" href="#fchoice" id="id24">16</a>.</p></li>
<li><p><span class="math notranslate nohighlight">\(x\)</span> is the location where the household lives and <span class="math notranslate nohighlight">\(h\)</span> is the housing type considered. They are the state variables.</p></li>
<li><p><span class="math notranslate nohighlight">\(\alpha\)</span> is the composite good elasticity (<code class="docutils literal notranslate"><span class="pre">alpha</span></code> parameter), <span class="math notranslate nohighlight">\(1 - \alpha\)</span> is the surplus housing elasticity, and <span class="math notranslate nohighlight">\(q_0\)</span> (<code class="docutils literal notranslate"><span class="pre">q0</span></code> parameter) is the basic need in housing.</p></li>
<li><p><span class="math notranslate nohighlight">\(A(x)\)</span> is a (centered around one) location-specific amenity index (<code class="docutils literal notranslate"><span class="pre">precalculated_amenities</span></code> parameter) and <span class="math notranslate nohighlight">\(B^h(x)\)</span> is a (positive) location-specific disamenity index equal to one in formal sectors and smaller than one in informal sectors (<code class="docutils literal notranslate"><span class="pre">pockets</span></code> and <code class="docutils literal notranslate"><span class="pre">backyard_pockets</span></code> parameters), to account for the negative externalities associated with living in such housing (such as eviction probability, etc.) <a class="footnote-reference brackets" href="#fb" id="id25">17</a>. They are (calibrated) parameters.</p></li>
</ul>
<p>They are facing the following budget constraint (optimization under constraint):</p>
<div class="math notranslate nohighlight">
\[\tilde{y}_i(x) + \mathbb{1}_{h=FS} \mu(x)YR_{IB}(x) = (1 + \textcolor{green}{\gamma \rho_{h}^{contents}(x)})z + q_{h}R_{h}(x) + \mathbb{1}_{h \neq FP} (\rho + \textcolor{green}{\rho_{h}^{struct}(x)} + \mathbb{1}_{h \neq FS} \delta)v_{h}\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\tilde{y}_i(x)\)</span> is the expected income net of commuting costs for a household of income group <span class="math notranslate nohighlight">\(i\)</span> living in location <span class="math notranslate nohighlight">\(x\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbb{1}_{h=FS}\)</span> is an indicator variable for living in the formal subsidized housing sector. Indeed, such households have the possibility to rent out an endogenous fraction <span class="math notranslate nohighlight">\(\mu(x)\)</span> of their backyard of fixed size <span class="math notranslate nohighlight">\(Y\)</span> (<code class="docutils literal notranslate"><span class="pre">backyard_size</span></code> parameter) at the endogenous market rent <span class="math notranslate nohighlight">\(R_{IB}(x)\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\textcolor{green}{\gamma}\)</span> is the fraction of composite good exposed to floods (<code class="docutils literal notranslate"><span class="pre">fraction_z_dwellings</span></code> parameter) and <span class="math notranslate nohighlight">\(\textcolor{green}{\rho_{h}^{contents}(x)}\)</span> is the fraction of contents capital destroyed (that is location and housing-type specific): households need to pay for damages to their belongings.</p></li>
<li><p><span class="math notranslate nohighlight">\(q_{h}\)</span> is the (housing-type specific) amount of housing consumed, at the endogenous annual rent <span class="math notranslate nohighlight">\(R_{h}(x)\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbb{1}_{h \neq FP}\)</span> is an indicator variable for living in a sector different from the formal private one. Indeed, such households (assimilated to owner-occupiers, more on that below) need to pay for the maintenance of their housing of capital value <span class="math notranslate nohighlight">\(v_{h}\)</span> (<code class="docutils literal notranslate"><span class="pre">subsidized_structure_value</span></code> and <code class="docutils literal notranslate"><span class="pre">informal_structure_value</span></code> parameters) that depreciate at rate <span class="math notranslate nohighlight">\(\rho + \textcolor{green}{\rho_{h}^{struct}(x)}\)</span> (<code class="docutils literal notranslate"><span class="pre">depreciation_rate</span></code> parameter + <code class="docutils literal notranslate"><span class="pre">fraction_capital_destroyed</span></code> matrix).</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbb{1}_{h \neq FS}\)</span> is an indicator variable for living in a sector different from the formal subidized one. Indeed, among the set of households described above, those who live in the informal sector (either backyards or settlements) also need to pay for the construction of their “shack” of capital value <span class="math notranslate nohighlight">\(v_{h}\)</span> <a class="footnote-reference brackets" href="#fsdev" id="id26">18</a>. To do so, they pay a fraction of capital value <span class="math notranslate nohighlight">\(\delta\)</span> (<code class="docutils literal notranslate"><span class="pre">interest_rate</span></code> variable) of this price each year, which corresponds to the interest paid on an infinite debt (which is a good-enough approximation in a static setting).</p></li>
</ul>
<p>On the other hand, formal private developers have a Cobb-Douglas housing production function expressed as:</p>
<div class="math notranslate nohighlight">
\[s_{FP}(k) = \kappa k^{1-a}\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(s_{FP}\)</span> is the housing supply per unit of available land (in m² per km²).</p></li>
<li><p><span class="math notranslate nohighlight">\(\kappa\)</span> is a (calibrated) scale factor (<code class="docutils literal notranslate"><span class="pre">coeff_A</span></code> parameter).</p></li>
<li><p><span class="math notranslate nohighlight">\(k = \frac{K}{L_{FP}}\)</span> is the (endogenous) amount of capital per unit of available land (in monetary terms).</p></li>
<li><p><span class="math notranslate nohighlight">\(a\)</span> is the (calibrated) land elasticity of housing production (<code class="docutils literal notranslate"><span class="pre">coeff_a</span></code> parameter).</p></li>
</ul>
<p>They therefore maximize a profit function (per unit of available land) defined as:</p>
<div class="math notranslate nohighlight">
\[\Pi(x,k) = R_{FP}(x)s_{FP}(k) - (\rho + \textcolor{green}{\rho_{FP}^{struct}(x)} + \delta)k - \delta P(x)\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(R^{FP}(x)\)</span> is the (endogenous) market rent for formal private housing.</p></li>
<li><p><span class="math notranslate nohighlight">\(P(x)\)</span> is the (endogenous) price of land.</p></li>
<li><p><span class="math notranslate nohighlight">\(k\)</span> is the choice variable and <span class="math notranslate nohighlight">\(x\)</span> is the state variable.</p></li>
</ul>
<p>Underlying those functional forms are structural assumptions about the maximization objective of agents on the supply and demand sides of each housing submarket:</p>
<ul class="simple">
<li><p>In the formal private sector, developers buy land from absentee landlords and buy capital to build housing on this land <a class="footnote-reference brackets" href="#fabsentee" id="id27">19</a>. They then rent out the housing at the equilibrium rent over an infinite horizon <a class="footnote-reference brackets" href="#fconstant" id="id28">20</a>. They therefore internalize the costs associated with capital depreciation (both general and from structural flood damages) and interest rate (at which future flows of money are discounted). Households just have to pay for damages done to the content of their home <a class="footnote-reference brackets" href="#fequiv" id="id29">21</a>.</p></li>
<li><p>In the formal subsidized sector, (poor) households rent / buy housing for free from the State (owner-occupiers). They only pay for overall capital depreciation (general and from structural and content damages), and may rent out a fraction of their backyard.</p></li>
<li><p>In the informal backyard sector, households rent a fraction of backyard (not directly housing) owned by formal subsidized housing residents and are responsible for building their own “shack” (owner-occupiers). Then, they pay for overall capital depreciation (general and from structural and content damages) and interest over construction costs too.</p></li>
<li><p>In the informal settlement sector, households rent land from absentee landlords (not directly housing) and are responsible for building their own “shack” (owner-occupiers). Then, they pay for overall capital depreciation (general and from structural and content damages) and interest over construction costs too.</p></li>
</ul>
<p>Note that both optimization programmes are concave, hence they can be maximized using first-order optimality conditions (setting the partial derivatives to zero), as detailed in <span id="id30">Pfeiffer <em>et al.</em> [<a class="reference internal" href="bibliography.html#id43" title="B. Pfeiffer, C. Rabe, H. Selod, and V. Viguie. Assessing Urban Policies Using a Simulation Model with Formal and Informal Housing. World Bank Policy Research Working Paper Series, 2019.">2019</a>]</span>.</p>
</div>
<div class="section" id="equilibrium-dwelling-size">
<h4>Equilibrium dwelling size<a class="headerlink" href="#equilibrium-dwelling-size" title="Permalink to this heading"></a></h4>
<p>As announced in the <a class="reference internal" href="#solving-desc"><span class="std std-ref">Solving for equilibrium</span></a> subsection, the <code class="docutils literal notranslate"><span class="pre">compute_outputs</span></code> function starts by computing housing demand / dwelling size (in m²) for each housing type through the <code class="docutils literal notranslate"><span class="pre">compute_dwelling_size_formal</span></code> function. Optimization over the households’ programme described above implicitly defines this quantity in the formal private sector:</p>
<div class="math notranslate nohighlight">
\[u = (\frac{\alpha \tilde{y}_i(x)}{1 + \textcolor{green}{\gamma \rho_{FP}^{contents}(x)}})^\alpha \frac{Q^*-q_0}{(Q^* - \alpha q_0)^\alpha} A(x)\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(u\)</span> is the fixed utility level</p></li>
<li><p><span class="math notranslate nohighlight">\(Q*\)</span> is the equilibrium dwelling size</p></li>
</ul>
<p>By reorganizing the above equation, we obtain the following left and right sides in the code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">58</span>    <span class="n">left_side</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">59</span>        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">utility</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">amenities</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>
<span class="linenos">60</span>        <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;fraction_z_dwellings&quot;</span><span class="p">]</span>
<span class="linenos">61</span>                 <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fraction_capital_destroyed</span><span class="o">.</span><span class="n">contents_formal</span><span class="p">)[</span>
<span class="linenos">62</span>                     <span class="kc">None</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">**</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]))</span>
<span class="linenos">63</span>        <span class="o">/</span> <span class="p">((</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">income_temp</span><span class="p">)</span> <span class="o">**</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">])</span>
<span class="linenos">64</span>        <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">123</span>    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">124</span>        <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">q_0</span><span class="p">)</span>
<span class="linenos">125</span>        <span class="o">/</span> <span class="p">((</span><span class="n">q</span> <span class="o">-</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">q_0</span><span class="p">))</span> <span class="o">**</span> <span class="n">alpha</span><span class="p">)</span>
<span class="linenos">126</span>        <span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">compute_dwelling_size_formal</span></code> function then recovers the value of <span class="math notranslate nohighlight">\(Q*\)</span> (depending on income group) through a linear interpolation, before constraining it to be larger than the parametrized minimum dwelling size in this sector (<code class="docutils literal notranslate"><span class="pre">mini_lot_size</span></code> parameter):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">81</span>    <span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">explicit_qfunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;q0&quot;</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]),</span> <span class="n">x</span><span class="p">)</span>
<span class="linenos">82</span>
<span class="linenos">83</span>    <span class="c1"># We define dwelling size as the image corresponding to observed values</span>
<span class="linenos">84</span>    <span class="c1"># from left_side, for each selected pixel and each income group</span>
<span class="linenos">85</span>    <span class="n">dwelling_size</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">left_side</span><span class="p">)</span>
<span class="linenos">86</span>
<span class="linenos">87</span>    <span class="c1"># We cap dwelling size to 10**12 (to avoid numerical difficulties with</span>
<span class="linenos">88</span>    <span class="c1"># infinite numbers)</span>
<span class="linenos">89</span>    <span class="n">dwelling_size</span><span class="p">[</span><span class="n">dwelling_size</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>Back to the <code class="docutils literal notranslate"><span class="pre">compute_outputs</span></code> function, the dwelling size in informal backyards and informal settlements is exogenously set as being the standard parametrized size of a “shack” (<code class="docutils literal notranslate"><span class="pre">shack_size</span></code> parameter).</p>
</div>
<div class="section" id="equilibrium-rent">
<h4>Equilibrium rent<a class="headerlink" href="#equilibrium-rent" title="Permalink to this heading"></a></h4>
<p>Plugging this back into the first-order optimality condition for formal private households, and just inverting the households’ programme for informal backyards and settlements, we obtain the following bid rents in each sector, depending on income group:</p>
<div class="math notranslate nohighlight">
\[\Psi_i^{FP}(x,u) = \frac{(1-\alpha)\tilde{y}_i(x)}{Q_{FP}(x,i,u) - \alpha q_0}\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(Q_{FP}(x,i,u) = max(q_{min},Q^*)\)</span></p></li>
</ul>
<div class="math notranslate nohighlight">
\[\Psi_i^{IB}(x,u) = \frac{1}{q_I}[\tilde{y}_i(x) - (\rho + \delta + \textcolor{green}{\rho_{IB}^{struct}})v_I - (1 + \textcolor{green}{\gamma \rho_{IB}^{contents}})(\frac{u}{(q_I-q_0)^{1-\alpha}A(x)B_{IB}(x)})^\frac{1}{\alpha}]\]</div>
<div class="math notranslate nohighlight">
\[\Psi_i^{IS}(x,u) = \frac{1}{q_I}[\tilde{y}_i(x) - (\rho + \delta + \textcolor{green}{\rho_{IS}^{struct}})v_I - (1 + \textcolor{green}{\gamma \rho_{IS}^{contents}})(\frac{u}{(q_I-q_0)^{1-\alpha}A(x)B_{IS}(x)})^\frac{1}{\alpha}]\]</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">compute_outputs</span></code> function, this corresponds to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">155</span>        <span class="n">R_mat</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">income_net_of_commuting_costs</span><span class="p">)</span>
<span class="linenos">156</span>                 <span class="o">/</span> <span class="p">(</span><span class="n">dwelling_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;q0&quot;</span><span class="p">])))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">185</span>            <span class="n">R_mat</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">186</span>                <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;shack_size&quot;</span><span class="p">])</span>
<span class="linenos">187</span>                <span class="o">*</span> <span class="p">(</span><span class="n">income_net_of_commuting_costs</span>
<span class="linenos">188</span>                    <span class="o">-</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<span class="linenos">189</span>                        <span class="n">fraction_capital_destroyed</span><span class="o">.</span><span class="n">contents_backyard</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">190</span>                        <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;fraction_z_dwellings&quot;</span><span class="p">])</span>
<span class="linenos">191</span>                        <span class="o">*</span> <span class="p">((</span><span class="n">utility</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
<span class="linenos">192</span>                            <span class="o">/</span> <span class="p">(</span><span class="n">amenities</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">193</span>                               <span class="o">*</span> <span class="n">param_backyards_pockets</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">194</span>                               <span class="o">*</span> <span class="p">((</span><span class="n">dwelling_size</span> <span class="o">-</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;q0&quot;</span><span class="p">])</span>
<span class="linenos">195</span>                                  <span class="o">**</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">])))</span>
<span class="linenos">196</span>                           <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">])))</span>
<span class="linenos">197</span>                    <span class="o">-</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;informal_structure_value&quot;</span><span class="p">]</span>
<span class="linenos">198</span>                       <span class="o">*</span> <span class="p">(</span><span class="n">interest_rate</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;depreciation_rate&quot;</span><span class="p">]))</span>
<span class="linenos">199</span>                    <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<span class="linenos">200</span>                        <span class="n">fraction_capital_destroyed</span><span class="o">.</span><span class="n">structure_informal_backyards</span>
<span class="linenos">201</span>                        <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;informal_structure_value&quot;</span><span class="p">]))</span>
<span class="linenos">202</span>                <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">210</span>        <span class="n">R_mat</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">211</span>            <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;shack_size&quot;</span><span class="p">])</span>
<span class="linenos">212</span>            <span class="o">*</span> <span class="p">(</span><span class="n">income_net_of_commuting_costs</span>
<span class="linenos">213</span>                <span class="o">-</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fraction_capital_destroyed</span><span class="o">.</span><span class="n">contents_informal</span><span class="p">)[</span>
<span class="linenos">214</span>                    <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;fraction_z_dwellings&quot;</span><span class="p">])</span>
<span class="linenos">215</span>                    <span class="o">*</span> <span class="p">((</span><span class="n">utility</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">amenities</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">216</span>                                            <span class="o">*</span> <span class="n">param_pockets</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">217</span>                                            <span class="o">*</span> <span class="p">((</span><span class="n">dwelling_size</span> <span class="o">-</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;q0&quot;</span><span class="p">])</span>
<span class="linenos">218</span>                                               <span class="o">**</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">])))</span>
<span class="linenos">219</span>                       <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">])))</span>
<span class="linenos">220</span>                <span class="o">-</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;informal_structure_value&quot;</span><span class="p">]</span>
<span class="linenos">221</span>                   <span class="o">*</span> <span class="p">(</span><span class="n">interest_rate</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;depreciation_rate&quot;</span><span class="p">]))</span>
<span class="linenos">222</span>                <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<span class="linenos">223</span>                    <span class="n">fraction_capital_destroyed</span><span class="o">.</span><span class="n">structure_informal_settlements</span>
<span class="linenos">224</span>                    <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;informal_structure_value&quot;</span><span class="p">]))</span>
<span class="linenos">225</span>            <span class="p">)</span>
</pre></div>
</div>
<p>Bid rents <span class="math notranslate nohighlight">\(\Psi^i_h(x,u)\)</span> correspond to the maximum amount households of type <span class="math notranslate nohighlight">\(i\)</span> are willing to pay for a unit (1 m²) of housing of type <span class="math notranslate nohighlight">\(h\)</span> in a certain location <span class="math notranslate nohighlight">\(x\)</span> for a given utility level <span class="math notranslate nohighlight">\(u\)</span> (over one year). Assuming that households bid their true valuation and that there are no strategic interactions, housing / land <a class="footnote-reference brackets" href="#fhland" id="id31">22</a> is allocated to the highest bidder. This is why we retain the bid rents from the highest bidding income groups, and the associated dwelling sizes, as the equilibrium output values for rents and dwelling sizes. In the code, this corresponds to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">233</span>    <span class="c1"># We select highest bidder (income group) in each location</span>
<span class="linenos">234</span>    <span class="n">proba</span> <span class="o">=</span> <span class="p">(</span><span class="n">R_mat</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">R_mat</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="linenos">235</span>    <span class="c1"># We correct the matrix if binding budget constraint</span>
<span class="linenos">236</span>    <span class="c1"># (and other precautions)</span>
<span class="linenos">237</span>    <span class="n">limit</span> <span class="o">=</span> <span class="p">((</span><span class="n">income_net_of_commuting_costs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">238</span>             <span class="o">&amp;</span> <span class="p">(</span><span class="n">proba</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">239</span>             <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">income_net_of_commuting_costs</span><span class="p">))</span>
<span class="linenos">240</span>             <span class="o">&amp;</span> <span class="p">(</span><span class="n">R_mat</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
<span class="linenos">241</span>    <span class="n">proba</span> <span class="o">=</span> <span class="n">proba</span> <span class="o">*</span> <span class="n">limit</span>
<span class="linenos">242</span>
<span class="linenos">243</span>    <span class="c1"># Yields directly the selected income group for each location</span>
<span class="linenos">244</span>    <span class="n">which_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">R_mat</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">245</span>
<span class="linenos">246</span>    <span class="c1"># Then we recover rent and dwelling size associated with the selected</span>
<span class="linenos">247</span>    <span class="c1"># income group in each location</span>
<span class="linenos">248</span>    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">which_group</span><span class="p">))</span>
<span class="linenos">249</span>    <span class="n">R</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="linenos">250</span>    <span class="n">dwelling_size_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">which_group</span><span class="p">))</span>
<span class="linenos">251</span>    <span class="n">dwelling_size_temp</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="linenos">252</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">which_group</span><span class="p">)):</span>
<span class="linenos">253</span>        <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">R_mat</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">which_group</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">i</span><span class="p">]</span>
<span class="linenos">254</span>        <span class="n">dwelling_size_temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dwelling_size</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">which_group</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">i</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="equilibrium-housing-supply">
<span id="equil-hsupply"></span><h4>Equilibrium housing supply<a class="headerlink" href="#equilibrium-housing-supply" title="Permalink to this heading"></a></h4>
<p>Then, the <code class="docutils literal notranslate"><span class="pre">compute_outputs</span></code> function goes on calling the <code class="docutils literal notranslate"><span class="pre">compute_housing_supply_formal</span></code> and <code class="docutils literal notranslate"><span class="pre">compute_housing_supply_backyard</span></code> functions.</p>
<p>In the formal private sector, profit maximization of developers with respect to capital yields:</p>
<div class="math notranslate nohighlight">
\[s_{FP}(x) = \kappa^{\frac{1}{a}} (\frac{(1-a)R_{FP}(x)}{\rho + \textcolor{green}{\rho_{FP}^{struct}(x)} + \delta})^{\frac{1-a}{a}}\]</div>
<p>In the code, this corresponds to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">200</span>        <span class="c1"># NB: we convert values to supply in m² per km² of available land</span>
<span class="linenos">201</span>        <span class="n">housing_supply</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">202</span>            <span class="mi">1000000</span>
<span class="linenos">203</span>            <span class="o">*</span> <span class="p">(</span><span class="n">construction_param</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_a&quot;</span><span class="p">]))</span>
<span class="linenos">204</span>            <span class="o">*</span> <span class="p">((</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_b&quot;</span><span class="p">]</span>
<span class="linenos">205</span>                <span class="o">/</span> <span class="p">(</span><span class="n">interest_rate</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;depreciation_rate&quot;</span><span class="p">]</span>
<span class="linenos">206</span>                   <span class="o">+</span> <span class="n">capital_destroyed</span><span class="p">))</span>
<span class="linenos">207</span>               <span class="o">**</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_b&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_a&quot;</span><span class="p">]))</span>
<span class="linenos">208</span>            <span class="o">*</span> <span class="p">((</span><span class="n">R</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_b&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_a&quot;</span><span class="p">]))</span>
<span class="linenos">209</span>            <span class="p">)</span>
</pre></div>
</div>
<p>In the informal backyard sector, utility maximization of households living in formal subsidized housing with respect to fraction of backyard rented out yields:</p>
<div class="math notranslate nohighlight">
\[\mu(x) = \alpha \frac{q_{FS}-q_0}{Y} - (1-\alpha) \frac{\tilde{y}_1(x) - (\rho + \textcolor{green}{\rho_{FS}^{struct}(x)}) \textcolor{green}{h_{FS}}}{YR_{IB}(x)}\]</div>
<p>In the code, this corresponds to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">288</span>    <span class="n">housing_supply</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">289</span>        <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">*</span>
<span class="linenos">290</span>         <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;RDP_size&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_size&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;q0&quot;</span><span class="p">])</span>
<span class="linenos">291</span>         <span class="o">/</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_size&quot;</span><span class="p">]))</span>
<span class="linenos">292</span>        <span class="o">-</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>
<span class="linenos">293</span>           <span class="o">*</span> <span class="p">(</span><span class="n">income_net_of_commuting_costs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">294</span>              <span class="o">-</span> <span class="p">(</span><span class="n">capital_destroyed</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;subsidized_structure_value&quot;</span><span class="p">]))</span>
<span class="linenos">295</span>           <span class="o">/</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_size&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">R</span><span class="p">))</span>
<span class="linenos">296</span>    <span class="p">)</span>
</pre></div>
</div>
<p>Back to the <code class="docutils literal notranslate"><span class="pre">compute_outputs</span></code> function, the housing supply per unit of available land for informal settlements is just set as 1 km²/km². Indeed, as absentee landlords do not have outside use for their land, they face no opportunity cost when renting it out, and therefore rent out all of it. We also remind the reader that the informal backyard and settlement dwellings are not capital-intensive, to the extent that they have a fixed size and cover only one floor. The housing supply is therefore equal to the land supply. Again, this is a simplification, but we believe that this is a good enough approximation of reality.</p>
</div>
<div class="section" id="equilibrium-number-of-households">
<h4>Equilibrium number of households<a class="headerlink" href="#equilibrium-number-of-households" title="Permalink to this heading"></a></h4>
<p>At the end of the <code class="docutils literal notranslate"><span class="pre">compute_outputs</span></code> function, we just divide the housing supply per unit of available land by the dwelling size, and multiply it by the amount of available land to obtain the number of households by housing type in each grid cell. Then, we associate people in each selected pixel to the highest bidding income group (here denoted <span class="math notranslate nohighlight">\(i\)</span>):</p>
<div class="math notranslate nohighlight">
\[N_i^h(x) = \frac{s_h(x)L_h(x)}{Q_h(x,i,u)}\]</div>
<p>From there, we are able to recover the total number of households in each income group for a given housing type:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">280</span>    <span class="c1"># Yields population density in each selected pixel</span>
<span class="linenos">281</span>    <span class="n">people_init</span> <span class="o">=</span> <span class="n">housing_supply</span> <span class="o">/</span> <span class="n">dwelling_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">282</span>    <span class="n">people_init</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">people_init</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">283</span>    <span class="c1"># Yields number of people per pixel, as 0.25 is the area of a pixel</span>
<span class="linenos">284</span>    <span class="c1"># (0.5*0.5 km) and coeff_land reduces it to inhabitable area</span>
<span class="linenos">285</span>    <span class="n">people_init_land</span> <span class="o">=</span> <span class="n">people_init</span> <span class="o">*</span> <span class="n">coeff_land</span> <span class="o">*</span> <span class="mf">0.25</span>
<span class="linenos">286</span>
<span class="linenos">287</span>    <span class="c1"># We associate people in each selected pixel to the highest bidding income</span>
<span class="linenos">288</span>    <span class="c1"># group</span>
<span class="linenos">289</span>    <span class="n">people_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">people_init_land</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">proba</span>
<span class="linenos">290</span>    <span class="n">people_center</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">people_center</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">291</span>    <span class="c1"># Then we sum across pixels and get the number of people in each income</span>
<span class="linenos">292</span>    <span class="c1"># group for given housing type</span>
<span class="linenos">293</span>    <span class="n">job_simul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">people_center</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Also note that we ensure that the housing rent in the formal private sector is larger than the agricultural rent:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">297</span>    <span class="k">if</span> <span class="n">housing_type</span> <span class="o">==</span> <span class="s1">&#39;formal&#39;</span><span class="p">:</span>
<span class="linenos">298</span>        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">agricultural_rent</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="iteration-and-results">
<h4>Iteration and results<a class="headerlink" href="#iteration-and-results" title="Permalink to this heading"></a></h4>
<p>Back to the body of the <code class="docutils literal notranslate"><span class="pre">compute_equilibrium</span></code> function, we sum the outputs of the <code class="docutils literal notranslate"><span class="pre">compute_outputs</span></code> function across grid cells to get the total number of households in each income group. Then, we define an error metric <code class="docutils literal notranslate"><span class="pre">error_max_abs</span></code> comparing this result with values from the data, and an incremental term <code class="docutils literal notranslate"><span class="pre">diff_utility</span></code> (depending on a predetermined convergence factor):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">273</span>    <span class="c1">#  We first update the first iteration of output vector with the sum of</span>
<span class="linenos">274</span>    <span class="c1">#  simulated people per income group across housing types (no RDP)</span>
<span class="linenos">275</span>    <span class="n">total_simulated_jobs</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<span class="linenos">276</span>        <span class="n">simulated_jobs</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">277</span>
<span class="linenos">278</span>    <span class="c1">#  diff_utility will be used to adjust the utility levels</span>
<span class="linenos">279</span>    <span class="c1">#  Note that optimization is made to stick to households_per_income_class,</span>
<span class="linenos">280</span>    <span class="c1">#  which does not include people living in RDP (as we take this as</span>
<span class="linenos">281</span>    <span class="c1">#  exogenous)</span>
<span class="linenos">282</span>
<span class="linenos">283</span>    <span class="c1">#  We compare total population for each income group obtained from</span>
<span class="linenos">284</span>    <span class="c1">#  equilibrium condition (total_simulated_jobs) with target population</span>
<span class="linenos">285</span>    <span class="c1">#  allocation (households_per_income_class)</span>
<span class="linenos">286</span>
<span class="linenos">287</span>    <span class="c1">#  We arbitrarily set a strictly positive minimum utility level at 10</span>
<span class="linenos">288</span>    <span class="c1">#  (as utility will be adjusted multiplicatively, we do not want to break</span>
<span class="linenos">289</span>    <span class="c1">#  the model with zero terms)</span>
<span class="linenos">290</span>
<span class="linenos">291</span>    <span class="n">diff_utility</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
<span class="linenos">292</span>        <span class="p">(</span><span class="n">total_simulated_jobs</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
<span class="linenos">293</span>        <span class="o">/</span> <span class="p">(</span><span class="n">households_per_income_class</span> <span class="o">+</span> <span class="mi">10</span><span class="p">))</span>
<span class="linenos">294</span>    <span class="n">diff_utility</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">295</span>        <span class="n">diff_utility</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;convergence_factor&quot;</span><span class="p">])</span>
<span class="linenos">296</span>    <span class="p">(</span><span class="n">diff_utility</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">,</span> <span class="n">diff_utility</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="linenos">297</span>     <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff_utility</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">,</span> <span class="n">diff_utility</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="linenos">298</span>          <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="linenos">299</span>
<span class="linenos">300</span>    <span class="c1"># Difference with reality</span>
<span class="linenos">301</span>    <span class="n">error</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_simulated_jobs</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">302</span>                                 <span class="o">/</span> <span class="n">households_per_income_class</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="linenos">303</span>    <span class="c1">#  This is the parameter of interest for optimization</span>
<span class="linenos">304</span>    <span class="n">error_max_abs</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span>
<span class="linenos">305</span>        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">total_simulated_jobs</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">306</span>               <span class="o">/</span> <span class="n">households_per_income_class</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>As long as the error metric is above a predetermined precision level (<code class="docutils literal notranslate"><span class="pre">precision</span></code>), and the number of iterations is below a predetermined threshold (<code class="docutils literal notranslate"><span class="pre">max_iter</span></code>), we repeat the process described above after updating the utility levels with the incremental term:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">326</span>            <span class="c1"># When population is overestimated, we augment utility to reduce</span>
<span class="linenos">327</span>            <span class="c1"># population (cf. population constraint from standard model)</span>
<span class="linenos">328</span>            <span class="n">utility</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
<span class="linenos">329</span>                <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">utility</span><span class="p">[</span><span class="n">index_iteration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
<span class="linenos">330</span>                <span class="o">+</span> <span class="n">diff_utility</span><span class="p">[</span><span class="n">index_iteration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
</pre></div>
</div>
<p>Note that we also update the convergence factor to help the algorithm converge.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">338</span>            <span class="c1"># NB: we assume the minimum error is 100 not to break model with</span>
<span class="linenos">339</span>            <span class="c1"># zeros</span>
<span class="linenos">340</span>            <span class="n">convergence_factor</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">341</span>                <span class="n">param</span><span class="p">[</span><span class="s2">&quot;convergence_factor&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
<span class="linenos">342</span>                    <span class="mi">1</span>
<span class="linenos">343</span>                    <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
<span class="linenos">344</span>                        <span class="p">(</span><span class="n">total_simulated_jobs</span><span class="p">[</span><span class="n">index_iteration</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<span class="linenos">345</span>                        <span class="o">/</span> <span class="p">(</span><span class="n">households_per_income_class</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<span class="linenos">346</span>                        <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">347</span>                    <span class="p">)</span>
<span class="linenos">348</span>                <span class="p">)</span>
<span class="linenos">349</span>
<span class="linenos">350</span>            <span class="c1"># We also reduce it as time passes, as errors should become smaller</span>
<span class="linenos">351</span>            <span class="c1"># and smaller</span>
<span class="linenos">352</span>            <span class="n">convergence_factor</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">353</span>                <span class="n">convergence_factor</span>
<span class="linenos">354</span>                <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">index_iteration</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;max_iter&quot;</span><span class="p">])</span>
<span class="linenos">355</span>                <span class="p">)</span>
</pre></div>
</div>
<p>To complete the process, we concatenate (exogenous) values for formal subsidized housing to our final output vectors while taking care that all values have the same units:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">450</span>    <span class="c1">#  We correct output coming from data_RDP with more reliable estimations</span>
<span class="linenos">451</span>    <span class="c1">#  from SAL data (to include council housing)</span>
<span class="linenos">452</span>    <span class="n">households_RDP</span> <span class="o">=</span> <span class="p">(</span><span class="n">number_properties_RDP</span> <span class="o">*</span> <span class="n">total_RDP</span>
<span class="linenos">453</span>                      <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">number_properties_RDP</span><span class="p">))</span>
<span class="linenos">454</span>    <span class="c1">#  Share of housing (no backyard) in RDP surface (with land in km²)</span>
<span class="linenos">455</span>    <span class="n">construction_RDP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matlib</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span>
<span class="linenos">456</span>        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;RDP_size&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;RDP_size&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_size&quot;</span><span class="p">]),</span>
<span class="linenos">457</span>        <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_temp</span><span class="o">.</span><span class="n">dist</span><span class="p">))</span>
<span class="linenos">458</span>    <span class="c1">#  RDP dwelling size (in m²)</span>
<span class="linenos">459</span>    <span class="n">dwelling_size_RDP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matlib</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span>
<span class="linenos">460</span>        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;RDP_size&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_temp</span><span class="o">.</span><span class="n">dist</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">494</span>    <span class="c1"># NB: we multiply by construction_RDP because we want the housing supply</span>
<span class="linenos">495</span>    <span class="c1"># per unit of AVAILABLE land: RDP building is only a fraction of overall</span>
<span class="linenos">496</span>    <span class="c1"># surface (also accounts for backyarding)</span>
<span class="linenos">497</span>    <span class="n">housing_supply_RDP</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">498</span>        <span class="n">construction_RDP</span> <span class="o">*</span> <span class="n">dwelling_size_RDP</span> <span class="o">*</span> <span class="n">households_RDP</span>
<span class="linenos">499</span>        <span class="o">/</span> <span class="p">(</span><span class="n">coeff_land_full</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">)</span>
<span class="linenos">500</span>        <span class="p">)</span>
<span class="linenos">501</span>    <span class="n">housing_supply_RDP</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">housing_supply_RDP</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">502</span>    <span class="n">dwelling_size_RDP</span> <span class="o">=</span> <span class="n">dwelling_size_RDP</span> <span class="o">*</span> <span class="p">(</span><span class="n">coeff_land_full</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">503</span>    <span class="n">initial_state_dwelling_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
<span class="linenos">504</span>        <span class="p">[</span><span class="n">dwelling_size_export</span><span class="p">,</span> <span class="n">dwelling_size_RDP</span><span class="p">])</span>
<span class="linenos">505</span>    <span class="c1"># Note that RDP housing supply per unit of available land has nothing to do</span>
<span class="linenos">506</span>    <span class="c1"># with backyard housing supply per unit of available land</span>
<span class="linenos">507</span>    <span class="n">initial_state_housing_supply</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
<span class="linenos">508</span>        <span class="p">[</span><span class="n">housing_supply_export</span><span class="p">,</span> <span class="n">housing_supply_RDP</span><span class="p">]</span>
<span class="linenos">509</span>        <span class="p">)</span>
</pre></div>
</div>
<p>We also return other outputs from the model, such as utility levels, the final error, or capital per unit of available land.</p>
</div>
</div>
<div class="section" id="subsequent-periods">
<span id="id32"></span><h3>Subsequent periods<a class="headerlink" href="#subsequent-periods" title="Permalink to this heading"></a></h3>
<p>Back to the body of the <code class="docutils literal notranslate"><span class="pre">main_nb</span></code> script, we save the outputs for the initial state equilibrium in a dedicated subfolder (according to the naming convention defined in the preamble). Then, we launch the <code class="docutils literal notranslate"><span class="pre">run_simulation</span></code> function that takes them as an argument, and calls on the same modules as before, plus the <code class="docutils literal notranslate"><span class="pre">functions_dynamic.py</span></code> module.</p>
<p>After initializing a few key variables, the function starts a loop over predefined simulation years. The first part of the loop consists in updating the value of all time-moving variables. This is based on exogenous scenarios previously imported as inputs (through the <code class="docutils literal notranslate"><span class="pre">import_scenarios</span></code> function) and taken as an argument of the function. Provided by the CoCT, they provide trajectories for the following set of variables:</p>
<ul class="simple">
<li><p>Income distribution</p></li>
<li><p>Inflation rate</p></li>
<li><p>Interest rate</p></li>
<li><p>Total population</p></li>
<li><p>Price of fuel</p></li>
<li><p>Land use</p></li>
</ul>
<p>This leads to the update of, among others, number of households per income class, expected income net of commuting costs, capital values of formal subsidized and informal dwelling units:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">230</span>            <span class="p">(</span><span class="n">average_income</span><span class="p">,</span> <span class="n">households_per_income_class</span>
<span class="linenos">231</span>             <span class="p">)</span> <span class="o">=</span> <span class="n">eqdyn</span><span class="o">.</span><span class="n">compute_average_income</span><span class="p">(</span>
<span class="linenos">232</span>                <span class="n">spline_population_income_distribution</span><span class="p">,</span>
<span class="linenos">233</span>                <span class="n">spline_income_distribution</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">year_temp</span><span class="p">)</span>
<span class="linenos">234</span>            <span class="n">income_net_of_commuting_costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
<span class="linenos">235</span>                <span class="n">precalculated_transport</span> <span class="o">+</span> <span class="s2">&quot;GRID_incomeNetOfCommuting_&quot;</span>
<span class="linenos">236</span>                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year_temp</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span><span class="p">)</span>
<span class="linenos">237</span>            <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;subsidized_structure_value&quot;</span><span class="p">]</span>
<span class="linenos">238</span>             <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;subsidized_structure_value_ref&quot;</span><span class="p">]</span>
<span class="linenos">239</span>                  <span class="o">*</span> <span class="p">(</span><span class="n">spline_inflation</span><span class="p">(</span><span class="n">year_temp</span><span class="p">)</span> <span class="o">/</span> <span class="n">spline_inflation</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
<span class="linenos">240</span>            <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;informal_structure_value&quot;</span><span class="p">]</span>
<span class="linenos">241</span>             <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;informal_structure_value_ref&quot;</span><span class="p">]</span>
<span class="linenos">242</span>                  <span class="o">*</span> <span class="p">(</span><span class="n">spline_inflation</span><span class="p">(</span><span class="n">year_temp</span><span class="p">)</span> <span class="o">/</span> <span class="n">spline_inflation</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
<span class="linenos">243</span>            <span class="n">mean_income</span> <span class="o">=</span> <span class="n">spline_income</span><span class="p">(</span><span class="n">year_temp</span><span class="p">)</span>
<span class="linenos">244</span>            <span class="n">interest_rate</span> <span class="o">=</span> <span class="n">eqdyn</span><span class="o">.</span><span class="n">interpolate_interest_rate</span><span class="p">(</span>
<span class="linenos">245</span>                <span class="n">spline_interest_rate</span><span class="p">,</span> <span class="n">year_temp</span><span class="p">)</span>
<span class="linenos">246</span>            <span class="n">population</span> <span class="o">=</span> <span class="n">spline_population</span><span class="p">(</span><span class="n">year_temp</span><span class="p">)</span>
<span class="linenos">247</span>            <span class="n">total_RDP</span> <span class="o">=</span> <span class="n">spline_RDP</span><span class="p">(</span><span class="n">year_temp</span><span class="p">)</span>
<span class="linenos">248</span>            <span class="n">minimum_housing_supply</span> <span class="o">=</span> <span class="n">spline_minimum_housing_supply</span><span class="p">(</span><span class="n">year_temp</span><span class="p">)</span>
<span class="linenos">249</span>            <span class="n">number_properties_RDP</span> <span class="o">=</span> <span class="n">spline_estimate_RDP</span><span class="p">(</span><span class="n">year_temp</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that we also update the scale factor of the Cobb-Douglas housing production function so as to neutralize the impact that inflation of incomes would have on housing supply through rents <a class="footnote-reference brackets" href="#fmoney-illus" id="id33">23</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">254</span>            <span class="n">construction_param</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">255</span>                <span class="p">(</span><span class="n">mean_income</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;income_year_reference&quot;</span><span class="p">])</span>
<span class="linenos">256</span>                <span class="o">**</span> <span class="p">(</span><span class="o">-</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_b&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_A&quot;</span><span class="p">]</span>
<span class="linenos">257</span>            <span class="p">)</span>
</pre></div>
</div>
<p>This is because we build a stable equilibrium model with rational agents. In particular, this requires to remove money illusion (i.e., the tendency of households to view their wealth and income in nominal terms, rather than in real terms).</p>
<p>Also note that we are updating land availability coefficents, as they evolve through time, and agricultural rent, which also depends on the interest rate and the updated scale factor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">258</span>            <span class="n">coeff_land</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_coeff_land</span><span class="p">(</span>
<span class="linenos">259</span>                <span class="n">spline_land_constraints</span><span class="p">,</span> <span class="n">spline_land_backyard</span><span class="p">,</span>
<span class="linenos">260</span>                <span class="n">spline_land_informal</span><span class="p">,</span> <span class="n">spline_land_RDP</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">year_temp</span><span class="p">)</span>
<span class="linenos">261</span>            <span class="n">agricultural_rent</span> <span class="o">=</span> <span class="n">inpprm</span><span class="o">.</span><span class="n">compute_agricultural_rent</span><span class="p">(</span>
<span class="linenos">262</span>                <span class="n">spline_agricultural_price</span><span class="p">(</span><span class="n">year_temp</span><span class="p">),</span> <span class="n">construction_param</span><span class="p">,</span>
<span class="linenos">263</span>                <span class="n">interest_rate</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, we proceed in three steps. We first compute a new unconstrained equilibrium with the updated variables. We then compute the targeted difference between the final value of formal private housing supply at <span class="math notranslate nohighlight">\(t+1\)</span> and the one at <span class="math notranslate nohighlight">\(t\)</span>, through the <code class="docutils literal notranslate"><span class="pre">evolution_housing_supply</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">278</span>            <span class="n">deriv_housing_temp</span> <span class="o">=</span> <span class="n">eqdyn</span><span class="o">.</span><span class="n">evolution_housing_supply</span><span class="p">(</span>
<span class="linenos">279</span>                <span class="n">housing_limit</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">years_simulations</span><span class="p">[</span><span class="n">index_iter</span><span class="p">],</span>
<span class="linenos">280</span>                <span class="n">years_simulations</span><span class="p">[</span><span class="n">index_iter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">tmpi_housing_supply</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
<span class="linenos">281</span>                <span class="n">stat_temp_housing_supply</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
</pre></div>
</div>
<p>This law of motion reflects the fact that formal private housing stock depreciates with time and that developers respond to price incentives with delay as in <span id="id34">Viguie and Hallegatte [<a class="reference internal" href="bibliography.html#id44" title="V. Viguie and S. Hallegatte. Trade-offs and Synergies in Urban Climate Policies. Nature Climate Change, 2(5):334-7, 2012.">2012</a>]</span>, hence might differ from the one computed as an unconstrained equilibrium output. Formally, this corresponds to:</p>
<div class="math notranslate nohighlight">
\[s_{FP}(x|t+1) - s_{FP}(x|t)\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}= \begin{cases} \frac{s_{FP}^{eq}(x|t+1) - s_{FP}(x|t)}{\tau} - (\rho + \textcolor{green}{\rho_{FP}^{struct}(x)}) s_{FP}(x|t) &amp; \text{if $s_{FP}(x|t) &lt; s_{FP}^{eq}(x|t+1)$} \\ -(\rho + \textcolor{green}{\rho_{FP}^{struct}(x)}) s_{FP}(x|t) &amp; \text{if $s_{FP}(x|t) \geq s_{FP}^{eq}(x|t+1)$} \end{cases}\end{split}\]</div>
<p>In the body of the <code class="docutils literal notranslate"><span class="pre">evolution_housing_supply</span></code> function, this translates into:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">364</span>        <span class="n">diff_housing</span> <span class="o">=</span> <span class="p">((</span><span class="n">housing_supply_1</span> <span class="o">-</span> <span class="n">housing_supply_0</span><span class="p">)</span>
<span class="linenos">365</span>                        <span class="o">*</span> <span class="p">(</span><span class="n">housing_supply_1</span> <span class="o">&gt;</span> <span class="n">housing_supply_0</span><span class="p">)</span>
<span class="linenos">366</span>                        <span class="o">*</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;time_invest_housing&quot;</span><span class="p">]</span>
<span class="linenos">367</span>                        <span class="o">-</span> <span class="n">housing_supply_0</span> <span class="o">*</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
<span class="linenos">368</span>                        <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;depreciation_rate&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>Finally, we compute a new equilibrium under this constraint, which yields our final outputs at <span class="math notranslate nohighlight">\(t+1\)</span>. Concretely, we set the value of housing supply at <span class="math notranslate nohighlight">\(t+1\)</span> as being the sum of the housing supply at <span class="math notranslate nohighlight">\(t\)</span> plus the difference we just computed, and store it under the <code class="docutils literal notranslate"><span class="pre">housing_in</span></code> parameter (whose default value does not matter). In the body of the <code class="docutils literal notranslate"><span class="pre">run_simulations</span></code> function, this looks like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">286</span>            <span class="n">param</span><span class="p">[</span><span class="s2">&quot;housing_in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_temp_housing_supply</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
<span class="linenos">287</span>            <span class="o">+</span> <span class="n">deriv_housing_temp</span>
</pre></div>
</div>
<p>Then, we run the <code class="docutils literal notranslate"><span class="pre">compute_equilibrium</span></code> function with the modified option that developers do not adjust their housing supply anymore (so that <code class="docutils literal notranslate"><span class="pre">housing_supply</span></code> = <code class="docutils literal notranslate"><span class="pre">housing_in</span></code> in the body of the <code class="docutils literal notranslate"><span class="pre">compute_housing_supply_formal</span></code> function). All outputs will then be re-computed to fit this fixed target housing supply.</p>
<p>Back to the body of the <code class="docutils literal notranslate"><span class="pre">main_nb</span></code> script, we save the simulation outputs in a dedicated subfolder, that will be used for output visualization.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="outputs">
<h2>Outputs<a class="headerlink" href="#outputs" title="Permalink to this heading"></a></h2>
<p>Apart from the data visualization in notebooks, all the modules of this package are used as part of the <code class="docutils literal notranslate"><span class="pre">plots</span></code> scripts. The <code class="docutils literal notranslate"><span class="pre">plots_inputs.py</span></code> script plots input data for descriptive statistics. The <code class="docutils literal notranslate"><span class="pre">plots_equil.py</span></code> script plots outputs specific to the initial state equilibrium, notably with respect to result validation. The <code class="docutils literal notranslate"><span class="pre">plots_simul.py</span></code> script plots outputs for all simulation years, and some evolution of variables across time. Only the two latter require to run the <code class="docutils literal notranslate"><span class="pre">main_nb</span></code> script at least once to save the associated numeric outputs. To call on a specific simulation, one just has to change the path name at the beginning of the scripts to call on the dedicated subfolder. All scripts save the associated tables and figures in another subfolder (under the same name for equilibrium and simulation outputs).</p>
<p>Then, <code class="docutils literal notranslate"><span class="pre">plots_use_case_anticip.py</span></code> and <code class="docutils literal notranslate"><span class="pre">plots_use_case_cchange.py</span></code> draw on outputs from <code class="docutils literal notranslate"><span class="pre">plots_equil.py</span></code> to generate plots and tables for specific comparative statics (with and without <code class="docutils literal notranslate"><span class="pre">options[&quot;agents_anticipate_floods&quot;]</span></code> in the first case, with and without <code class="docutils literal notranslate"><span class="pre">options[&quot;climate_change&quot;]</span></code> in the second case). Those outputs are the ones leveraged in the <a class="reference internal" href="use_case_nb.html"><span class="doc">Notebook: use cases</span></a> section (also see corresponding notebooks).</p>
<p>As part of the <code class="docutils literal notranslate"><span class="pre">outputs</span></code> package, the <code class="docutils literal notranslate"><span class="pre">export_outputs.py</span></code> module is for processing and exporting the standard urban variables of the model (already present in <span id="id35">Pfeiffer <em>et al.</em> [<a class="reference internal" href="bibliography.html#id43" title="B. Pfeiffer, C. Rabe, H. Selod, and V. Viguie. Assessing Urban Policies Using a Simulation Model with Formal and Informal Housing. World Bank Policy Research Working Paper Series, 2019.">2019</a>]</span>), the <code class="docutils literal notranslate"><span class="pre">flood_outputs.py</span></code> module is for processing values relative to floods, and the <code class="docutils literal notranslate"><span class="pre">export_outputs_floods.py</span></code> module is for exporting them. We believe the code here to be self-explanatory enough, and refer the reader to <a class="reference internal" href="api_ref.html"><span class="doc">API reference</span></a> for further details.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="calibration">
<span id="calibration-process"></span><h2>Calibration<a class="headerlink" href="#calibration" title="Permalink to this heading"></a></h2>
<p>This package is essentially called as part of the <code class="docutils literal notranslate"><span class="pre">calib_nb</span></code> notebook. Note that it is only useful to run this script if the underlying data used for calibration has changed, as all necessary parameters have been pre-calibrated. Also note that it takes time to run. Most of the calibration process relies on the estimation of partial relations derived from the general equilibrium model <a class="footnote-reference brackets" href="#fcalib" id="id36">24</a>. It is therefore essential to have a good understanding of the <a class="reference internal" href="#equilibrium-desc"><span class="std std-ref">Equilibrium</span></a> section to understand this part.</p>
<p>The preamble of the <code class="docutils literal notranslate"><span class="pre">calib_nb</span></code> notebook starts with the same imports as the <code class="docutils literal notranslate"><span class="pre">main_nb</span></code> notebook, then does some more data preparation. Essentially, it defines an observed dominant income group and number of formal private units (useful variables for what follows), and a sample selection array for areas where formal private housing units is predominant. This processing is done at the Small Place (SP) level, and ensures that the relations we are going to estimate are well identified: indeed, many of them rely on equilibrium conditions that are only defined for the formal private sector. Note that, whereas the same data might be used for calibration of parameters and validation of results, it is never an input of the model per se: we want to validate / calibrate the model with external data, for the fit not to be automatic.</p>
<p>The rest of the script calls on the <code class="docutils literal notranslate"><span class="pre">calib_main_func.py</span></code> module, that itself calls on other modules from the <code class="docutils literal notranslate"><span class="pre">sub</span></code> directory.</p>
<div class="section" id="housing-production-function-parameters">
<h3>Housing production function parameters<a class="headerlink" href="#housing-production-function-parameters" title="Permalink to this heading"></a></h3>
<p>We start by calibrating housing production function parameters using the <code class="docutils literal notranslate"><span class="pre">estim_construct_func_param</span></code> function. From the equilibrium formulas for housing supply and number of households, we have the following relation:</p>
<div class="math notranslate nohighlight">
\[\frac{N^{FP}(x)Q_{FP}(x)}{L_{FP}(x)} = \kappa^{\frac{1}{a}} (\frac{(1-a)R_{FP}(x)}{\rho + \textcolor{green}{\rho_{FP}^{struct}(x)} + \delta})^{\frac{1-a}{a}}\]</div>
<p>Log-linearizing it (and using the relation between price and rent that we already used to define agricultural rent) allows us to identify the following linear regression, which we estimate with data at the SP level <span class="math notranslate nohighlight">\(s\)</span> (instead of the grid-cell level <span class="math notranslate nohighlight">\(x\)</span>, due to data availability constraints):</p>
<div class="math notranslate nohighlight">
\[log(N_s^{FP}) = \gamma_1 + \gamma_2 log(P_s) + \gamma_3 log(Q_s) + \gamma_4 log(L_s^{FP}) + \epsilon_s\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\gamma_1 = log(\kappa (\frac{1-a}{a})^{1-a})\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\gamma_2 = 1-a\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\gamma_3 = -1\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\gamma_4 = 1\)</span></p></li>
</ul>
<p>We therefore have <span class="math notranslate nohighlight">\(a = 1 - \gamma_2\)</span> and <span class="math notranslate nohighlight">\(\kappa = (\frac{a}{1-a})^{1-a} exp(\gamma_1)\)</span>.</p>
<p>In the code, this translates into:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 85</span>    <span class="c1"># We define our outcome variable</span>
<span class="linenos"> 86</span>    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data_number_formal</span><span class="p">[</span><span class="n">selected_density</span><span class="p">])</span>
<span class="linenos"> 87</span>    <span class="c1"># We define our independent variables</span>
<span class="linenos"> 88</span>    <span class="c1"># Note that we use data_sp[&quot;unconstrained_area&quot;] (which is accurate data at</span>
<span class="linenos"> 89</span>    <span class="c1"># SP level) rather than coeff_land (which is an estimate at grid level)</span>
<span class="linenos"> 90</span>    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
<span class="linenos"> 91</span>        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="n">selected_density</span><span class="p">])),</span>
<span class="linenos"> 92</span>                  <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="n">selected_density</span><span class="p">]),</span>
<span class="linenos"> 93</span>                  <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;dwelling_size&quot;</span><span class="p">][</span><span class="n">selected_density</span><span class="p">]),</span>
<span class="linenos"> 94</span>                  <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;max_land_use&quot;</span><span class="p">]</span>
<span class="linenos"> 95</span>                         <span class="o">*</span> <span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">][</span><span class="n">selected_density</span><span class="p">])])</span>
<span class="linenos"> 96</span>        <span class="p">)</span>
<span class="linenos"> 97</span>    <span class="c1"># NB: Our data set for dwelling sizes only provides the average dwelling</span>
<span class="linenos"> 98</span>    <span class="c1"># size at the Sub-Place level, aggregating formal and informal housing</span>
<span class="linenos"> 99</span>
<span class="linenos">100</span>    <span class="c1"># We run the linear regression</span>
<span class="linenos">101</span>    <span class="n">modelSpecification</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">)</span>
<span class="linenos">102</span>    <span class="n">model_construction</span> <span class="o">=</span> <span class="n">modelSpecification</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="linenos">103</span>    <span class="nb">print</span><span class="p">(</span><span class="n">model_construction</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
<span class="linenos">104</span>    <span class="n">parametersConstruction</span> <span class="o">=</span> <span class="n">model_construction</span><span class="o">.</span><span class="n">params</span>
<span class="linenos">105</span>
<span class="linenos">106</span>    <span class="c1"># We export outputs of the model</span>
<span class="linenos">107</span>    <span class="n">coeff_b</span> <span class="o">=</span> <span class="n">parametersConstruction</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">]</span>
<span class="linenos">108</span>    <span class="n">coeff_a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">coeff_b</span>
<span class="linenos">109</span>    <span class="c1"># Scale factor formula comes from zero profit condition combined with</span>
<span class="linenos">110</span>    <span class="c1"># footnote 16 from Pfeiffer et al. (typo in original paper)</span>
<span class="linenos">111</span>    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_kappa&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">112</span>        <span class="n">coeffKappa</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">coeff_b</span> <span class="o">/</span> <span class="n">coeff_a</span><span class="p">)</span> <span class="o">**</span> <span class="n">coeff_b</span><span class="p">)</span>
<span class="linenos">113</span>                      <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">parametersConstruction</span><span class="p">[</span><span class="s2">&quot;const&quot;</span><span class="p">]))</span>
<span class="linenos">114</span>    <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_kappa&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">115</span>        <span class="n">coeffKappa</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">coeff_b</span><span class="p">)</span> <span class="o">**</span> <span class="n">coeff_b</span><span class="p">)</span>
<span class="linenos">116</span>                      <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">parametersConstruction</span><span class="p">[</span><span class="s2">&quot;const&quot;</span><span class="p">]))</span>
</pre></div>
</div>
<p>Note that we run our regression on the restricted sample defined by the <code class="docutils literal notranslate"><span class="pre">selected_density</span></code> variable.</p>
</div>
<div class="section" id="incomes-and-gravity-parameter">
<h3>Incomes and gravity parameter<a class="headerlink" href="#incomes-and-gravity-parameter" title="Permalink to this heading"></a></h3>
<p>We update the parameter vector with the newly calculated values and go on with the calibration of incomes <span class="math notranslate nohighlight">\(y_{ic}\)</span> and the gravity parameter <span class="math notranslate nohighlight">\(\lambda\)</span> (see <a class="reference internal" href="math_appendix.html"><span class="doc">Commuting choice model</span></a> for more details and definitions).</p>
<p>In practice, we scan a set of predefined values for the parameter <span class="math notranslate nohighlight">\(\lambda\)</span> over which we determine the value of <span class="math notranslate nohighlight">\(y_{ic}\)</span>. We then aggregate the total distribution of residence-workplace distances, and compare it with the data aggregated from Cape Town’s Transport Survey 2013. We select the value of <span class="math notranslate nohighlight">\(\lambda\)</span>, and the associated <span class="math notranslate nohighlight">\(y_{ic}\)</span>, that minimize a distance score between the computed distribution of commuting distances and aggregates from the data.</p>
<p>In the code, this is done through the <code class="docutils literal notranslate"><span class="pre">estim_incomes_and_gravity</span></code> function. First, it imports the number of workers per income group in each selected job center (defined at the Transport Zone level) through the <code class="docutils literal notranslate"><span class="pre">import_employment_data</span></code> function (from the module of the same name).</p>
<div class="section" id="transport-costs">
<span id="id37"></span><h4>Transport costs<a class="headerlink" href="#transport-costs" title="Permalink to this heading"></a></h4>
<p>Then, it imports transport costs through the <code class="docutils literal notranslate"><span class="pre">import_transport_costs</span></code> function (from the <code class="docutils literal notranslate"><span class="pre">compute_income.py</span></code> module).</p>
<p>The first part of this function imports data on transportation times and distances (at the SP level), and estimates of public transportation fixed (over one month) and variable costs, based upon linear regressions using data from <span id="id38">Roux [<a class="reference internal" href="bibliography.html#id22" title="Y. Roux. A Comparative Study of Public Transport Systems in Developing Countries. University of Cape Town, Masters Dissertation Series, 2013.">2013</a>]</span> (table 4.15). It also imports fuel prices for the variable component of private transportation costs, and 400 rands as the monthly depreciation cost of a vehicle for their fixed component.</p>
<p>In a second part, the function computes the total yearly monetary cost of commuting for one household over round trips:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">196</span>    <span class="c1"># Note that we do have some negative durations: their number is small,</span>
<span class="linenos">197</span>    <span class="c1"># so we just convert them to zero</span>
<span class="linenos">198</span>    <span class="n">timeOutput</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;distanceCar&quot;</span><span class="p">]</span>
<span class="linenos">199</span>                           <span class="o">/</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;walking_speed&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos">200</span>    <span class="n">timeOutput</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;durationCar&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">201</span>    <span class="n">timeOutput</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;durationTrain&quot;</span><span class="p">])</span>
<span class="linenos">202</span>    <span class="n">timeOutput</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">][</span><span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;durationTrain&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">203</span>    <span class="n">timeOutput</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;durationCar&quot;</span><span class="p">])</span>
<span class="linenos">204</span>    <span class="n">timeOutput</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">][</span><span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;durationCar&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">205</span>    <span class="n">timeOutput</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;durationMinibus&quot;</span><span class="p">])</span>
<span class="linenos">206</span>    <span class="n">timeOutput</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">][</span><span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;durationMinibus&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">207</span>    <span class="n">timeOutput</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;durationBus&quot;</span><span class="p">])</span>
<span class="linenos">208</span>    <span class="n">timeOutput</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">][</span><span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;durationBus&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">209</span>
<span class="linenos">210</span>    <span class="c1"># Length (in km) using each mode</span>
<span class="linenos">211</span>    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_round_trip&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">212</span>        <span class="n">multiplierPrice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">timeOutput</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="linenos">213</span>        <span class="n">multiplierPrice</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="linenos">214</span>        <span class="n">multiplierPrice</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">timeOutput</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="linenos">215</span>        <span class="n">multiplierPrice</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;distanceCar&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
<span class="linenos">216</span>        <span class="n">multiplierPrice</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;distanceCar&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
<span class="linenos">217</span>        <span class="n">multiplierPrice</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;distanceCar&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
<span class="linenos">218</span>        <span class="n">multiplierPrice</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;distanceCar&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
<span class="linenos">219</span>    <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_round_trip&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">220</span>        <span class="n">multiplierPrice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">timeOutput</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="linenos">221</span>        <span class="n">multiplierPrice</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="linenos">222</span>        <span class="n">multiplierPrice</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">timeOutput</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="linenos">223</span>        <span class="n">multiplierPrice</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;distanceCar&quot;</span><span class="p">]</span>
<span class="linenos">224</span>        <span class="n">multiplierPrice</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;distanceCar&quot;</span><span class="p">]</span>
<span class="linenos">225</span>        <span class="n">multiplierPrice</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;distanceCar&quot;</span><span class="p">]</span>
<span class="linenos">226</span>        <span class="n">multiplierPrice</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">transport_times</span><span class="p">[</span><span class="s2">&quot;distanceCar&quot;</span><span class="p">]</span>
<span class="linenos">227</span>
<span class="linenos">228</span>    <span class="c1"># Convert the results to annual cost</span>
<span class="linenos">229</span>    <span class="n">pricePerKM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="linenos">230</span>    <span class="n">pricePerKM</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="linenos">231</span>    <span class="n">pricePerKM</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">232</span>    <span class="n">pricePerKM</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">priceTrainPerKM</span><span class="o">*</span><span class="n">numberDaysPerYear</span>
<span class="linenos">233</span>    <span class="n">pricePerKM</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">priceFuelPerKM</span><span class="o">*</span><span class="n">numberDaysPerYear</span>
<span class="linenos">234</span>    <span class="n">pricePerKM</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">priceTaxiPerKM</span><span class="o">*</span><span class="n">numberDaysPerYear</span>
<span class="linenos">235</span>    <span class="n">pricePerKM</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">priceBusPerKM</span><span class="o">*</span><span class="n">numberDaysPerYear</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">248</span>    <span class="c1"># Monetary price per year (for each employment center)</span>
<span class="linenos">249</span>    <span class="c1"># NB: 12 is for number of months in a year</span>
<span class="linenos">250</span>    <span class="n">monetaryCost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">185</span><span class="p">,</span> <span class="n">timeOutput</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">))</span>
<span class="linenos">251</span>    <span class="k">for</span> <span class="n">index2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
<span class="linenos">252</span>        <span class="n">monetaryCost</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">index2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pricePerKM</span><span class="p">[</span><span class="n">index2</span><span class="p">]</span>
<span class="linenos">253</span>                                      <span class="o">*</span> <span class="n">multiplierPrice</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">index2</span><span class="p">])</span>
<span class="linenos">254</span>    <span class="c1">#  Train</span>
<span class="linenos">255</span>    <span class="n">monetaryCost</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">monetaryCost</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">priceTrainFixedMonth</span> <span class="o">*</span> <span class="mi">12</span>
<span class="linenos">256</span>    <span class="c1">#  Private car</span>
<span class="linenos">257</span>    <span class="n">monetaryCost</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">monetaryCost</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">priceFixedVehiculeMonth</span>
<span class="linenos">258</span>                             <span class="o">*</span> <span class="mi">12</span><span class="p">)</span>
<span class="linenos">259</span>    <span class="c1">#  Minibus/taxi</span>
<span class="linenos">260</span>    <span class="n">monetaryCost</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">monetaryCost</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">priceTaxiFixedMonth</span> <span class="o">*</span> <span class="mi">12</span>
<span class="linenos">261</span>    <span class="c1">#  Bus</span>
<span class="linenos">262</span>    <span class="n">monetaryCost</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">monetaryCost</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">priceBusFixedMonth</span> <span class="o">*</span> <span class="mi">12</span>
</pre></div>
</div>
<p>In a third and last part, it computes the time opportunity cost parameter (i.e., the fraction of working time spent commuting):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">268</span>    <span class="c1"># Daily share of working time spent commuting (all values in sec)</span>
<span class="linenos">269</span>    <span class="c1"># NB: The time cost parameter is a proportionality factor between time</span>
<span class="linenos">270</span>    <span class="c1"># and monetary values. By default, it is set as 1: the welfare loss from</span>
<span class="linenos">271</span>    <span class="c1"># time spent commuting directly translates into foregone wages.</span>
<span class="linenos">272</span>    <span class="n">costTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">timeOutput</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;time_cost&quot;</span><span class="p">]</span>
<span class="linenos">273</span>                <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">numberHourWorkedPerDay</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="income-calculation">
<h4>Income calculation<a class="headerlink" href="#income-calculation" title="Permalink to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">estim_incomes_and_gravity</span></code> function then goes on with the calibration of incomes per se. To do so, it calls on the <code class="docutils literal notranslate"><span class="pre">EstimateIncome</span></code> function (also from the <code class="docutils literal notranslate"><span class="pre">compute_income.py</span></code> module):</p>
<p>Essentially, this function relies on the following equation (that can be recovered following <a class="reference internal" href="math_appendix.html"><span class="doc">Commuting choice model</span></a>):</p>
<div class="math notranslate nohighlight">
\[W_{ic} = \chi_i \sum_{s} \pi_{c|is} N_{is}\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(W_{ic}\)</span> is the number of households of income group <span class="math notranslate nohighlight">\(i\)</span> who work in job center <span class="math notranslate nohighlight">\(c\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\chi_i\)</span> is the employment rate of households in income group <span class="math notranslate nohighlight">\(i\)</span> (<code class="docutils literal notranslate"><span class="pre">household_size</span></code> parameter divided by 2).</p></li>
<li><p><span class="math notranslate nohighlight">\(\pi_{c|is}\)</span> is the probability to choose to work in location <span class="math notranslate nohighlight">\(c\)</span> given residential location <span class="math notranslate nohighlight">\(s\)</span> (SP level) and income group <span class="math notranslate nohighlight">\(i\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(N_{is}\)</span> is the number of households of income group <span class="math notranslate nohighlight">\(i\)</span> living in residential location <span class="math notranslate nohighlight">\(s\)</span>.</p></li>
</ul>
<p>All the terms in the above equation are observed, except for incomes <span class="math notranslate nohighlight">\(y_{ic}\)</span> (implicit in the definition of <span class="math notranslate nohighlight">\(\pi_{c|is}\)</span>). For each scanned value of <span class="math notranslate nohighlight">\(\lambda\)</span> and each income group, the value of incomes will therefore be updated in accordance to some error term until it falls below a given precision level:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">462</span>            <span class="c1"># Then we iterate by adding to each job center income the average</span>
<span class="linenos">463</span>            <span class="c1"># value of income per income group, weighted by the importance of</span>
<span class="linenos">464</span>            <span class="c1"># the error relative to the observed job center population: if we</span>
<span class="linenos">465</span>            <span class="c1"># underestimate the population, we increase the income</span>
<span class="linenos">466</span>            <span class="k">while</span> <span class="p">((</span><span class="nb">iter</span> <span class="o">&lt;=</span> <span class="n">maxIter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">errorMax</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">)):</span>
<span class="linenos">467</span>
<span class="linenos">468</span>                <span class="n">incomeCenters</span><span class="p">[:,</span> <span class="nb">iter</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">469</span>                    <span class="n">incomeCenters</span><span class="p">[:,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">iter</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
<span class="linenos">470</span>                    <span class="o">+</span> <span class="n">factorConvergenge</span>
<span class="linenos">471</span>                    <span class="o">*</span> <span class="n">averageIncomeGroup</span>
<span class="linenos">472</span>                    <span class="o">*</span> <span class="n">error</span><span class="p">[:,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">iter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
<span class="linenos">473</span>                    <span class="o">/</span> <span class="n">popCenters</span>
<span class="linenos">474</span>                <span class="p">)</span>
<span class="linenos">475</span>
<span class="linenos">476</span>                <span class="c1"># We also update the error term and store some values</span>
<span class="linenos">477</span>                <span class="c1"># before iterating over</span>
<span class="linenos">478</span>                <span class="n">error</span><span class="p">[:,</span> <span class="nb">iter</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">commutingSolve</span><span class="p">(</span>
<span class="linenos">479</span>                    <span class="n">incomeCenters</span><span class="p">[:,</span> <span class="nb">iter</span><span class="p">],</span> <span class="n">averageIncomeGroup</span><span class="p">,</span> <span class="n">popCenters</span><span class="p">,</span>
<span class="linenos">480</span>                    <span class="n">popResidence</span><span class="p">,</span> <span class="n">monetary_cost</span><span class="p">,</span> <span class="n">costTime</span><span class="p">,</span> <span class="n">param_lambda</span><span class="p">,</span>
<span class="linenos">481</span>                    <span class="n">householdSize</span><span class="p">,</span> <span class="n">whichCenters</span><span class="p">,</span> <span class="n">bracketsDistance</span><span class="p">,</span>
<span class="linenos">482</span>                    <span class="n">distanceOutput</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
<span class="linenos">483</span>
<span class="linenos">484</span>                <span class="n">errorMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span>
<span class="linenos">485</span>                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">error</span><span class="p">[:,</span> <span class="nb">iter</span><span class="p">]</span> <span class="o">/</span> <span class="n">popCenters</span><span class="p">))</span>
<span class="linenos">486</span>                <span class="n">scoreIter</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span>
<span class="linenos">487</span>                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">error</span><span class="p">[:,</span> <span class="nb">iter</span><span class="p">]</span> <span class="o">/</span> <span class="n">popCenters</span><span class="p">))</span>
<span class="linenos">488</span>
<span class="linenos">489</span>                <span class="nb">iter</span> <span class="o">=</span> <span class="nb">iter</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Note that the convergence factors are numerical parameters with no interpretation per se, that are fine-tuned by trial and error to help convergence.</p>
<p>Both the error term and the simulated distribution of residence-workplace distances are obtained as outputs of the <code class="docutils literal notranslate"><span class="pre">commutingSolve</span></code> function. Let us dig into its body. First, it computes the probability <span class="math notranslate nohighlight">\(\pi_{c|is}\)</span> by calling on the <code class="docutils literal notranslate"><span class="pre">compute_ODflows</span></code> function (again, see <a class="reference internal" href="math_appendix.html"><span class="doc">Commuting choice model</span></a> for more details on this function). Then, it simply defines the error term as the difference between the two sides of the above equation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">784</span>    <span class="c1"># NB: correction is not needed a priori, as income distribution data from</span>
<span class="linenos">785</span>    <span class="c1"># SP does not include people out of employment</span>
<span class="linenos">786</span>    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_eq3&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">787</span>        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="n">popCenters</span>
<span class="linenos">788</span>                 <span class="o">-</span> <span class="p">(</span><span class="n">householdSize</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos">789</span>                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">popResidence</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">ODflows</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="linenos">790</span>                 <span class="p">)</span>
<span class="linenos">791</span>    <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_eq3&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">792</span>        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="n">popCenters</span>
<span class="linenos">793</span>                 <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">popResidence</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">ODflows</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>Finally, it defines the number of commuters per distance bracket in aggregate data (same as residence-workplace distance distribution) by collapsing the right-hand side of the equation into those brackets:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">797</span>    <span class="n">nbCommuters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bracketsDistance</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">798</span>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bracketsDistance</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos">799</span>        <span class="n">which</span> <span class="o">=</span> <span class="p">((</span><span class="n">distanceOutput</span><span class="p">[</span><span class="n">whichCenters</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;</span> <span class="n">bracketsDistance</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
<span class="linenos">800</span>                 <span class="o">&amp;</span> <span class="p">(</span><span class="n">distanceOutput</span><span class="p">[</span><span class="n">whichCenters</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">bracketsDistance</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
<span class="linenos">801</span>                 <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">distanceOutput</span><span class="p">[</span><span class="n">whichCenters</span><span class="p">,</span> <span class="p">:])))</span>
<span class="linenos">802</span>        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_eq3&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">803</span>            <span class="n">nbCommuters</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">804</span>                <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">which</span> <span class="o">*</span> <span class="n">ODflows</span> <span class="o">*</span> <span class="n">popResidence</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>
<span class="linenos">805</span>                <span class="o">*</span> <span class="p">(</span><span class="n">householdSize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos">806</span>                <span class="p">)</span>
<span class="linenos">807</span>        <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_eq3&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">808</span>            <span class="n">nbCommuters</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">809</span>                <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">which</span> <span class="o">*</span> <span class="n">ODflows</span> <span class="o">*</span> <span class="n">popResidence</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]))</span>
</pre></div>
</div>
</div>
<div class="section" id="parameter-selection">
<h4>Parameter selection<a class="headerlink" href="#parameter-selection" title="Permalink to this heading"></a></h4>
<p>Back to the body of the <code class="docutils literal notranslate"><span class="pre">estim_incomes_and_gravity</span></code> function, we import the residence-workplace distance distribution observed in the data, and define <a class="reference external" href="https://en.wikipedia.org/wiki/Bhattacharyya_distance">Bhattacharyya distance</a> as our score. Then, we simply select the gravity-income pair that minimizes this metric:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">246</span>    <span class="c1"># Residence-workplace distance distribution comes from the CoCT&#39;s 2013</span>
<span class="linenos">247</span>    <span class="c1"># Transport Survey</span>
<span class="linenos">248</span>    <span class="n">data_distance_distribution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<span class="linenos">249</span>        <span class="p">[</span><span class="mf">45.6174222</span><span class="p">,</span> <span class="mf">18.9010734</span><span class="p">,</span> <span class="mf">14.9972971</span><span class="p">,</span> <span class="mf">9.6725616</span><span class="p">,</span> <span class="mf">5.9425438</span><span class="p">,</span> <span class="mf">2.5368754</span><span class="p">,</span>
<span class="linenos">250</span>         <span class="mf">0.9267125</span><span class="p">,</span> <span class="mf">0.3591011</span><span class="p">,</span> <span class="mf">1.0464129</span><span class="p">])</span>
<span class="linenos">251</span>
<span class="linenos">252</span>    <span class="c1"># Compute accessibility index</span>
<span class="linenos">253</span>    <span class="c1"># NB1: Bhattacharyya distance measures the similarity of two probability</span>
<span class="linenos">254</span>    <span class="c1"># distributions (here, data vs. simulated % of commuters)</span>
<span class="linenos">255</span>    <span class="c1"># NB2: Mahalanobis distance is a particular case of the Bhattacharyya</span>
<span class="linenos">256</span>    <span class="c1"># distance when the standard deviations of the two classes are the same</span>
<span class="linenos">257</span>    <span class="n">bhattacharyyaDistances</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">258</span>        <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data_distance_distribution</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
<span class="linenos">259</span>                                   <span class="o">/</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">distanceDistribution</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
<span class="linenos">260</span>        <span class="p">)</span>
<span class="linenos">261</span>    <span class="n">whichLambda</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">bhattacharyyaDistances</span><span class="p">)</span>
<span class="linenos">262</span>
<span class="linenos">263</span>    <span class="c1"># Hence, we keep the lambda that minimizes the distance and the associated</span>
<span class="linenos">264</span>    <span class="c1"># income vector</span>
<span class="linenos">265</span>    <span class="n">lambdaKeep</span> <span class="o">=</span> <span class="n">list_lambda</span><span class="p">[</span><span class="n">whichLambda</span><span class="p">]</span>
<span class="linenos">266</span>    <span class="n">incomeCentersKeep</span> <span class="o">=</span> <span class="n">incomeCenters</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">whichLambda</span><span class="p">]</span>
</pre></div>
</div>
<p>Note that we rely on this two-step computation-selection procedure as a simplification for a more complex nested optimization (as the value of the distance score itself depends on the value of calibrated incomes): given the fine discrete range that we use for scanning (see <code class="docutils literal notranslate"><span class="pre">scan_type</span></code> option), we consider our results as a good enough approximation of true parameter values (as long as we stay at the interior of the scanned range).</p>
</div>
</div>
<div class="section" id="utility-function-parameters">
<h3>Utility function parameters<a class="headerlink" href="#utility-function-parameters" title="Permalink to this heading"></a></h3>
<p>We update the parameter vector with the newly calculated values and go on with the calibration of utility function parameters through the <code class="docutils literal notranslate"><span class="pre">estim_util_func_param</span></code> function. It allows to optimize over the parameters <span class="math notranslate nohighlight">\(\beta\)</span>, <span class="math notranslate nohighlight">\(q_0\)</span>, and the utility levels of various income groups (hence, indirectly, the local amenity index <span class="math notranslate nohighlight">\(A(x)\)</span>) <a class="footnote-reference brackets" href="#disam-index" id="id39">25</a>. To do so, it fits three data moments where those variables enter, as they cannot be identified separately from the model structure otherwise. More precisely, it is going to maximize a composite log-likelihood that sums one log-likelihood for the fit of the predicted local amenity index on exogenous amenities, one for the fit of predicted income sorting, and one for the fit of predicted dwelling sizes <a class="footnote-reference brackets" href="#mle" id="id40">26</a>.</p>
<p>We are going to describe this process in more details, as it is the one followed in <span id="id41">Pfeiffer <em>et al.</em> [<a class="reference internal" href="bibliography.html#id43" title="B. Pfeiffer, C. Rabe, H. Selod, and V. Viguie. Assessing Urban Policies Using a Simulation Model with Formal and Informal Housing. World Bank Policy Research Working Paper Series, 2019.">2019</a>]</span>, but before that, we are going to explain why we actually only use the first data moment in our benchmark specification.</p>
<div class="section" id="external-calibration">
<h4>External calibration<a class="headerlink" href="#external-calibration" title="Permalink to this heading"></a></h4>
<p>First of all, note that the procedure we just described is a complex optimization problem that requires us to run a prior discrete parameter scanning before running a smooth optimization algorithm (such as gradient descent, etc.), to ensure that we start in the interior set of feasible solutions (which is not obvious a priori given the multi-dimensionality of the problem). Then, even within this set, we may not face unique solutions. We therefore suggest a way to reduce the dimensionality of the problem, at the same time as improving the empirical validity of our estimates.</p>
<p>For a start, the parameter <span class="math notranslate nohighlight">\(q_0\)</span> has a direct empirical interpretation: it can just be set to be equal to the bottom decile, or bottom percentile, of observed dwelling sizes. Since we do not have access to such data (but only to average dwelling sizes aggregated at the SP level), we just keep the value calibrated in <span id="id42">Pfeiffer <em>et al.</em> [<a class="reference internal" href="bibliography.html#id43" title="B. Pfeiffer, C. Rabe, H. Selod, and V. Viguie. Assessing Urban Policies Using a Simulation Model with Formal and Informal Housing. World Bank Policy Research Working Paper Series, 2019.">2019</a>]</span>, which is plausible enough, to be substituted later with a more robust value: although this approach may seem more rudimentary than the full one, it requires no structural assumptions whatsoever.</p>
<p>It is different for the <span class="math notranslate nohighlight">\(\beta\)</span> parameter. Its empirical counterpart would be the expenditure share of households on housing (at purchasing power parity). However, direct measurement of such quantity in expenditure survey data suffers from numerous biases, as we do not observe annual spending by owner-occupiers (as opposed to renters), and we do not observe variation in local housing prices either (see <span id="id43">Diamond and Gaubert [<a class="reference internal" href="bibliography.html#id26" title="R. Diamond and C. Gaubert. Spatial Sorting and Inequality. Annual Review of Economics, 2022.">2022</a>]</span> for more details). Then, due to non-homotheticity (households spend a smaller share of their budget on housing as their income increases), this share is expected to vary across income groups. Yet, it is the whole point of using a Stone-Geary (as opposed to Cobb-Douglas) specification to micro-found such non-homotheticity with a single elasticity parameter <a class="footnote-reference brackets" href="#heterog" id="id44">27</a>.</p>
<p>For all those reasons, we need to leverage some theoretical structure to estimate this parameter. However, whereas the Cobb-Douglas specification used for the housing production function has been shown to be empirically robust <span id="id45">[<a class="reference internal" href="bibliography.html#id33" title="P.-P. Combes, G. Duranton, and L. Gobillon. The Production Function for Housing: Evidence from France. Journal of Political Economy, 129(10):2766-816, 2021.">Combes <em>et al.</em>, 2021</a>]</span>, it is not the case for Stone-Geary preferences, which should rather be thought of as a first-order approximation for non-homothetic constant elasticity of substitution (NHCES) preferences or price independent generalized linear (PIGL) preferences <a class="footnote-reference brackets" href="#ces" id="id46">28</a> <span id="id47">[<a class="reference internal" href="bibliography.html#id34" title="J. Finlay and T. Williams. Housing Demand, Inequality, and Spatial Sorting. 2022.">Finlay and Williams, 2022</a>]</span>. Therefore, we think it is more generally valid to directly use the benchmark estimate for the <span class="math notranslate nohighlight">\(\beta\)</span> parameter (which also controls for the aforementioned biases) from this last paper, instead of trying to estimate it ourselves (with endogenous moments). Luckily for us, it is almost the same as the value estimated by <span id="id48">Pfeiffer <em>et al.</em> [<a class="reference internal" href="bibliography.html#id43" title="B. Pfeiffer, C. Rabe, H. Selod, and V. Viguie. Assessing Urban Policies Using a Simulation Model with Formal and Informal Housing. World Bank Policy Research Working Paper Series, 2019.">2019</a>]</span>. We therefore keep that value in the code, and do not contradict previous findings (even though we discuss the corresponding method).</p>
<p>Then, we are simply left with the estimation of the local amenity score <span class="math notranslate nohighlight">\(A(x)\)</span>, that we are going to detail below. A last general comment we want to make is that, even for a well-identified model, it is important to run sensitivity checks on the value of parameters: for internal calibration, this implies checking alternative data processing and sample selection ; for external calibration, this implies scanning through acceptable ranges of values (more on that in the code). Running the calibration with data from previous years is also a good robustness check to determine how close our estimates are to the long-term equilibrium values we are targeting.</p>
</div>
<div class="section" id="fit-on-exogenous-amenities">
<h4>Fit on exogenous amenities<a class="headerlink" href="#fit-on-exogenous-amenities" title="Permalink to this heading"></a></h4>
<p>Back to the body of the <code class="docutils literal notranslate"><span class="pre">estim_util_func_param</span></code> function, we define a less stringent selection array than <code class="docutils literal notranslate"><span class="pre">selected_density</span></code> to maintain predictive power (with a high enough number of observations) while potentially losing some empirical validity (remember that our theoretical relations are only valid for the formal private sector):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">371</span>    <span class="n">selectedSP</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">372</span>        <span class="p">(</span><span class="n">data_number_formal</span> <span class="o">&gt;</span> <span class="mf">0.90</span> <span class="o">*</span> <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">total_dwellings_SP_2011</span><span class="p">)</span>
<span class="linenos">373</span>        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_income_group</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">374</span>        <span class="p">)</span>
</pre></div>
</div>
<p>After pinning down the values of <span class="math notranslate nohighlight">\(\beta\)</span> and <span class="math notranslate nohighlight">\(q_0\)</span>, we define target utility levels close to what is expected as an equilibrium outcome:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">407</span>    <span class="n">utilityTarget</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">4800</span><span class="p">,</span> <span class="mi">16000</span><span class="p">,</span> <span class="mi">77000</span><span class="p">])</span>
</pre></div>
</div>
<p>Since, in practice, the poorest income group is going to be crowded out of the formal private sector, we are only going to optimize over the utility levels of the three richest income groups. For the sake of numerical simplicity, we are even going to take the lowest utility level as fixed, and allow only the two highest to vary (note that none of this is critical for convergence):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">455</span>    <span class="n">listVariation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="linenos">456</span>    <span class="n">initUti2</span> <span class="o">=</span> <span class="n">utilityTarget</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">457</span>    <span class="n">listUti3</span> <span class="o">=</span> <span class="n">utilityTarget</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">listVariation</span>
<span class="linenos">458</span>    <span class="n">listUti4</span> <span class="o">=</span> <span class="n">utilityTarget</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">listVariation</span>
</pre></div>
</div>
<p>Indeed, based on households’ first-order optimality conditions, the predicted value of the amenity score is going to depend on all of the above through the formula:</p>
<div class="math notranslate nohighlight">
\[A_s = \frac{u_{i(s)}}{(1 - \beta)^{1 - \beta} \beta ^{\beta}} \frac{\tilde{y}_s - q_0 R_s}{R_s ^{\beta}}\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(u_{i(s)}\)</span> is the utility level of the dominant income group <span class="math notranslate nohighlight">\(i\)</span> in Small Place <span class="math notranslate nohighlight">\(s\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\tilde{y}_s\)</span> is the expected income net of commuting costs of the dominant income group in Small Place <span class="math notranslate nohighlight">\(s\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(R_s\)</span> is the observed annual rent (per m²) in Small Place <span class="math notranslate nohighlight">\(s\)</span>.</p></li>
</ul>
<p>Note that, since we only observe housing prices in transaction data, we define <span class="math notranslate nohighlight">\(R_s\)</span> as the flow value of the underlying housing asset:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">496</span>    <span class="n">dataRent</span> <span class="o">=</span> <span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">interest_rate</span>
</pre></div>
</div>
<p>Also note that we are not interested in the value of the utility levels per se at this stage, but only in the value of the amenity score. We could therefore directly optimize over that value. The reason why we keep the above specification is that it becomes important when we also want to optimize over <span class="math notranslate nohighlight">\(\beta\)</span> and <span class="math notranslate nohighlight">\(q_0\)</span>. Then, if we are only interested in the calibration of the amenity score, we believe it is more robust to estimate only the fit with regard to exogenous amenities. Indeed, this implies very light structural assumptions compared to other moments, and it ensures that the amenity score is well-identified. The score has an impact on the other two moments, but if we allow them to enter the calibration, then it would also capture part of the residual fit of the model (i.e., the part not explained by amenity factors). Therefore, sticking with the first data moment allows the amenity score to have a clear empirical interpretation, which can also be leveraged for policy evaluation (studying how a change in exogenous coviarates eventually impacts spatial sorting). Still, using more moments becomes important to avoid underidentification when we want to estimate more interacting parameters, even if it comes at the price of tractability.</p>
<p>Then, we just import amenity data with the <code class="docutils literal notranslate"><span class="pre">import_exog_amenities</span></code> function and select exogenous covariates before calling on the <code class="docutils literal notranslate"><span class="pre">EstimateParametersByScanning</span></code> function that runs the discrete parameter scan. This function runs some additional sample and variable selection, then defines useful functions for the optimization algorithm, before running the algorithm per se:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">156</span>    <span class="c1"># %% FUNCTIONS USED FOR THE FIT ON DWELLING SIZE AND AMENITIES</span>
<span class="linenos">157</span>
<span class="linenos">158</span>    <span class="c1"># Relationship between rents and dwelling sizes (see technical</span>
<span class="linenos">159</span>    <span class="c1"># documentation)</span>
<span class="linenos">160</span>    <span class="n">CalculateDwellingSize</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">161</span>        <span class="k">lambda</span> <span class="n">beta</span><span class="p">,</span> <span class="n">basic_q</span><span class="p">,</span> <span class="n">incomeTemp</span><span class="p">,</span> <span class="n">rentTemp</span><span class="p">:</span>
<span class="linenos">162</span>            <span class="n">beta</span> <span class="o">*</span> <span class="n">incomeTemp</span> <span class="o">/</span> <span class="n">rentTemp</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">basic_q</span>
<span class="linenos">163</span>            <span class="p">)</span>
<span class="linenos">164</span>
<span class="linenos">165</span>    <span class="c1"># Log likelihood for a lognormal law of mean 0: we will assume that</span>
<span class="linenos">166</span>    <span class="c1"># dwelling size and amenity residuals follow such a law (see math</span>
<span class="linenos">167</span>    <span class="c1"># appendix)</span>
<span class="linenos">168</span>    <span class="n">ComputeLogLikelihood</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">169</span>        <span class="k">lambda</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
<span class="linenos">170</span>            <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="linenos">171</span>                      <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="linenos">172</span>            <span class="p">)</span>
<span class="linenos">173</span>
<span class="linenos">174</span>    <span class="c1"># %% OPTIMIZATION ALGORITHM</span>
<span class="linenos">175</span>
<span class="linenos">176</span>    <span class="c1"># We decide whether we want to use GLM or OLS estimation for the fit on</span>
<span class="linenos">177</span>    <span class="c1"># exogenous amenities.</span>
<span class="linenos">178</span>    <span class="c1"># Note that GLM is not stable in this version of the code (default option</span>
<span class="linenos">179</span>    <span class="c1"># set as zero)</span>
<span class="linenos">180</span>    <span class="n">optionRegression</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;glm&quot;</span><span class="p">]</span>
<span class="linenos">181</span>
<span class="linenos">182</span>    <span class="c1"># Initial value of parameters (all possible combinations)</span>
<span class="linenos">183</span>    <span class="c1"># Note that we do not consider spatial autocorrelation</span>
<span class="linenos">184</span>    <span class="n">combinationInputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<span class="linenos">185</span>        <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">listBeta</span><span class="p">,</span> <span class="n">listBasicQ</span><span class="p">,</span> <span class="n">listUti3</span><span class="p">,</span> <span class="n">listUti4</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="linenos">186</span>
<span class="linenos">187</span>    <span class="c1"># Initial score (log-likelihood) values for each regression</span>
<span class="linenos">188</span>    <span class="c1"># Note that fit on housing supply / building density is included, as the</span>
<span class="linenos">189</span>    <span class="c1"># estimation (where it will be cancelled out) is done in the</span>
<span class="linenos">190</span>    <span class="c1"># calibration.sub.loglikelihood module.</span>
<span class="linenos">191</span>    <span class="n">scoreAmenities</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">10000</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">combinationInputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">192</span>    <span class="n">scoreDwellingSize</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">10000</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">combinationInputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">193</span>    <span class="n">scoreIncomeSorting</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">10000</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">combinationInputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">194</span>    <span class="n">scoreHousing</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">10000</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">combinationInputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">195</span>    <span class="n">scoreTotal</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">10000</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">combinationInputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">196</span>
<span class="linenos">197</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Start scanning&#39;</span><span class="p">)</span>
<span class="linenos">198</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos">199</span>
<span class="linenos">200</span>    <span class="c1"># We update the scores for each set of parameters</span>
<span class="linenos">201</span>    <span class="c1"># Note that</span>
<span class="linenos">202</span>    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">combinationInputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<span class="linenos">203</span>        <span class="c1"># print(index)</span>
<span class="linenos">204</span>        <span class="p">(</span><span class="n">scoreTotal</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">scoreAmenities</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">scoreDwellingSize</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
<span class="linenos">205</span>         <span class="n">scoreIncomeSorting</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">scoreHousing</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">parametersAmenities</span><span class="p">,</span>
<span class="linenos">206</span>         <span class="n">modelAmenities</span><span class="p">,</span> <span class="n">parametersHousing</span><span class="p">)</span> <span class="o">=</span> <span class="n">callog</span><span class="o">.</span><span class="n">LogLikelihoodModel</span><span class="p">(</span>
<span class="linenos">207</span>             <span class="n">combinationInputs</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:],</span> <span class="n">initUti2</span><span class="p">,</span> <span class="n">net_income</span><span class="p">,</span>
<span class="linenos">208</span>             <span class="n">groupLivingSpMatrix</span><span class="p">,</span> <span class="n">dataDwellingSize</span><span class="p">,</span> <span class="n">selectedDwellingSize</span><span class="p">,</span>
<span class="linenos">209</span>             <span class="n">dataRent</span><span class="p">,</span> <span class="n">selectedRents</span><span class="p">,</span> <span class="n">predictorsAmenitiesMatrix</span><span class="p">,</span>
<span class="linenos">210</span>             <span class="n">tableRegression</span><span class="p">,</span> <span class="n">variablesRegression</span><span class="p">,</span> <span class="n">CalculateDwellingSize</span><span class="p">,</span>
<span class="linenos">211</span>             <span class="n">ComputeLogLikelihood</span><span class="p">,</span> <span class="n">optionRegression</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
<span class="linenos">212</span>
<span class="linenos">213</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Scanning complete&#39;</span><span class="p">)</span>
<span class="linenos">214</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos">215</span>
<span class="linenos">216</span>    <span class="c1"># We just pick the parameters associated to the maximum score</span>
<span class="linenos">217</span>    <span class="c1"># Note that scoreHousing is set as zero and does not impact parameter</span>
<span class="linenos">218</span>    <span class="c1"># selection.</span>
<span class="linenos">219</span>
<span class="linenos">220</span>    <span class="c1"># By default, we cancel out the scores associated with observed dwelling</span>
<span class="linenos">221</span>    <span class="c1"># sizes and income sorting: this is because the fit on exogenous amenities</span>
<span class="linenos">222</span>    <span class="c1"># is the only relevant dimension when beta and q0 are pinned down and the</span>
<span class="linenos">223</span>    <span class="c1"># amenity score is the only parameter left to calibrate</span>
<span class="linenos">224</span>    <span class="n">scoreDwellingSize</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">225</span>    <span class="n">scoreIncomeSorting</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">226</span>
<span class="linenos">227</span>    <span class="n">scoreVect</span> <span class="o">=</span> <span class="p">(</span><span class="n">scoreAmenities</span> <span class="o">+</span> <span class="n">scoreDwellingSize</span> <span class="o">+</span> <span class="n">scoreIncomeSorting</span>
<span class="linenos">228</span>                 <span class="o">+</span> <span class="n">scoreHousing</span><span class="p">)</span>
<span class="linenos">229</span>    <span class="n">scoreTot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">scoreVect</span><span class="p">)</span>
<span class="linenos">230</span>    <span class="n">which</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scoreVect</span><span class="p">)</span>
<span class="linenos">231</span>    <span class="n">parameters</span> <span class="o">=</span> <span class="n">combinationInputs</span><span class="p">[</span><span class="n">which</span><span class="p">,</span> <span class="p">:]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">CalculateDwellingSize</span></code> function will be used as part of the third moment estimation, while the <code class="docutils literal notranslate"><span class="pre">ComputeLogLikelihood</span></code> function will be used for both the first and the third moment estimations. The <code class="docutils literal notranslate"><span class="pre">LogLikelihoodModel</span></code> function (defined as part of the <code class="docutils literal notranslate"><span class="pre">loglikelihood</span></code> module) returns the values of the log-likelihoods associated with each data moment. <strong>Note how we set the log-likelihoods associated with the fit on dwelling sizes and income sorting to zero before maximizing the composite log-likelihood</strong> (<code class="docutils literal notranslate"><span class="pre">scoreHousing</span></code> is also set to zero as part of the <code class="docutils literal notranslate"><span class="pre">LogLikelihoodModel</span></code> function, and serves as a placeholder for an additional data moment used in alternative versions of <strong>NEDUM-2D</strong>): this is where we decide to focus only on the first data moment.</p>
<p>As part of the <code class="docutils literal notranslate"><span class="pre">LogLikelihoodModel</span></code> function, we finally define the log-likelihood associated with the fit on exogenous amenities. Consider the following relation:</p>
<div class="math notranslate nohighlight">
\[A_s = (\prod_{n} (a_{n,s})^{\mathcal{v}_i}) \epsilon_{A,s}\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(a_{n,s}\)</span> are exogenous amenity covariates at the SP level.</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathcal{v}_i\)</span> are elasticity parameters to be estimated (conditional on the dominant income group at the SP level).</p></li>
<li><p><span class="math notranslate nohighlight">\(\epsilon_{A,s}\)</span> is an error term that is log-normally distributed with mean zero.</p></li>
</ul>
<p>Log-linearizing this relation, we can regress the predicted value of the log-amenity score on log-values of exogenous amenities that we proxy as dummy variables (pre-processing is already done as part of the <code class="docutils literal notranslate"><span class="pre">import_exog_amenities</span></code> function), and estimate the parameters <span class="math notranslate nohighlight">\(\mathcal{v}_i\)</span> by ordinary least squares (OLS). In the code, this yields:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">127</span>    <span class="c1"># Theoretical formula for log amenity index (from technical documentation)</span>
<span class="linenos">128</span>    <span class="c1"># Note that we stay under sample selection from selectedRents variable</span>
<span class="linenos">129</span>    <span class="n">logAmenityIndex</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">130</span>        <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Uo</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">])</span>
<span class="linenos">131</span>        <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
<span class="linenos">132</span>            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">**</span> <span class="n">beta</span>
<span class="linenos">133</span>            <span class="o">*</span> <span class="p">(</span><span class="n">net_income</span><span class="p">[:,</span> <span class="n">selectedRents</span><span class="p">]</span>
<span class="linenos">134</span>               <span class="o">-</span> <span class="n">basicQ</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataRent</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="n">selectedRents</span><span class="p">])</span>
<span class="linenos">135</span>            <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataRent</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="n">selectedRents</span><span class="p">]</span> <span class="o">**</span> <span class="n">beta</span><span class="p">))</span>
<span class="linenos">136</span>        <span class="p">)</span>
<span class="linenos">137</span>    <span class="c1"># We select values for dominant income groups only and flatten the array:</span>
<span class="linenos">138</span>    <span class="c1"># this allows to select the appropriate net income and utility to identify</span>
<span class="linenos">139</span>    <span class="c1"># the regression</span>
<span class="linenos">140</span>    <span class="n">logAmenityIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span>
<span class="linenos">141</span>        <span class="n">logAmenityIndex</span> <span class="o">*</span> <span class="n">groupLivingSpMatrix</span><span class="p">[:,</span> <span class="n">selectedRents</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">142</span>    <span class="c1"># logAmenityIndex[np.abs(logAmenityIndex.imag) &gt; 0] = np.nan</span>
<span class="linenos">143</span>    <span class="c1"># logAmenityIndex[logAmenityIndex == -np.inf] = np.nan</span>
<span class="linenos">144</span>
<span class="linenos">145</span>    <span class="c1"># We get residuals for the regression of log amenity index on exogenous</span>
<span class="linenos">146</span>    <span class="c1"># dummy variables.</span>
<span class="linenos">147</span>    <span class="c1"># Note that we identify dummies with logs of original amenity values</span>
<span class="linenos">148</span>    <span class="c1"># (normalized to take values between 1 and e): see technical documentation</span>
<span class="linenos">149</span>
<span class="linenos">150</span>    <span class="c1"># OLS estimation</span>
<span class="linenos">151</span>    <span class="k">if</span> <span class="p">(</span><span class="n">optionRegression</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">152</span>        <span class="n">A</span> <span class="o">=</span> <span class="n">predictorsAmenitiesMatrix</span>  <span class="c1"># [~np.isnan(logAmenityIndex), :]</span>
<span class="linenos">153</span>        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">logAmenityIndex</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">logAmenityIndex</span><span class="p">)])</span><span class="o">.</span><span class="n">real</span>
<span class="linenos">154</span>        <span class="c1"># parametersAmenities, residuals, rank, s = np.linalg.lstsq(A, y,</span>
<span class="linenos">155</span>        <span class="c1">#                                                           rcond=None)</span>
<span class="linenos">156</span>        <span class="c1"># res = scipy.optimize.lsq_linear(A, y)</span>
<span class="linenos">157</span>        <span class="c1"># parametersAmenities = res.x</span>
<span class="linenos">158</span>        <span class="c1"># residuals = res.fun</span>
<span class="linenos">159</span>        <span class="n">modelSpecification</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">)</span>
<span class="linenos">160</span>        <span class="n">modelAmenities</span> <span class="o">=</span> <span class="n">modelSpecification</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="linenos">161</span>        <span class="n">parametersAmenities</span> <span class="o">=</span> <span class="n">modelAmenities</span><span class="o">.</span><span class="n">params</span>
<span class="linenos">162</span>        <span class="n">errorAmenities</span> <span class="o">=</span> <span class="n">modelAmenities</span><span class="o">.</span><span class="n">resid_pearson</span>
</pre></div>
</div>
<p>This also allows us to recover the value of the <span class="math notranslate nohighlight">\(\log(\epsilon_{A,s})\)</span> residuals. Since they are normally distributed, the associated log-likelihood is directly given by the <code class="docutils literal notranslate"><span class="pre">ComputeLogLikelihood</span></code> function <a class="footnote-reference brackets" href="#mle-ols" id="id49">29</a>. Formally, this corresponds to:</p>
<div class="math notranslate nohighlight">
\[\mathcal{L} = - \sum_n [\frac{\log(2 \pi \sigma ^2)}{2} + \frac{\epsilon ^2}{2 \sigma ^2}]\]</div>
<p>The calibration of the amenity score will then be completed in two steps. First, we will select the appropriate statistical model by selecting the maximum log-likelihood. Then, we will define the amenity score as the explained part of the model (i.e., the value predicted by the regressors) by taking residuals out. Back to the body of the <code class="docutils literal notranslate"><span class="pre">estim_util_func_param</span></code> function, this corresponds to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">546</span>    <span class="n">amenities_grid</span> <span class="o">=</span> <span class="n">calam</span><span class="o">.</span><span class="n">import_exog_amenities</span><span class="p">(</span>
<span class="linenos">547</span>        <span class="n">path_data</span><span class="p">,</span> <span class="n">path_precalc_inp</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">)</span>
<span class="linenos">548</span>    <span class="n">predictors_grid</span> <span class="o">=</span> <span class="n">amenities_grid</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">variables_regression</span><span class="p">]</span>
<span class="linenos">549</span>    <span class="n">predictors_grid</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">predictors_grid</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">565</span>        <span class="n">cal_amenities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
<span class="linenos">566</span>            <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">predictors_grid</span> <span class="o">*</span> <span class="n">parametersAmenitiesScan</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="fit-on-income-sorting">
<h4>Fit on income sorting<a class="headerlink" href="#fit-on-income-sorting" title="Permalink to this heading"></a></h4>
<p>Now, suppose we also want to optimize over the <span class="math notranslate nohighlight">\(\beta\)</span> and <span class="math notranslate nohighlight">\(q_0\)</span> parameters. We will need to comment out the part of the code where we set the scores associated with the two remaining data moments to zero. Let us comment on those data moments.</p>
<p>Observed income sorting can be rationalized through a discrete-choice Logit model (similar to the approach we follow in <a class="reference internal" href="math_appendix.html"><span class="doc">Commuting choice model</span></a>). According to bid-rent theory, we consider that households bid their true valuation and that land is allocated to the highest bidder. Identifying the group with the highest bids as the dominant group in the data, we can write the log-likelihood for income sorting as:</p>
<div class="math notranslate nohighlight">
\[\mathcal{l} = \sum_s (\frac{\Psi_{i(s)}(s)}{\lambda_{inc}}) - \sum_s \log(\sum_j e^{\frac{\Psi_{j}(s)}{\lambda_{inc}}})\]</div>
<p>We remind the reader that <span class="math notranslate nohighlight">\(\Psi_{j}(s)\)</span> stands for the bid rent of some income group <span class="math notranslate nohighlight">\(j\)</span> in Small Place <span class="math notranslate nohighlight">\(s\)</span>. <span class="math notranslate nohighlight">\(\lambda_{inc}\)</span> is a scale factor associated with the underlying Gumbel distribution of idiosyncratic tastes. It is going to increase the log-likelihood when it goes up. Note however that this impact is marginal above 10. To be conservative, while keeping the same order of magnitude as for gravity parameter  <span class="math notranslate nohighlight">\(\lambda\)</span>, we pin down this value in the code. We do not go below as it would signficantly reduce the value of the log-likelihood, and we want all the likelihoods to be of the same order so as not to overweight some data moments compared to others.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">LogLikelihoodModel</span></code> function, we simply recover the values of bid rents <span class="math notranslate nohighlight">\(\Psi_{j}(s)\)</span> by inverting the theoretical formula for the amenity score, with the slight modification that we allow the utility level to adapt to the income group considered (and do not fix it to the level of the dominant income group): that way, the predicted rent <span class="math notranslate nohighlight">\(R_s\)</span> will now reflect a distinct (unobserved) bid rent for each income group <span class="math notranslate nohighlight">\(j\)</span>. Then, we define the log-likelihood as stated above.</p>
</div>
<div class="section" id="fit-on-dwelling-sizes">
<h4>Fit on dwelling sizes<a class="headerlink" href="#fit-on-dwelling-sizes" title="Permalink to this heading"></a></h4>
<p>Likewise, we can get a theoretical prediction for dwelling sizes based on the following relation (from households’ first-order optimality conditions):</p>
<div class="math notranslate nohighlight">
\[q_s = \beta \frac{\tilde{y}_s}{R_s} + (1 - \beta) q_0 R_s\]</div>
<p>This is exactly the formula given by the <code class="docutils literal notranslate"><span class="pre">CalculateDwellingSize</span></code> lambda function. In the body of the <code class="docutils literal notranslate"><span class="pre">LogLikelihoodModel</span></code> function, we choose to define <span class="math notranslate nohighlight">\(R_s\)</span> as the bid rent from the observed dominant income group to capture the indirect impact of utility levels (thereby overidentifying the amenity score), but we could directly take the observed rent level as an alternative specification. Then, assuming that the true dwelling size is linked to the predicted dwelling size through a log-normally distributed error term of mean zero (<span class="math notranslate nohighlight">\(q_s = \hat{q}_s \epsilon_{q,s}\)</span>), we obtain the associated log-likelihood with the help of the <code class="docutils literal notranslate"><span class="pre">ComputeLogLikelihood</span></code> function, as we did for the fit on exogenous amenities.</p>
</div>
<div class="section" id="smooth-optimization">
<h4>Smooth optimization<a class="headerlink" href="#smooth-optimization" title="Permalink to this heading"></a></h4>
<p>After running a discrete parameter scanning in the <code class="docutils literal notranslate"><span class="pre">estim_util_func_param</span></code> function, the <code class="docutils literal notranslate"><span class="pre">param_optim</span></code> option allows the user to run a smooth optimization procedure based on the same composite log-likelihood, starting with the estimates we just computed as an initial guess. This is done by calling on the <code class="docutils literal notranslate"><span class="pre">EstimateParametersByOptimization</span></code> function. Note that, when pinning down the values of <span class="math notranslate nohighlight">\(\beta\)</span> and <span class="math notranslate nohighlight">\(q_0\)</span>, the algorithm does not converge when setting the scores associated to dwelling sizes and income sorting to zero (directly into the <code class="docutils literal notranslate"><span class="pre">LogLikelihoodModel</span></code> function). For that reason, we set the default value of the <code class="docutils literal notranslate"><span class="pre">param_optim</span></code> option at zero and run a discrete scanning that we consider to be granular enough to estimate a precise amenity index. We therefore only recommend to use that option when allowing the <span class="math notranslate nohighlight">\(\beta\)</span> and <span class="math notranslate nohighlight">\(q_0\)</span> parameters to vary.</p>
</div>
</div>
<div class="section" id="disamenity-index">
<h3>Disamenity index<a class="headerlink" href="#disamenity-index" title="Permalink to this heading"></a></h3>
<p>The last part of the calibration procedure is done directly in the body of the <code class="docutils literal notranslate"><span class="pre">calib_nb</span></code> notebook. As we stated before, the local disamenity index associated with informal backyards and informal settlements is going to be recovered from model inversion, to proxy for unobserved disamenity factors. In other words, we are going to optimize over the value of this parameter to capture most of the residual (unexplained) component of spatial sorting into those places. This clearly improves the fit of the model, but comes at the price of empirical tractability and increases the risk of overfitting: this is the reason why we do not follow this method for other parameters when an alternative approach is available. To back up this choice, let us just say that this is not a critical factor in our simulations, and that this is also common in the literature.</p>
<p>We start by considering a constant value for each of the indices (one per informal housing type). This is also the approach taken by <span id="id50">Pfeiffer <em>et al.</em> [<a class="reference internal" href="bibliography.html#id43" title="B. Pfeiffer, C. Rabe, H. Selod, and V. Viguie. Assessing Urban Policies Using a Simulation Model with Formal and Informal Housing. World Bank Policy Research Working Paper Series, 2019.">2019</a>]</span>. We range over a discrete set of values for those parameters and select the pair that minimizes the sum of differences between total number of households in the data vs. simulation, for each housing sector of interest.</p>
<p>Then, we propose a procedure to improve the model fit further by allowing those parameters to vary with residential location. By default, we choose to run the procedure with the <code class="docutils literal notranslate"><span class="pre">location_based_calib</span></code> option set to one, but as we face a standard bias-variance trade-off when considering model fit, we allow the user to switch it off. To run it, we just disaggregate the error metric described above at the grid-cell level and start with the calibrated constant values as initial guesses for all locations. Then, we update them iteratively in proportion with the error term. We allow for a number of iterations that is large enough to reach a minimum score before the end of the algorithm.</p>
<p>Of course, even if we define values for all locations on the map, this parameter will only impact the model in zones where land is available for housing (same goes for the amenity index or expected income net of commuting costs).</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="f1"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>The type of a parameter indicates whether it is plugged as a raw value or is the outcome of a calibration process. In theory, all “user” defined parameters can be overwritten by the end user. In practice, we cannot guarantee that the model runs seamlessly for all possible changes in values. We therefore encourage the end user to ask for guidance if they would like to change a parameter that was not included in main simulation runs.</p>
</dd>
<dt class="label" id="fagri"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>See definition of developers’ profit function in <a class="reference internal" href="#functional-assumpt"><span class="std std-ref">Functional assumptions</span></a>. To obtain the formula, we plug the first-order optimality condition relative to capital into the zero profit equation. Also note that we artificially set the depreciation due to floods at zero in agricultural land / at the city edge.</p>
</dd>
<dt class="label" id="f2"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p>We are aware of the existence of formal (concrete) backyard structures but disregard their existence for the sake of model tractability and as they only represent a minority of all backyard settlements. Likewise, we know that some backyarding does occur within formal private backyards, but we choose to abstract from that margin. Also, we rationalize the exogeneity of informal settlement locations through the observation that most of them correspond to squatting on public land: they can therefore be seen as a (plausibly exogenous) land-use regulation choice (see <span id="id51">Henderson <em>et al.</em> [<a class="reference internal" href="bibliography.html#id25" title="J.V. Henderson, T. Regan, and A.J. Venables. Building the City: From Slums to a Modern Metropolis. The Review of Economic Studies, 88:1157-92, 2021.">2021</a>]</span> for an alternative model with endogenous land use).</p>
</dd>
<dt class="label" id="f3"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p>Note that there is no consensus on how to enumerate RDP/BNG dwelling units, as they are counted as formal dwelling units in census data. We draw on several data sources to estimate this number (including council housing), and then allocate the units across the grid using the CoCT’s cadastre.</p>
</dd>
<dt class="label" id="fdata"><span class="brackets"><a class="fn-backref" href="#id6">5</a></span></dt>
<dd><p>Not all the “raw” data sets (as opposed to “user” data sets that result from a calibration process and can be updated by the end user) used are actually raw data. Some of them have been pre-processed, and this explains why there are more files (used as intermediary inputs) in the projet repository than described in <a class="reference internal" href="data_sets.html"><span class="doc">Key data sets</span></a>. Some other files may be related to older versions of the model, or may have been imported jointly with other data sets. They are kept as reference and may serve for later implementations.</p>
</dd>
<dt class="label" id="fmixed"><span class="brackets"><a class="fn-backref" href="#id7">6</a></span></dt>
<dd><p>To some extent, this precludes mixed land use, which we do not see as a major issue given that the granularity of our setting allows us to approximate it finely.</p>
</dd>
<dt class="label" id="f4"><span class="brackets"><a class="fn-backref" href="#id11">7</a></span></dt>
<dd><p>More details about flood data can be found <a class="reference external" href="https://www.fathom.global/product/flood-hazard-data-maps/fathom-global/">here</a> and <a class="reference external" href="https://microsoft.github.io/AIforEarthDataSets/data/deltares-floods.html">here</a>. Typically, underlying prediction models consider past and forecasted precipitation and storms, current river levels, as well as soil and terrain conditions.</p>
</dd>
<dt class="label" id="f5"><span class="brackets"><a class="fn-backref" href="#id12">8</a></span></dt>
<dd><p>We are aware that there are other factors than maximum flood depth (such as duration and intensity) that may affect flood severity. However, partly due to data limitations, we believe that focusing on flood depth is a good first approximation.</p>
</dd>
<dt class="label" id="f6"><span class="brackets"><a class="fn-backref" href="#id15">9</a></span></dt>
<dd><p>More comments on the integration method used can be found <a class="reference external" href="https://storymaps.arcgis.com/stories/7878c89c592e4a78b45f03b4b696ccac">here</a>.</p>
</dd>
<dt class="label" id="f7"><span class="brackets"><a class="fn-backref" href="#id16">10</a></span></dt>
<dd><p>Note that we add an option to discount the most likely / less serious pluvial flood risks for formal private housing, then for formal subsidized and informal backyard structures. This is to account for the fact that such (more or less concrete) structures are better protected from run-offs, which is not an information provided by the flood maps.</p>
</dd>
<dt class="label" id="f8"><span class="brackets"><a class="fn-backref" href="#id17">11</a></span></dt>
<dd><p>For the purpose of this model, it is therefore equivalent to assume complete market insurance or self-insurance <span id="id52">[<a class="reference internal" href="bibliography.html#id35" title="P. Avner and S. Hallegatte. Moral Hazard vs. Land Scarcity: Flood Management Policies for the Real World. World Bank Policy Research Working Paper Series, 2019.">Avner and Hallegatte, 2019</a>]</span>. We may actually have an incomplete combination of the two, which we could simulate by putting weights on our two perfect-anticipations and no-anticipations polar cases. Note however that we do not model endogenous self-protection investments, and that assessing exogenous public protection investments would require custom flood maps in the spirit of <span id="id53">Avner <em>et al.</em> [<a class="reference internal" href="bibliography.html#id38" title="P. Avner, V. Viguie, B. J. Arga, and S. Hallegatte. Flood Protection and Land Value Creation - Not All Resilience Investments Are Created Equal. Economics of Disasters and Climate Change, 6(3):417-49, 2022.">2022</a>]</span>.</p>
</dd>
<dt class="label" id="active-pop"><span class="brackets"><a class="fn-backref" href="#id18">12</a></span></dt>
<dd><p>Note that, in our framework, unemployment is taken as a phenomenon that occurs part of the year (through the <code class="docutils literal notranslate"><span class="pre">household_size</span></code> parameter that defines the employment rate of a household). We therefore abstract from structural unemployment phenomena. Also note that residential choice relies on the resolution of a prior commuting choice problem. Therefore, we only simulate the spatial distribution of people that are part of the labour force (with representative households accounting for two active individuals). The underlying population data (see inputs.data.import_macro_data function) covers all households living in the city (we have no information on individuals): the reweighting procedure we follow by default therefore leads us to simulate the spatial distribution of all households as if they were active, with an equal share of inactive households allocated to each income group. If we had access to more accurate data allowing us to sample out inactive households, we could follow the alternative reweighting procedure (with the <code class="docutils literal notranslate"><span class="pre">unempl_reweight</span></code> option) that applies a different rate to each income group based on its respective (un)employment rate, since all no-income households could then be considered as unemployed. Taking the reasoning further, we could even take people “working from home” (mostly informal labourers) out of the “active” population since they do not take part in commuting either.</p>
</dd>
<dt class="label" id="f9"><span class="brackets"><a class="fn-backref" href="#id20">13</a></span></dt>
<dd><p>We remind the reader that, according to the spatial indifference hypothesis, all similar households share a common (maximum attainable) utility level in equilibrium. In the model, households only differ a priori in their income class, which is why we have a unique utility level for each income class. Intuitively, the richer the household, the bigger the utility level, as a higher income translates into a bigger choice set. If such utility levels can be compared in ordinal terms, no direct welfare assessment can be derived in cardinal terms: utilities must be converted into income equivalents first. A further remark is that income levels are a proxy for household heterogeneity in the housing market. As such, they encompass several correlated dimensions (such as race). However, we have strong evidence that residential mobility is not significantly impeded by those other factors, even within the South African context, hence our focus on income as the prime determinant of spatial sorting <span id="id54">[<a class="reference internal" href="bibliography.html#id28" title="T. Dominguez-Iino and L. le Roux. Economic Geography of Apartheid. 2022.">Dominguez-Iino and le Roux, 2022</a>]</span>. Also note that income groups could themselves be endogenized (including unemployment) to study interactions between the housing and the labor market, although we leave that for future work.</p>
</dd>
<dt class="label" id="f10"><span class="brackets"><a class="fn-backref" href="#id21">14</a></span></dt>
<dd><p>When we overestimate the population, we increase the utility level, and conversely. Indeed, a higher utility translates into a higher land consumption (all other things equal) for the same land available, hence a lower accommodable number of people.</p>
</dd>
<dt class="label" id="fcd"><span class="brackets"><a class="fn-backref" href="#id23">15</a></span></dt>
<dd><p>In a few words, the Cobb-Douglas function used for housing production is a simple analytical form that allows to model inputs that are neither perfect substitutes or perfect complements (constant elasticity of substitution equal to one) and that enter production flexibly through calibrated total factor productivity and output elasticities. As a reminder, total factor productivity is defined as the ratio of aggregate output over aggregate inputs; and output elasticities are defined as the percentage change of output divided by the percentage change of on input. The Stone-Geary form used for households’ utility relies on the same assumptions, with the added feature that the introduction of a basic need in housing allows to model non-homothetic preferences for housing: this corresponds to a declining share of budget dedicated to housing when income increases, which is a robust empirical finding. In practice, this translates into increased residential segregation, as poor households struggle to meet their basic need in housing in expensive places.</p>
</dd>
<dt class="label" id="fchoice"><span class="brackets"><a class="fn-backref" href="#id24">16</a></span></dt>
<dd><p>Note however that the size of informal backyards and informal settlements is fixed according to the value of the <code class="docutils literal notranslate"><span class="pre">shack_size</span></code> parameter. The size of formal subsidized dwellings (excluding backyard) is also fixed by the <code class="docutils literal notranslate"><span class="pre">RDP_size</span></code> parameter.</p>
</dd>
<dt class="label" id="fb"><span class="brackets"><a class="fn-backref" href="#id25">17</a></span></dt>
<dd><p>See <span id="id55">Galiani <em>et al.</em> [<a class="reference internal" href="bibliography.html#id21" title="S. Galiani, P. Gertler, R. Cooper, S. Martinez, A. Ross, and R. Undurraga. Shelter from the Storm: Upgrading Housing Infrastructure in Latin American Slums. Journal of Urban Economics, 98:187-213, 2017.">2017</a>]</span> for more details.</p>
</dd>
<dt class="label" id="fsdev"><span class="brackets"><a class="fn-backref" href="#id26">18</a></span></dt>
<dd><p>It could be that households renting out part of their backyard also provide the “shack” to live in. If we take the reasoning further, those households could even turn into mini-developers, providing structures of various sizes and materials for instance. Empirically, most of those structures are not concrete and have a rather standardized size, hence our simplifying assumptions. Also, we choose to have the dwellers pay for the structure as building costs for such non-durable housing are often closer to a flow cost of maintenance than to a sunk cost of construction (see for example <span id="id56">Henderson <em>et al.</em> [<a class="reference internal" href="bibliography.html#id25" title="J.V. Henderson, T. Regan, and A.J. Venables. Building the City: From Slums to a Modern Metropolis. The Review of Economic Studies, 88:1157-92, 2021.">2021</a>]</span>). Still, we could switch sides easily.</p>
</dd>
<dt class="label" id="fabsentee"><span class="brackets"><a class="fn-backref" href="#id27">19</a></span></dt>
<dd><p>The alternative to the absentee landlord assumption is the public ownership assumption: in that case, all housing revenues are equally shared among residents of the city. The choice is supposed to reflect the ownership structure of the city, but in practice it has little impact on its spatial structure <span id="id57">[<a class="reference internal" href="bibliography.html#id38" title="P. Avner, V. Viguie, B. J. Arga, and S. Hallegatte. Flood Protection and Land Value Creation - Not All Resilience Investments Are Created Equal. Economics of Disasters and Climate Change, 6(3):417-49, 2022.">Avner <em>et al.</em>, 2022</a>]</span>. The main difference is that we do not consider the same notions of welfare in each case.</p>
</dd>
<dt class="label" id="fconstant"><span class="brackets"><a class="fn-backref" href="#id28">20</a></span></dt>
<dd><p>Note that, in this kind of static models where prices and rents are constant over time, it is equivalent to consider choices to buy or to rent, as price is just the capitalized value of all future rent flows. We will therefore focus on housing rents only, as is standard in the literature.</p>
</dd>
<dt class="label" id="fequiv"><span class="brackets"><a class="fn-backref" href="#id29">21</a></span></dt>
<dd><p>Note that in the benchmark case with no market failure, tax equivalence results hold that the burden of added maintenance costs (that we assimilate to a tax) is shared across supply and demand, not on the basis of which side the tax applies to, but depending on their relative elasticities <span id="id58">[<a class="reference internal" href="bibliography.html#id19" title="A.J. Auerbach. Tax Equivalences and their Implications. Tax Policy and The Economy, 2019.">Auerbach, 2019</a>]</span>. Therefore, the structural assumptions made on the distribution of those costs should not have an impact on overall welfare.</p>
</dd>
<dt class="label" id="fhland"><span class="brackets"><a class="fn-backref" href="#id31">22</a></span></dt>
<dd><p>Remember that households rent housing in the formal private and subsidized sectors, but direcly rent land in the informal backyard and settlement sectors.</p>
</dd>
<dt class="label" id="fmoney-illus"><span class="brackets"><a class="fn-backref" href="#id33">23</a></span></dt>
<dd><p>This is based on the formula in <a class="reference internal" href="#equil-hsupply"><span class="std std-ref">Equilibrium housing supply</span></a>: the value of <span class="math notranslate nohighlight">\(\kappa\)</span> is updated to offset the impact on <span class="math notranslate nohighlight">\(s_{FP}(x)\)</span> of any artifical increase in <span class="math notranslate nohighlight">\(R_{FP}(x)\)</span> due to inflation.</p>
</dd>
<dt class="label" id="fcalib"><span class="brackets"><a class="fn-backref" href="#id36">24</a></span></dt>
<dd><p>In the absence of quasi-natural experiments, for such estimated parameters to be properly identified in our simulations (even for a well-specified theoretical structure), we need to assume that the variables used in the calibration are close to a long-term equilibrium at the baseline year we study (no deviations due to the durability of housing, etc.). A good robustness check would be to see how our estimates would change when running the calibration over previous periods.</p>
</dd>
<dt class="label" id="disam-index"><span class="brackets"><a class="fn-backref" href="#id39">25</a></span></dt>
<dd><p>Although it is also a utility function parameter, the local disamenity index associated with informal settlements and backyards will be calibrated separately, from model inversion (see <span id="id59">Ahlfeldt <em>et al.</em> [<a class="reference internal" href="bibliography.html#id27" title="G. Ahlfeldt, S. Redding, D. Sturm, and N. Wolf. The Economics of Density: Evidence from the Berlin Wall. Econometrica, 83(6):2127-89, 2015.">2015</a>]</span>). This is because we do not have access to the same kind of exogenous amenity data we use to calibrate the local amenity score directly.</p>
</dd>
<dt class="label" id="mle"><span class="brackets"><a class="fn-backref" href="#id40">26</a></span></dt>
<dd><p>We remind the reader that, conditional on some error term distribution, maximum likelihood estimation (MLE) consists in estimating parameters such as they maximize the probability that the posited statistical model indeed predicts the value of outcome variables. This probability is expressed as a likelihood function, which is log-linearized in practice for optimization purposes, hence our focus on log-likelihoods. Note that, contrary to MLE, OLS does not require any assumption on the error term distribution (but may be less efficient or misspecified in some cases).</p>
</dd>
<dt class="label" id="heterog"><span class="brackets"><a class="fn-backref" href="#id44">27</a></span></dt>
<dd><p>We could also adopt simpler Cobb-Douglas preferences, and calibrate the parameters separately for each income group, as in <span id="id60">Diamond and Gaubert [<a class="reference internal" href="bibliography.html#id26" title="R. Diamond and C. Gaubert. Spatial Sorting and Inequality. Annual Review of Economics, 2022.">2022</a>]</span>. The problem with such approach is that it is not properly micro-founded: we assume that different households have different income elasticities where, in fact, they just differ in income levels. The Stone-Geary specification allows to recover the observed heterogeneous expenditure shares with a single elasticity parameter, by considering housing as a necessity good. It is not only of theoretical, but also practical importance: the expenditure shares will be allowed to adapt continuously with income levels, not just across discrete income groups. More generally, adding heterogeneity dimensions increases the risk of overfitting the model, threatening its external validity for counterfactuals. In fact, we could also heterogenize the gravity parameter <span class="math notranslate nohighlight">\(\lambda\)</span> and the amenity score <span class="math notranslate nohighlight">\(A(x)\)</span> with respect to income groups, as we expect them to have different mobilities and tastes: we only recommend doing so with a strong theoretical and empirical ground.</p>
</dd>
<dt class="label" id="ces"><span class="brackets"><a class="fn-backref" href="#id46">28</a></span></dt>
<dd><p>Note that the Cobb-Douglas specification used for the housing production function is also a particular case of a more general CES function with an elasticity of substitution equal to 1. The difference with Stone-Geary preferences is that, whereas <span id="id61">Combes <em>et al.</em> [<a class="reference internal" href="bibliography.html#id33" title="P.-P. Combes, G. Duranton, and L. Gobillon. The Production Function for Housing: Evidence from France. Journal of Political Economy, 129(10):2766-816, 2021.">2021</a>]</span> do not reject a unit elasticity of substitution for housing production, <span id="id62">Finlay and Williams [<a class="reference internal" href="bibliography.html#id34" title="J. Finlay and T. Williams. Housing Demand, Inequality, and Spatial Sorting. 2022.">2022</a>]</span> do so for preferences. This is the reason why we are more confident with our structural estimation of housing production elasticities than utility function elasticities.</p>
</dd>
<dt class="label" id="mle-ols"><span class="brackets"><a class="fn-backref" href="#id49">29</a></span></dt>
<dd><p>We could alternatively run a MLE (instead of OLS estimation) and directly store the associated maximum log-likelihood, but this is equivalent for normally distributed error terms of mean zero.</p>
</dd>
</dl>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="api_ref.html" class="btn btn-neutral float-left" title="API reference" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="appendix.html" class="btn btn-neutral float-right" title="Appendix" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, The World Bank.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>