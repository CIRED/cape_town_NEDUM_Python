<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Notebook: run calibration &mdash; NEDUM-2D for CoCT  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="User guidelines" href="guidelines.html" />
    <link rel="prev" title="Notebook: run model" href="main_nb.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> NEDUM-2D for CoCT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="readme_link.html">Introducing NEDUM-2D</a></li>
<li class="toctree-l1"><a class="reference internal" href="license_rst.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="main_nb.html">Notebook: run model</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Notebook: run calibration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Preamble">Preamble</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Import-packages">Import packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Define-file-paths">Define file paths</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Create-associated-directories-if-needed">Create associated directories if needed</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Import-parameters-and-options">Import parameters and options</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#We-import-default-parameter-and-options">We import default parameter and options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#We-also-set-custom-options-for-this-simulation">We also set custom options for this simulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#We-first-set-options-regarding-structural-assumptions-used-in-the-model">We first set options regarding structural assumptions used in the model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Then-we-set-options-regarding-flood-data-used">Then we set options regarding flood data used</a></li>
<li class="toctree-l4"><a class="reference internal" href="#We-also-set-options-for-scenarios-on-time-moving-exogenous-variables">We also set options for scenarios on time-moving exogenous variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Finally,-we-set-options-regarding-data-processing">Finally, we set options regarding data processing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Load-data">Load data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Basic-geographic-data">Basic geographic data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Macro-data">Macro data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Households-and-income-data">Households and income data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Land-use-projections">Land use projections</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Import-flood-data-(takes-some-time-when-agents-anticipate-floods)">Import flood data (takes some time when agents anticipate floods)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Import-scenarios-(for-time-moving-variables)">Import scenarios (for time-moving variables)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Import-income-net-of-commuting-costs-(for-all-time-periods)">Import income net of commuting costs (for all time periods)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Prepare-data">Prepare data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Define-dominant-income-group-in-each-census-block-(SP)">Define dominant income group in each census block (SP)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Obtain-number-of-formal-private-housing-units-per-SP">Obtain number of formal private housing units per SP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Sample-selection">Sample selection</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Calibrate-construction-function-parameters">Calibrate construction function parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Calibrate-incomes-and-gravity-parameter">Calibrate incomes and gravity parameter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Let-us-first-visualize-inputs">Let us first visualize inputs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#We-visualize-the-associated-calibrated-outputs">We visualize the associated calibrated outputs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Calibrate-utility-function-parameters">Calibrate utility function parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Calibrate-disamenity-index-for-informal-backyards-+-settlements">Calibrate disamenity index for informal backyards + settlements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#We-start-with-a-general-(not-location-specific)-calibration">We start with a general (not location-specific) calibration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Calibrate-location-specific-disamenity-index">Calibrate location-specific disamenity index</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="guidelines.html">User guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_case.html">Use case</a></li>
<li class="toctree-l1"><a class="reference internal" href="technical_doc.html">Technical documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="input_tables.html">Input tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_bases.html">Data bases</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_sets.html">Data sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="math_appendix.html">Math appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_ref.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="install_help.html">Installation help</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">NEDUM-2D for CoCT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Notebook: run calibration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/calib_nb.nblink.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Notebook:-run-calibration">
<h1>Notebook: run calibration<a class="headerlink" href="#Notebook:-run-calibration" title="Permalink to this heading"></a></h1>
<div class="section" id="Preamble">
<h2>Preamble<a class="headerlink" href="#Preamble" title="Permalink to this heading"></a></h2>
<div class="section" id="Import-packages">
<h3>Import packages<a class="headerlink" href="#Import-packages" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We import standard Python libraries</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="c1"># We also import our own packages</span>
<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="kn">import</span> <span class="nn">inputs.parameters_and_options</span> <span class="k">as</span> <span class="nn">inpprm</span>
<span class="kn">import</span> <span class="nn">equilibrium.compute_equilibrium</span> <span class="k">as</span> <span class="nn">eqcmp</span>
<span class="kn">import</span> <span class="nn">equilibrium.functions_dynamic</span> <span class="k">as</span> <span class="nn">eqdyn</span>
<span class="kn">import</span> <span class="nn">calibration.calib_main_func</span> <span class="k">as</span> <span class="nn">calmain</span>
<span class="kn">import</span> <span class="nn">outputs.export_outputs</span> <span class="k">as</span> <span class="nn">outexp</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Define-file-paths">
<h3>Define file paths<a class="headerlink" href="#Define-file-paths" title="Permalink to this heading"></a></h3>
<p>This corresponds to the architecture described in the README file (introduction tab of the documentation): the data folder is not hosted on the Github repository and should be placed in the root folder enclosing the repo</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path_code</span> <span class="o">=</span> <span class="s1">&#39;..&#39;</span>
<span class="n">path_folder</span> <span class="o">=</span> <span class="n">path_code</span> <span class="o">+</span> <span class="s1">&#39;/Data/&#39;</span>
<span class="n">path_precalc_inp</span> <span class="o">=</span> <span class="n">path_folder</span> <span class="o">+</span> <span class="s1">&#39;Precalculated inputs/&#39;</span>
<span class="n">path_data</span> <span class="o">=</span> <span class="n">path_folder</span> <span class="o">+</span> <span class="s1">&#39;data_Cape_Town/&#39;</span>
<span class="n">path_precalc_transp</span> <span class="o">=</span> <span class="n">path_folder</span> <span class="o">+</span> <span class="s1">&#39;precalculated_transport/&#39;</span>
<span class="n">path_scenarios</span> <span class="o">=</span> <span class="n">path_data</span> <span class="o">+</span> <span class="s1">&#39;Scenarios/&#39;</span>
<span class="n">path_outputs</span> <span class="o">=</span> <span class="n">path_code</span> <span class="o">+</span> <span class="s1">&#39;/Output/&#39;</span>
<span class="n">path_floods</span> <span class="o">=</span> <span class="n">path_folder</span> <span class="o">+</span> <span class="s2">&quot;FATHOM/&quot;</span>
<span class="n">path_input_plots</span> <span class="o">=</span> <span class="n">path_outputs</span> <span class="o">+</span> <span class="s1">&#39;/input_plots/&#39;</span>
<span class="n">path_input_tables</span> <span class="o">=</span> <span class="n">path_outputs</span> <span class="o">+</span> <span class="s1">&#39;/input_tables/&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Create-associated-directories-if-needed">
<h3>Create associated directories if needed<a class="headerlink" href="#Create-associated-directories-if-needed" title="Permalink to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path_input_plots</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path_input_tables</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[WinError 183] Cannot create a file when that file already exists: &#39;../Output//input_plots/&#39;
[WinError 183] Cannot create a file when that file already exists: &#39;../Output//input_tables/&#39;
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Import-parameters-and-options">
<h2>Import parameters and options<a class="headerlink" href="#Import-parameters-and-options" title="Permalink to this heading"></a></h2>
<div class="section" id="We-import-default-parameter-and-options">
<h3>We import default parameter and options<a class="headerlink" href="#We-import-default-parameter-and-options" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inputs.parameters_and_options</span> <span class="k">as</span> <span class="nn">inpprm</span>
<span class="n">options</span> <span class="o">=</span> <span class="n">inpprm</span><span class="o">.</span><span class="n">import_options</span><span class="p">()</span>
<span class="n">param</span> <span class="o">=</span> <span class="n">inpprm</span><span class="o">.</span><span class="n">import_param</span><span class="p">(</span>
    <span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">path_outputs</span><span class="p">,</span> <span class="n">path_folder</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="We-also-set-custom-options-for-this-simulation">
<h3>We also set custom options for this simulation<a class="headerlink" href="#We-also-set-custom-options-for-this-simulation" title="Permalink to this heading"></a></h3>
<div class="section" id="We-first-set-options-regarding-structural-assumptions-used-in-the-model">
<h4>We first set options regarding structural assumptions used in the model<a class="headerlink" href="#We-first-set-options-regarding-structural-assumptions-used-in-the-model" title="Permalink to this heading"></a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dummy for taking floods into account in agents&#39; choices</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;agents_anticipate_floods&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># Dummy for preventing new informal settlement development</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;informal_land_constrained&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Then-we-set-options-regarding-flood-data-used">
<h4>Then we set options regarding flood data used<a class="headerlink" href="#Then-we-set-options-regarding-flood-data-used" title="Permalink to this heading"></a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dummy for taking pluvial floods into account (on top of fluvial floods)</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;pluvial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># Dummy for reducing pluvial risk for (better protected) formal structures</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_pluvial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># Dummy for taking coastal floods into account (on top of fluvial floods)</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;coastal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># Digital elevation model to be used with coastal floods (MERITDEM or NASADEM)</span>
<span class="c1"># NB: MERITDEM is also the DEM used for fluvial and pluvial flood data</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;dem&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MERITDEM&quot;</span>
<span class="c1"># Dummy for taking defended (vs. undefended) fluvial flood maps</span>
<span class="c1"># NB: FATHOM recommends to use undefended maps due to the high uncertainty</span>
<span class="c1"># in infrastructure modelling</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;defended&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># Dummy for taking sea-level rise into account in coastal flood data</span>
<span class="c1"># NB: Projections are up to 2050, based upon IPCC AR5 assessment for the</span>
<span class="c1"># RCP 8.5 scenario</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;slr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="We-also-set-options-for-scenarios-on-time-moving-exogenous-variables">
<h4>We also set options for scenarios on time-moving exogenous variables<a class="headerlink" href="#We-also-set-options-for-scenarios-on-time-moving-exogenous-variables" title="Permalink to this heading"></a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NB: Must be set to 1/2/3 for low/medium/high growth scenario</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;inc_ineq_scenario&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;pop_growth_scenario&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;fuel_price_scenario&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Finally,-we-set-options-regarding-data-processing">
<h4>Finally, we set options regarding data processing<a class="headerlink" href="#Finally,-we-set-options-regarding-data-processing" title="Permalink to this heading"></a></h4>
<p>Default is set at zero to save computing time (data is simply loaded in the model)</p>
<p>NB: this is only needed to create the data for the first time, or when the source is changed, so that pre-processed data is updated</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dummy for converting small-area-level (SAL) data into grid-level data</span>
<span class="c1"># (used for result validation)</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;convert_sal_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># Dummy for computing expected income net of commuting costs on the basis</span>
<span class="c1"># of calibrated wages</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;compute_net_income&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="Load-data">
<h2>Load data<a class="headerlink" href="#Load-data" title="Permalink to this heading"></a></h2>
<div class="section" id="Basic-geographic-data">
<h3>Basic geographic data<a class="headerlink" href="#Basic-geographic-data" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="n">grid</span><span class="p">,</span> <span class="n">center</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_grid</span><span class="p">(</span><span class="n">path_data</span><span class="p">)</span>
<span class="n">amenities</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_amenities</span><span class="p">(</span><span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
<span class="n">geo_grid</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">path_data</span> <span class="o">+</span> <span class="s2">&quot;grid_reference_500.shp&quot;</span><span class="p">)</span>
<span class="n">geo_TAZ</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">path_data</span> <span class="o">+</span> <span class="s2">&quot;TAZ_ampp_prod_attr_2013_2032.shp&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Macro-data">
<h3>Macro data<a class="headerlink" href="#Macro-data" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="p">(</span><span class="n">interest_rate</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">housing_type_data</span><span class="p">,</span> <span class="n">total_RDP</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_macro_data</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">path_scenarios</span><span class="p">,</span> <span class="n">path_folder</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Households-and-income-data">
<h3>Households and income data<a class="headerlink" href="#Households-and-income-data" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>

<span class="n">income_class_by_housing_type</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_hypothesis_housing_type</span><span class="p">()</span>

<span class="p">(</span><span class="n">mean_income</span><span class="p">,</span> <span class="n">households_per_income_class</span><span class="p">,</span> <span class="n">average_income</span><span class="p">,</span> <span class="n">income_mult</span><span class="p">,</span>
 <span class="n">income_2011</span><span class="p">,</span> <span class="n">households_per_income_and_housing</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_income_classes_data</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">path_data</span><span class="p">)</span>

<span class="c1"># NB: we create this parameter to maintain money illusion in simulations</span>
<span class="c1"># (see eqsim.run_simulation function)</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;income_year_reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_income</span>

<span class="c1"># Other data at SP (small place) level used for calibration and validation</span>
<span class="p">(</span><span class="n">data_rdp</span><span class="p">,</span> <span class="n">housing_types_sp</span><span class="p">,</span> <span class="n">data_sp</span><span class="p">,</span> <span class="n">mitchells_plain_grid_2011</span><span class="p">,</span>
 <span class="n">grid_formal_density_HFA</span><span class="p">,</span> <span class="n">threshold_income_distribution</span><span class="p">,</span> <span class="n">income_distribution</span><span class="p">,</span>
 <span class="n">cape_town_limits</span><span class="p">)</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_households_data</span><span class="p">(</span><span class="n">path_precalc_inp</span><span class="p">)</span>

<span class="c1"># Import nb of households per pixel, by housing type (from SAL data)</span>
<span class="c1"># NB: RDP housing is included in formal, and there are both formal and informal</span>
<span class="c1"># backyards</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;convert_sal_data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">housing_types</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_sal_data</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">path_folder</span><span class="p">,</span> <span class="n">path_data</span><span class="p">,</span>
                                          <span class="n">housing_type_data</span><span class="p">)</span>
<span class="n">housing_types</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">path_folder</span> <span class="o">+</span> <span class="s1">&#39;housing_types_grid_sal.xlsx&#39;</span><span class="p">)</span>
<span class="n">housing_types</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">housing_types</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Land-use-projections">
<h3>Land use projections<a class="headerlink" href="#Land-use-projections" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We import basic projections</span>
<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="p">(</span><span class="n">spline_RDP</span><span class="p">,</span> <span class="n">spline_estimate_RDP</span><span class="p">,</span> <span class="n">spline_land_RDP</span><span class="p">,</span>
 <span class="n">spline_land_backyard</span><span class="p">,</span> <span class="n">spline_land_informal</span><span class="p">,</span> <span class="n">spline_land_constraints</span><span class="p">,</span>
 <span class="n">number_properties_RDP</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
     <span class="n">inpdt</span><span class="o">.</span><span class="n">import_land_use</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">data_rdp</span><span class="p">,</span> <span class="n">housing_types</span><span class="p">,</span>
                           <span class="n">housing_type_data</span><span class="p">,</span> <span class="n">path_data</span><span class="p">,</span> <span class="n">path_folder</span><span class="p">)</span>
     <span class="p">)</span>

<span class="c1"># We correct areas for each housing type at baseline year for the amount of</span>
<span class="c1"># constructible land in each type</span>
<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="n">coeff_land</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_coeff_land</span><span class="p">(</span>
    <span class="n">spline_land_constraints</span><span class="p">,</span> <span class="n">spline_land_backyard</span><span class="p">,</span> <span class="n">spline_land_informal</span><span class="p">,</span>
    <span class="n">spline_land_RDP</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># We import housing heigth limits</span>
<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="n">housing_limit</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_housing_limit</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>

<span class="c1"># We update parameter vector with construction parameters</span>
<span class="c1"># (relies on loaded data) and compute other variables</span>
<span class="kn">import</span> <span class="nn">inputs.parameters_and_options</span> <span class="k">as</span> <span class="nn">inpprm</span>
<span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">minimum_housing_supply</span><span class="p">,</span> <span class="n">agricultural_rent</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">inpprm</span><span class="o">.</span><span class="n">import_construction_parameters</span><span class="p">(</span>
    <span class="n">param</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">housing_types_sp</span><span class="p">,</span> <span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;dwelling_size&quot;</span><span class="p">],</span>
    <span class="n">mitchells_plain_grid_2011</span><span class="p">,</span> <span class="n">grid_formal_density_HFA</span><span class="p">,</span> <span class="n">coeff_land</span><span class="p">,</span>
    <span class="n">interest_rate</span><span class="p">,</span> <span class="n">options</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Import-flood-data-(takes-some-time-when-agents-anticipate-floods)">
<h3>Import flood data (takes some time when agents anticipate floods)<a class="headerlink" href="#Import-flood-data-(takes-some-time-when-agents-anticipate-floods)" title="Permalink to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># If agents anticipate floods, we return output from damage functions</span>
<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;agents_anticipate_floods&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="p">(</span><span class="n">fraction_capital_destroyed</span><span class="p">,</span> <span class="n">structural_damages_small_houses</span><span class="p">,</span>
     <span class="n">structural_damages_medium_houses</span><span class="p">,</span> <span class="n">structural_damages_large_houses</span><span class="p">,</span>
     <span class="n">content_damages</span><span class="p">,</span> <span class="n">structural_damages_type1</span><span class="p">,</span> <span class="n">structural_damages_type2</span><span class="p">,</span>
     <span class="n">structural_damages_type3a</span><span class="p">,</span> <span class="n">structural_damages_type3b</span><span class="p">,</span>
     <span class="n">structural_damages_type4a</span><span class="p">,</span> <span class="n">structural_damages_type4b</span>
     <span class="p">)</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_full_floods_data</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">path_folder</span><span class="p">,</span>
                                       <span class="n">housing_type_data</span><span class="p">)</span>

<span class="c1"># Else, we set those outputs as zero</span>
<span class="c1"># NB: 24014 is the number of grid pixels</span>
<span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;agents_anticipate_floods&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">fraction_capital_destroyed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_formal_2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_formal_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_subsidized_2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_subsidized_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;contents_formal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;contents_informal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;contents_subsidized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;contents_backyard&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_backyards&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_formal_backyards&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_informal_backyards&quot;</span>
                               <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_informal_settlements&quot;</span>
                               <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
FU_5yr
FU_10yr
FU_20yr
FU_50yr
FU_75yr
FU_100yr
FU_200yr
FU_250yr
FU_500yr
FU_1000yr
P_5yr
P_10yr
P_20yr
P_50yr
P_75yr
P_100yr
P_200yr
P_250yr
P_500yr
P_1000yr
C_MERITDEM_1_0000
C_MERITDEM_1_0002
C_MERITDEM_1_0005
C_MERITDEM_1_0010
C_MERITDEM_1_0025
C_MERITDEM_1_0050
C_MERITDEM_1_0100
C_MERITDEM_1_0250
Contents in private formal
Contents in informal settlements
Contents in (any) backyard
Contents in formal subsidized
Private formal structures (one floor)
Private formal structures (two floors)
Formal subsidized structures (one floor)
Formal subsidized structures (two floors)
Informal settlement structures
Informal backyard structures
Formal backyard structures (one floor)
Formal backyard structures (two floors)
</pre></div></div>
</div>
</div>
<div class="section" id="Import-scenarios-(for-time-moving-variables)">
<h3>Import scenarios (for time-moving variables)<a class="headerlink" href="#Import-scenarios-(for-time-moving-variables)" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">equilibrium.functions_dynamic</span> <span class="k">as</span> <span class="nn">eqdyn</span>
<span class="p">(</span><span class="n">spline_agricultural_rent</span><span class="p">,</span> <span class="n">spline_interest_rate</span><span class="p">,</span>
 <span class="n">spline_population_income_distribution</span><span class="p">,</span> <span class="n">spline_inflation</span><span class="p">,</span>
 <span class="n">spline_income_distribution</span><span class="p">,</span> <span class="n">spline_population</span><span class="p">,</span>
 <span class="n">spline_income</span><span class="p">,</span> <span class="n">spline_minimum_housing_supply</span><span class="p">,</span> <span class="n">spline_fuel</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">eqdyn</span><span class="o">.</span><span class="n">import_scenarios</span><span class="p">(</span><span class="n">income_2011</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">path_scenarios</span><span class="p">,</span>
                            <span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Import-income-net-of-commuting-costs-(for-all-time-periods)">
<h3>Import income net of commuting costs (for all time periods)<a class="headerlink" href="#Import-income-net-of-commuting-costs-(for-all-time-periods)" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;compute_net_income&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="p">(</span><span class="n">incomeNetOfCommuting</span><span class="p">,</span> <span class="n">modalShares</span><span class="p">,</span> <span class="n">ODflows</span><span class="p">,</span> <span class="n">averageIncome</span>
     <span class="p">)</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_transport_data</span><span class="p">(</span>
         <span class="n">grid</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">households_per_income_class</span><span class="p">,</span> <span class="n">average_income</span><span class="p">,</span>
         <span class="n">spline_inflation</span><span class="p">,</span> <span class="n">spline_fuel</span><span class="p">,</span>
         <span class="n">spline_population_income_distribution</span><span class="p">,</span> <span class="n">spline_income_distribution</span><span class="p">,</span>
         <span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">path_precalc_transp</span><span class="p">,</span> <span class="s1">&#39;GRID&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

<span class="n">income_net_of_commuting_costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="n">path_precalc_transp</span> <span class="o">+</span> <span class="s1">&#39;GRID_incomeNetOfCommuting_0.npy&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Prepare-data">
<h2>Prepare data<a class="headerlink" href="#Prepare-data" title="Permalink to this heading"></a></h2>
<div class="section" id="Define-dominant-income-group-in-each-census-block-(SP)">
<h3>Define dominant income group in each census block (SP)<a class="headerlink" href="#Define-dominant-income-group-in-each-census-block-(SP)" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In one case, we base our definition on the median income at the SP-level:</span>
<span class="c1"># we consider as dominant the group corresponding to the highest income</span>
<span class="c1"># threshold is crossed</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_dominant_incgrp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">data_income_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;income&quot;</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;nb_of_income_classes&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">data_income_group</span><span class="p">[</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;income&quot;</span><span class="p">]</span> <span class="o">&gt;</span>
                          <span class="n">threshold_income_distribution</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>

<span class="c1"># In the other case, we just consider the most numerous income group in each</span>
<span class="c1"># census block</span>
<span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_dominant_incgrp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">data_income_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">income_distribution</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">income_distribution</span><span class="p">)):</span>
        <span class="n">data_income_group</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">income_distribution</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Although the second option seems more logical, we take the first one as default since we are going to consider median SP prices, and we want associated net income to be in line with those values to avoid a sample selection bias in our regressions.</p>
</div>
<div class="section" id="Obtain-number-of-formal-private-housing-units-per-SP">
<h3>Obtain number of formal private housing units per SP<a class="headerlink" href="#Obtain-number-of-formal-private-housing-units-per-SP" title="Permalink to this heading"></a></h3>
<p>NB: it is not clear whether RDP are included in SP formal count, and if they should be taken out based on imperfect cadastral estimations. For reference, we include the two options.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;substract_RDP_from_formal&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="c1"># We retrieve number of RDP units per SP from grid-level data</span>
    <span class="n">grid_intersect</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_data</span> <span class="o">+</span> <span class="s1">&#39;grid_SP_intersect.csv&#39;</span><span class="p">,</span>
                                 <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    <span class="c1"># When pixels are associated to several SPs, we allocate them to the</span>
    <span class="c1"># one with the biggest intersection area.</span>
    <span class="c1"># NB: it would be more rigorous to split the number of RDP across</span>
    <span class="c1"># SPs according to their respective intersection areas, but this is</span>
    <span class="c1"># unlikely to change much</span>
    <span class="n">grid_intersect</span> <span class="o">=</span> <span class="n">grid_intersect</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;ID_grille&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="s1">&#39;Area&#39;</span><span class="p">)</span>
    <span class="n">data_rdp</span><span class="p">[</span><span class="s2">&quot;ID_grille&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_rdp</span><span class="o">.</span><span class="n">index</span>
    <span class="n">data_rdp</span><span class="p">[</span><span class="s2">&quot;ID_grille&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_rdp</span><span class="p">[</span><span class="s2">&quot;ID_grille&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">rdp_grid</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_rdp</span><span class="p">,</span> <span class="n">grid_intersect</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;ID_grille&quot;</span><span class="p">,</span>
                        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>
    <span class="n">rdp_sp</span> <span class="o">=</span> <span class="n">rdp_grid</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;SP_CODE&#39;</span><span class="p">)[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">rdp_sp</span> <span class="o">=</span> <span class="n">rdp_sp</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">rdp_sp</span> <span class="o">=</span> <span class="n">rdp_sp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;SP_CODE&#39;</span><span class="p">:</span> <span class="s1">&#39;sp_code&#39;</span><span class="p">})</span>
    <span class="c1"># We just fill the list with unmatched SPs to get the full SP vector</span>
    <span class="n">rdp_sp_fill</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">rdp_sp</span><span class="p">,</span> <span class="n">data_sp</span><span class="p">[</span><span class="s1">&#39;sp_code&#39;</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;sp_code&quot;</span><span class="p">,</span>
                           <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>
    <span class="n">rdp_sp_fill</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdp_sp_fill</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rdp_sp_fill</span> <span class="o">=</span> <span class="n">rdp_sp_fill</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;sp_code&#39;</span><span class="p">)</span>

    <span class="n">data_number_formal</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">total_dwellings_SP_2011</span>
        <span class="o">-</span> <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">backyard_SP_2011</span>
        <span class="o">-</span> <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">informal_SP_2011</span>
        <span class="o">-</span> <span class="n">rdp_sp_fill</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>

<span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;substract_RDP_from_formal&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">data_number_formal</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">total_dwellings_SP_2011</span>
        <span class="o">-</span> <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">backyard_SP_2011</span>
        <span class="o">-</span> <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">informal_SP_2011</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<p>Given the uncertainty surrounding RDP counts, we take the second option as default and prefer to rely on sample selection (see below) to exclude the SPs where RDP housing is likely to drive most of our results</p>
</div>
<div class="section" id="Sample-selection">
<h3>Sample selection<a class="headerlink" href="#Sample-selection" title="Permalink to this heading"></a></h3>
<p>As the relations we are going to estimate are only true for the formal private sector, we exclude SPs in the bottom quintile of property prices and for which more than 5% of households are reported to live in informal housing (settlements + backyards). We also exclude “rural” SPs (i.e., those that are large, with a small share than can be urbanized).</p>
<p>We also add options to consider other criteria, namely we offer to exclude poorest income group (which is in effect crowded out from the formal sector), as well as Mitchell’s Plain (as its housing market is very specific) and far-away land (for which we have few observations).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_selected_density&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">selected_density</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="mf">0.2</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_number_formal</span>
           <span class="o">&gt;</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">total_dwellings_SP_2011</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">]</span>
            <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">],</span> <span class="mf">0.8</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">])</span>
        <span class="p">)</span>

<span class="k">elif</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_selected_density&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_mitchells_plain&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">selected_density</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="mf">0.2</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_number_formal</span>
           <span class="o">&gt;</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">total_dwellings_SP_2011</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">]</span>
            <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">],</span> <span class="mf">0.8</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">])</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_income_group</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span>
        <span class="p">)</span>

<span class="k">elif</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_selected_density&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_mitchells_plain&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">selected_density</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="mf">0.2</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_number_formal</span>
           <span class="o">&gt;</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">total_dwellings_SP_2011</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">]</span>
            <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">],</span> <span class="mf">0.8</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">])</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_income_group</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;mitchells_plain&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<p>We pick the second choice as our default since it is more conservative than the first, and less ad hoc than the third one.</p>
</div>
</div>
<div class="section" id="Calibrate-construction-function-parameters">
<h2>Calibrate construction function parameters<a class="headerlink" href="#Calibrate-construction-function-parameters" title="Permalink to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We estimate construction function parameters based on a log-linearization</span>
<span class="c1"># of the housing market clearing condition</span>
<span class="kn">import</span> <span class="nn">calibration.calib_main_func</span> <span class="k">as</span> <span class="nn">calmain</span>
<span class="n">coeff_b</span><span class="p">,</span> <span class="n">coeff_a</span><span class="p">,</span> <span class="n">coeffKappa</span> <span class="o">=</span> <span class="n">calmain</span><span class="o">.</span><span class="n">estim_construct_func_param</span><span class="p">(</span>
    <span class="n">options</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">data_sp</span><span class="p">,</span> <span class="n">threshold_income_distribution</span><span class="p">,</span>
    <span class="n">income_distribution</span><span class="p">,</span> <span class="n">data_rdp</span><span class="p">,</span> <span class="n">housing_types_sp</span><span class="p">,</span>
    <span class="n">data_number_formal</span><span class="p">,</span> <span class="n">data_income_group</span><span class="p">,</span> <span class="n">selected_density</span><span class="p">,</span>
    <span class="n">path_data</span><span class="p">,</span> <span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">path_folder</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
                            OLS Regression Results
==============================================================================
Dep. Variable:                      y   R-squared:                       0.665
Model:                            OLS   Adj. R-squared:                  0.657
Method:                 Least Squares   F-statistic:                     89.87
Date:                Fri, 23 Sep 2022   Prob (F-statistic):           4.10e-32
Time:                        12:45:21   Log-Likelihood:                -52.613
No. Observations:                 140   AIC:                             113.2
Df Residuals:                     136   BIC:                             125.0
Df Model:                           3
Covariance Type:            nonrobust
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
const         -3.7633      0.981     -3.837      0.000      -5.703      -1.824
x1             0.2415      0.069      3.483      0.001       0.104       0.379
x2            -0.8950      0.094     -9.533      0.000      -1.081      -0.709
x3             0.9949      0.070     14.283      0.000       0.857       1.133
==============================================================================
Omnibus:                       50.298   Durbin-Watson:                   1.587
Prob(Omnibus):                  0.000   Jarque-Bera (JB):              164.414
Skew:                          -1.329   Prob(JB):                     1.99e-36
Kurtosis:                       7.596   Cond. No.                         514.
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
[WinError 183] Cannot create a file when that file already exists: &#39;../Data/Precalculated inputs/&#39;
</pre></div></div>
</div>
<p>NB: The results are automatically saved for later use in simulations</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We update parameter vector</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_a&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeff_a</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_b&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeff_b</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeffKappa</span>

<span class="c1"># We print the calibrated values</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coeff_a = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_a&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coeff_b = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_b&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coeff_A = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_A&quot;</span><span class="p">]))</span>

<span class="c1"># We save them</span>
<span class="c1"># NB: coeff_a = 1 - coeff_b</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;calibratedHousing_b.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_b&quot;</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;calibratedHousing_kappa.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_A&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
coeff_a = 0.758489277045013
coeff_b = 0.241510722954987
coeff_A = 0.030595011996082885
</pre></div></div>
</div>
</div>
<div class="section" id="Calibrate-incomes-and-gravity-parameter">
<h2>Calibrate incomes and gravity parameter<a class="headerlink" href="#Calibrate-incomes-and-gravity-parameter" title="Permalink to this heading"></a></h2>
<p>We scan values for the gravity parameter to estimate incomes as a function of it. The value range is set by trial and error: the wider the range you want to test, the longer. In principle, we should find a value within a coarse interval before going to the finer level: this may require several iterations if the underlying data changes.</p>
<p>NB: we do that as it is too long and complex to run a solver directly.</p>
<p>Then, we select the income-gravity pair that best fits the distribution of commuters over distance from the CBD.</p>
<p>NB: we need to proceed in two steps as there is no separate identification of the gravity parameter and the net incomes.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We start by selecting the range over which we want to scan</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;scan_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rough&quot;</span><span class="p">:</span>
    <span class="n">list_lambda</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.51</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;scan_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
    <span class="n">list_lambda</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.42</span><span class="p">,</span> <span class="mf">0.441</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;scan_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fine&quot;</span><span class="p">:</span>
    <span class="n">list_lambda</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.427</span><span class="p">,</span> <span class="mf">0.4291</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We then run the function that returns the calibrated outputs</span>
<span class="kn">import</span> <span class="nn">calibration.calib_main_func</span> <span class="k">as</span> <span class="nn">calmain</span>
<span class="p">(</span><span class="n">incomeCentersKeep</span><span class="p">,</span> <span class="n">lambdaKeep</span><span class="p">,</span> <span class="n">cal_avg_income</span><span class="p">,</span> <span class="n">scoreKeep</span><span class="p">,</span>
 <span class="n">bhattacharyyaDistances</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">calmain</span><span class="o">.</span><span class="n">estim_incomes_and_gravity</span><span class="p">(</span>
        <span class="n">param</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">list_lambda</span><span class="p">,</span> <span class="n">households_per_income_class</span><span class="p">,</span>
        <span class="n">average_income</span><span class="p">,</span> <span class="n">income_distribution</span><span class="p">,</span> <span class="n">spline_inflation</span><span class="p">,</span> <span class="n">spline_fuel</span><span class="p">,</span>
        <span class="n">spline_population_income_distribution</span><span class="p">,</span> <span class="n">spline_income_distribution</span><span class="p">,</span>
        <span class="n">path_data</span><span class="p">,</span> <span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">path_precalc_transp</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Estimating for lambda =  2.673006408663311
incomes for group  0
 - max iteration reached - mean error 0.0006624700558935639
incomes for group  1
 - max iteration reached - mean error 0.0005235262734921129
incomes for group  2
 - max iteration reached - mean error 0.0002078651226041427
incomes for group  3
 - max iteration reached - mean error 0.07736566807365537
Estimating for lambda =  2.679168324819032
incomes for group  0
 - max iteration reached - mean error 0.0006656752480600432
incomes for group  1
 - max iteration reached - mean error 0.0005238922833288978
incomes for group  2
 - max iteration reached - mean error 0.00020713382723845457
incomes for group  3
 - max iteration reached - mean error 0.07737078820051123
Estimating for lambda =  2.685344445658507
incomes for group  0
 - max iteration reached - mean error 0.0006688967994940419
incomes for group  1
 - max iteration reached - mean error 0.000524258736779616
incomes for group  2
 - max iteration reached - mean error 0.00020640488375267075
incomes for group  3
 - max iteration reached - mean error 0.07737683643195799
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We update the parameter vector</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lambdaKeep</span><span class="p">)</span>

<span class="c1"># We print the calibrated values (when possible)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lambda = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">]))</span>

<span class="c1"># We save them</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;lambdaKeep.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;incomeCentersKeep.npy&#39;</span><span class="p">,</span>
        <span class="n">incomeCentersKeep</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
lambda = 2.679168324819032
</pre></div></div>
</div>
<p>Note that incomes are fitted to reproduce the observed distribution of jobs across income groups (in selected job centers), based on commuting choice model.</p>
<div class="section" id="Let-us-first-visualize-inputs">
<h3>Let us first visualize inputs<a class="headerlink" href="#Let-us-first-visualize-inputs" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We import the employment data at the TAZ (transport zone) level</span>
<span class="kn">import</span> <span class="nn">outputs.export_outputs</span> <span class="k">as</span> <span class="nn">outexp</span>
<span class="n">jobsTable</span><span class="p">,</span> <span class="n">selected_centers</span> <span class="o">=</span> <span class="n">outexp</span><span class="o">.</span><span class="n">import_employment_geodata</span><span class="p">(</span>
    <span class="n">households_per_income_class</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">path_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Then, we visualize number of jobs for income group 1</span>
<span class="n">jobs_poor_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geo_TAZ</span><span class="p">,</span> <span class="n">jobsTable</span><span class="p">[</span><span class="s2">&quot;poor_jobs&quot;</span><span class="p">],</span>
                        <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">jobs_poor_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jobs_poor_2d</span><span class="p">,</span> <span class="n">selected_centers</span><span class="p">,</span>
                        <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">jobs_poor_2d</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="n">path_input_tables</span> <span class="o">+</span> <span class="s1">&#39;jobs_poor&#39;</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
<span class="n">jobs_poor_2d_select</span> <span class="o">=</span> <span class="n">jobs_poor_2d</span><span class="p">[</span>
    <span class="p">(</span><span class="n">jobs_poor_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3740000</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">jobs_poor_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10000</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">jobs_poor_2d_select</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">jobs_poor_2d_select</span><span class="p">[</span><span class="s2">&quot;selected_centers&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;jobs_poor&#39;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Number of poor jobs in selected job centers (data)&quot;</span><span class="p">)</span>
<span class="n">jobs_poor_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;poor_jobs&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                         <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;jobs_poor_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;jobs_poor_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_62_0.png" src="_images/calib_nb_62_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Then for income group 2</span>
<span class="n">jobs_midpoor_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geo_TAZ</span><span class="p">,</span> <span class="n">jobsTable</span><span class="p">[</span><span class="s2">&quot;midpoor_jobs&quot;</span><span class="p">],</span>
                           <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">jobs_midpoor_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jobs_midpoor_2d</span><span class="p">,</span> <span class="n">selected_centers</span><span class="p">,</span>
                           <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># jobs_midpoor_2d.to_file(path_tables + &#39;jobs_midpoor&#39; + &#39;.shp&#39;)</span>
<span class="n">jobs_midpoor_2d</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="n">path_input_tables</span> <span class="o">+</span> <span class="s1">&#39;jobs_midpoor&#39;</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
<span class="n">jobs_midpoor_2d_select</span> <span class="o">=</span> <span class="n">jobs_midpoor_2d</span><span class="p">[</span>
    <span class="p">(</span><span class="n">jobs_midpoor_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3740000</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">jobs_midpoor_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10000</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">jobs_midpoor_2d_select</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">jobs_midpoor_2d_select</span><span class="p">[</span><span class="s2">&quot;selected_centers&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;jobs_midpoor&#39;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Number of midpoor jobs in selected job centers (data)&quot;</span><span class="p">)</span>
<span class="n">jobs_midpoor_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;midpoor_jobs&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;jobs_midpoor_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;jobs_midpoor_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_63_0.png" src="_images/calib_nb_63_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For income group 3</span>
<span class="n">jobs_midrich_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geo_TAZ</span><span class="p">,</span> <span class="n">jobsTable</span><span class="p">[</span><span class="s2">&quot;midrich_jobs&quot;</span><span class="p">],</span>
                           <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">jobs_midrich_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jobs_midrich_2d</span><span class="p">,</span> <span class="n">selected_centers</span><span class="p">,</span>
                           <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># jobs_midrich_2d.to_file(path_tables + &#39;jobs_midrich&#39; + &#39;.shp&#39;)</span>
<span class="n">jobs_midrich_2d</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="n">path_input_tables</span> <span class="o">+</span> <span class="s1">&#39;jobs_midrich&#39;</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
<span class="n">jobs_midrich_2d_select</span> <span class="o">=</span> <span class="n">jobs_midrich_2d</span><span class="p">[</span>
    <span class="p">(</span><span class="n">jobs_midrich_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3740000</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">jobs_midrich_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10000</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">jobs_midrich_2d_select</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">jobs_midrich_2d_select</span><span class="p">[</span><span class="s2">&quot;selected_centers&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;jobs_midrich&#39;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Number of midrich jobs in selected job centers (data)&quot;</span><span class="p">)</span>
<span class="n">jobs_midrich_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;midrich_jobs&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;jobs_midrich_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;jobs_midrich_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_64_0.png" src="_images/calib_nb_64_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For income group 4</span>
<span class="n">jobs_rich_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geo_TAZ</span><span class="p">,</span> <span class="n">jobsTable</span><span class="p">[</span><span class="s2">&quot;rich_jobs&quot;</span><span class="p">],</span>
                        <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">jobs_rich_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jobs_rich_2d</span><span class="p">,</span> <span class="n">selected_centers</span><span class="p">,</span>
                        <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># jobs_rich_2d.to_file(path_tables + &#39;jobs_rich&#39; + &#39;.shp&#39;)</span>
<span class="n">jobs_rich_2d</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="n">path_input_tables</span> <span class="o">+</span> <span class="s1">&#39;jobs_rich&#39;</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
<span class="n">jobs_rich_2d_select</span> <span class="o">=</span> <span class="n">jobs_rich_2d</span><span class="p">[</span>
    <span class="p">(</span><span class="n">jobs_rich_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3740000</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">jobs_rich_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10000</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">jobs_rich_2d_select</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">jobs_rich_2d_select</span><span class="p">[</span><span class="s2">&quot;selected_centers&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;jobs_rich&#39;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Number of rich jobs in selected job centers (data)&quot;</span><span class="p">)</span>
<span class="n">jobs_rich_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;rich_jobs&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                         <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;jobs_rich_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;jobs_rich_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_65_0.png" src="_images/calib_nb_65_0.png" />
</div>
</div>
</div>
<div class="section" id="We-visualize-the-associated-calibrated-outputs">
<h3>We visualize the associated calibrated outputs<a class="headerlink" href="#We-visualize-the-associated-calibrated-outputs" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We first load and rearrange the data that we just computed</span>
<span class="n">income_centers_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;incomeCentersKeep.npy&#39;</span><span class="p">)</span>
<span class="n">income_centers_init</span><span class="p">[</span><span class="n">income_centers_init</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">income_centers_init_merge</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">income_centers_init</span><span class="p">)</span>
<span class="n">income_centers_init_merge</span> <span class="o">=</span> <span class="n">income_centers_init_merge</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">income_centers_init_merge</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="s1">&#39;poor_income&#39;</span><span class="p">,</span>
             <span class="n">income_centers_init_merge</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="s1">&#39;midpoor_income&#39;</span><span class="p">,</span>
             <span class="n">income_centers_init_merge</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="s1">&#39;midrich_income&#39;</span><span class="p">,</span>
             <span class="n">income_centers_init_merge</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="s1">&#39;rich_income&#39;</span><span class="p">})</span>
<span class="n">income_centers_init_merge</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">income_centers_init_merge</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We prepare, execute, and clean the merge with geographic grid</span>
<span class="n">selected_centers_merge</span> <span class="o">=</span> <span class="n">selected_centers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="p">(</span><span class="n">selected_centers_merge</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">selected_centers_merge</span><span class="o">.</span><span class="n">selected_centers</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<span class="n">selected_centers_merge</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">selected_centers_merge</span><span class="o">.</span><span class="n">selected_centers</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">income_centers_TAZ</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">income_centers_init_merge</span><span class="p">,</span>
                              <span class="n">selected_centers_merge</span><span class="p">,</span>
                              <span class="n">how</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
<span class="n">income_centers_TAZ</span> <span class="o">=</span> <span class="n">income_centers_TAZ</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">income_centers_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geo_TAZ</span><span class="p">,</span> <span class="n">income_centers_TAZ</span><span class="p">,</span>
                             <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">income_centers_2d</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="n">path_input_tables</span> <span class="o">+</span> <span class="s1">&#39;income_centers_2d&#39;</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>

<span class="n">income_centers_2d_select</span> <span class="o">=</span> <span class="n">income_centers_2d</span><span class="p">[</span>
    <span class="p">(</span><span class="n">income_centers_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3740000</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">income_centers_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10000</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We then visualize calibrated incomes for income group 1</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Average calibrated incomes per job center for poor households&quot;</span><span class="p">)</span>
<span class="n">income_centers_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;poor_income&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                              <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;poor_income_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;poor_income_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_69_0.png" src="_images/calib_nb_69_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For income group 2</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Average calibrated incomes per job center for mid-poor households&quot;</span><span class="p">)</span>
<span class="n">income_centers_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;midpoor_income&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                              <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;midpoor_income_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;midpoor_income_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_70_0.png" src="_images/calib_nb_70_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For income group 3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Average calibrated incomes per job center for mid-rich households&quot;</span><span class="p">)</span>
<span class="n">income_centers_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;midrich_income&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                              <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;midrich_income_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;midrich_income_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_71_0.png" src="_images/calib_nb_71_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For income group 4</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Average calibrated incomes per job center for rich households&quot;</span><span class="p">)</span>
<span class="n">income_centers_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;rich_income&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                              <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;rich_income_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;rich_income_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_72_0.png" src="_images/calib_nb_72_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Calibrate-utility-function-parameters">
<h2>Calibrate utility function parameters<a class="headerlink" href="#Calibrate-utility-function-parameters" title="Permalink to this heading"></a></h2>
<p>We compute local incomes net of commuting costs at the SP (not grid) level that is used in calibration.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note that lambda and calibrated incomes have an impact here: from now on,</span>
<span class="c1"># we will stop loading precalibrated parameters to rely on the newly</span>
<span class="c1"># calibrated parameters that we just saved</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;load_precal_param&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="p">(</span><span class="n">incomeNetOfCommuting</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_transport_data</span><span class="p">(</span>
     <span class="n">grid</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">households_per_income_class</span><span class="p">,</span> <span class="n">average_income</span><span class="p">,</span>
     <span class="n">spline_inflation</span><span class="p">,</span> <span class="n">spline_fuel</span><span class="p">,</span>
     <span class="n">spline_population_income_distribution</span><span class="p">,</span> <span class="n">spline_income_distribution</span><span class="p">,</span>
     <span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">path_precalc_transp</span><span class="p">,</span> <span class="s1">&#39;SP&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then we calibrate utility function parameters based on the maximization of a composite likelihood that reproduces the fit on exogenous amenities, dwelling sizes, and income sorting.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NB: Here, we also have an impact from construction parameters and sample</span>
<span class="c1"># selection (+ number of formal units)</span>
<span class="kn">import</span> <span class="nn">calibration.calib_main_func</span> <span class="k">as</span> <span class="nn">calmain</span>
<span class="p">(</span><span class="n">calibratedUtility_beta</span><span class="p">,</span> <span class="n">calibratedUtility_q0</span><span class="p">,</span> <span class="n">cal_amenities</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">calmain</span><span class="o">.</span><span class="n">estim_util_func_param</span><span class="p">(</span>
     <span class="n">data_number_formal</span><span class="p">,</span> <span class="n">data_income_group</span><span class="p">,</span> <span class="n">housing_types_sp</span><span class="p">,</span> <span class="n">data_sp</span><span class="p">,</span>
     <span class="n">coeff_a</span><span class="p">,</span> <span class="n">coeff_b</span><span class="p">,</span> <span class="n">coeffKappa</span><span class="p">,</span> <span class="n">interest_rate</span><span class="p">,</span>
     <span class="n">incomeNetOfCommuting</span><span class="p">,</span> <span class="n">selected_density</span><span class="p">,</span> <span class="n">path_data</span><span class="p">,</span> <span class="n">path_precalc_inp</span><span class="p">,</span>
     <span class="n">options</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Done:
0
1
2
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4135075811199389978199064576.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4151181453875466981517295616.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4164405745802764940939886592.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4175314171060144829827645440.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4184350814514795725147078656.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
3
4
5
6
7
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4191866421404378334391959552.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4198139653459922484067303424.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4203393215966142488079499264.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
8
9
10
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4207806130058528315060256768.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4211523109752039516105867264.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4214661761741174136966742016.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274

Scanning complete


                            OLS Regression Results
==============================================================================
Dep. Variable:                      y   R-squared:                       0.115
Model:                            OLS   Adj. R-squared:                  0.088
Method:                 Least Squares   F-statistic:                     4.281
Date:                Wed, 21 Sep 2022   Prob (F-statistic):           3.04e-05
Time:                        18:21:56   Log-Likelihood:                -4.0681
No. Observations:                 307   AIC:                             28.14
Df Residuals:                     297   BIC:                             65.40
Df Model:                           9
Covariance Type:            nonrobust
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
const          0.4173      0.039     10.587      0.000       0.340       0.495
x1             0.1299      0.042      3.068      0.002       0.047       0.213
x2             0.0495      0.047      1.050      0.294      -0.043       0.142
x3             0.1614      0.035      4.612      0.000       0.093       0.230
x4             0.1612      0.050      3.220      0.001       0.063       0.260
x5            -0.0304      0.069     -0.443      0.658      -0.165       0.105
x6             0.0208      0.045      0.467      0.641      -0.067       0.108
x7             0.0576      0.039      1.473      0.142      -0.019       0.135
x8             0.0588      0.036      1.629      0.104      -0.012       0.130
x9            -0.0096      0.053     -0.180      0.857      -0.115       0.095
==============================================================================
Omnibus:                      198.009   Durbin-Watson:                   1.238
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             1700.919
Skew:                          -2.619   Prob(JB):                         0.00
Kurtosis:                      13.273   Cond. No.                         6.56
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4175314171060144829827645440.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4175314180967254769484693504.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4175314150033100403158024192.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
      fun: 430.5308837454141
 hess_inv: &lt;4x4 LbfgsInvHessProduct with dtype=float64&gt;
      jac: array([5.68434189e-06, 5.68434192e-06, 5.68388505e-06, 5.68595342e-06])
  message: &#39;CONVERGENCE: NORM_OF_PROJECTED_GRADIENT_&lt;=_PGTOL&#39;
     nfev: 5
      nit: 0
     njev: 1
   status: 0
  success: True
        x: array([2.60000000e-01, 3.97137219e+00, 1.44000000e+04, 6.72000000e+04])
*** Estimation of beta and q0 done ***
                            OLS Regression Results
==============================================================================
Dep. Variable:                      y   R-squared:                       0.109
Model:                            OLS   Adj. R-squared:                  0.082
Method:                 Least Squares   F-statistic:                     4.029
Date:                Wed, 21 Sep 2022   Prob (F-statistic):           6.98e-05
Time:                        18:21:57   Log-Likelihood:                 49.539
No. Observations:                 307   AIC:                            -79.08
Df Residuals:                     297   BIC:                            -41.81
Df Model:                           9
Covariance Type:            nonrobust
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
const         -0.1516      0.033     -4.580      0.000      -0.217      -0.086
x1             0.1172      0.036      3.296      0.001       0.047       0.187
x2             0.0475      0.040      1.201      0.231      -0.030       0.125
x3             0.1333      0.029      4.536      0.000       0.075       0.191
x4             0.1378      0.042      3.278      0.001       0.055       0.221
x5            -0.0302      0.058     -0.525      0.600      -0.144       0.083
x6             0.0317      0.037      0.846      0.398      -0.042       0.105
x7             0.0380      0.033      1.158      0.248      -0.027       0.103
x8             0.0510      0.030      1.684      0.093      -0.009       0.111
x9            -0.0482      0.045     -1.075      0.283      -0.136       0.040
==============================================================================
Omnibus:                      176.557   Durbin-Watson:                   1.161
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             1306.206
Skew:                          -2.307   Prob(JB):                    2.30e-284
Kurtosis:                      11.991   Cond. No.                         6.56
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</pre></div></div>
</div>
<p>The warnings in the execution come from the fact that rent interpolation is discountinuous when underlying data is scattered. This is not a big issue to the extent that we are not interested in the shape of the rent function per se, but it causes optimization solver to break down when the associated likelihood function is not smooth. The calibration therefore essentially relies on parameter scanning.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We update parameter vector</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibratedUtility_beta</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;q0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibratedUtility_q0</span>

<span class="c1"># We print calibrated values (when possible)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;beta = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;q0 = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;q0&quot;</span><span class="p">]))</span>

<span class="c1"># We save them</span>
<span class="c1"># NB : alpha = 1 - beta</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;calibratedUtility_beta.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;calibratedUtility_q0.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;q0&quot;</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;calibratedAmenities.npy&#39;</span><span class="p">,</span>
        <span class="n">cal_amenities</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
beta = 0.26
q0 = 3.9713721908703206
</pre></div></div>
</div>
</div>
<div class="section" id="Calibrate-disamenity-index-for-informal-backyards-+-settlements">
<h2>Calibrate disamenity index for informal backyards + settlements<a class="headerlink" href="#Calibrate-disamenity-index-for-informal-backyards-+-settlements" title="Permalink to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We first need to recompute income net of commuting costs at baseline</span>
<span class="c1"># year since calibrated income has changed</span>

<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="p">(</span><span class="n">incomeNetOfCommuting</span><span class="p">,</span> <span class="n">modalShares</span><span class="p">,</span> <span class="n">ODflows</span><span class="p">,</span> <span class="n">averageIncome</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_transport_data</span><span class="p">(</span>
     <span class="n">grid</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">households_per_income_class</span><span class="p">,</span> <span class="n">average_income</span><span class="p">,</span>
     <span class="n">spline_inflation</span><span class="p">,</span> <span class="n">spline_fuel</span><span class="p">,</span>
     <span class="n">spline_population_income_distribution</span><span class="p">,</span> <span class="n">spline_income_distribution</span><span class="p">,</span>
     <span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">path_precalc_transp</span><span class="p">,</span> <span class="s1">&#39;GRID&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

<span class="n">income_net_of_commuting_costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="n">path_precalc_transp</span> <span class="o">+</span> <span class="s1">&#39;GRID_incomeNetOfCommuting_0.npy&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Then, we do the same for the amenity index (calibrated values normalized around 1)</span>
<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="n">amenities</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_amenities</span><span class="p">(</span><span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let us visualize the calibrated amenity index</span>
<span class="kn">import</span> <span class="nn">outputs.export_outputs</span> <span class="k">as</span> <span class="nn">outexp</span>
<span class="n">amenity_map</span> <span class="o">=</span> <span class="n">outexp</span><span class="o">.</span><span class="n">export_map</span><span class="p">(</span>
    <span class="n">amenities</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">geo_grid</span><span class="p">,</span> <span class="n">path_input_plots</span><span class="p">,</span> <span class="s1">&#39;amenity_map&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Map of average amenity index per location&quot;</span><span class="p">,</span>
    <span class="n">path_input_tables</span><span class="p">,</span>
    <span class="n">ubnd</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">lbnd</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;amenity_map.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
amenity_map done
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_83_1.png" src="_images/calib_nb_83_1.png" />
</div>
</div>
<p>NB: Since disamenity index calibration relies on the model fit and is not computed a priori (contrary to other parameters), the options set in the preamble should be the same as the ones used in the main script, so that the calibrated values are in line with the structural assumptions used</p>
<div class="section" id="We-start-with-a-general-(not-location-specific)-calibration">
<h3>We start with a general (not location-specific) calibration<a class="headerlink" href="#We-start-with-a-general-(not-location-specific)-calibration" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We define a range of disamenity values which we would like to scan,</span>
<span class="c1"># and arrange them in a grid</span>
<span class="n">list_amenity_backyard</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.62</span><span class="p">,</span> <span class="mf">0.661</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">list_amenity_settlement</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.641</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">housing_type_total</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
    <span class="n">list_amenity_backyard</span><span class="p">,</span> <span class="n">list_amenity_settlement</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">housing_type_total</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;param_backyard&quot;</span><span class="p">,</span> <span class="s2">&quot;param_settlement&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We initialize output vector</span>
<span class="n">housing_type_total</span><span class="p">[</span><span class="s2">&quot;formal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">housing_type_total</span><span class="o">.</span><span class="n">param_backyard</span><span class="p">))</span>
<span class="n">housing_type_total</span><span class="p">[</span><span class="s2">&quot;backyard&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">housing_type_total</span><span class="o">.</span><span class="n">param_backyard</span><span class="p">))</span>
<span class="n">housing_type_total</span><span class="p">[</span><span class="s2">&quot;informal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">housing_type_total</span><span class="o">.</span><span class="n">param_backyard</span><span class="p">))</span>
<span class="n">housing_type_total</span><span class="p">[</span><span class="s2">&quot;subsidized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">housing_type_total</span><span class="o">.</span><span class="n">param_backyard</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[83]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We print the number of total iterations (to have an intuition of how long</span>
<span class="c1"># the process will take)</span>
<span class="n">number_total_iterations</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">list_amenity_backyard</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_amenity_settlement</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;** Calibration: </span><span class="si">{</span><span class="n">number_total_iterations</span><span class="si">}</span><span class="s2"> iterations **&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
** Calibration: 25 iterations **
</pre></div></div>
</div>
<p>We are going to compute the initial state equilibrium for each pair of parameters, and retain the one that best fits the observed number of households in informal settlements + backyards</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[84]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">equilibrium.compute_equilibrium</span> <span class="k">as</span> <span class="nn">eqcmp</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_amenity_backyard</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_amenity_settlement</span><span class="p">)):</span>

        <span class="c1"># We set input values</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_backyard&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_amenity_backyard</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_settlement&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_amenity_settlement</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_settlement&quot;</span><span class="p">]</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
                                     <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_backyard&quot;</span><span class="p">])</span>

        <span class="c1"># We run the algorithm</span>
        <span class="p">(</span><span class="n">initial_state_utility</span><span class="p">,</span>
         <span class="n">initial_state_error</span><span class="p">,</span>
         <span class="n">initial_state_simulated_jobs</span><span class="p">,</span>
         <span class="n">initial_state_households_housing_types</span><span class="p">,</span>
         <span class="n">initial_state_household_centers</span><span class="p">,</span>
         <span class="n">initial_state_households</span><span class="p">,</span>
         <span class="n">initial_state_dwelling_size</span><span class="p">,</span>
         <span class="n">initial_state_housing_supply</span><span class="p">,</span>
         <span class="n">initial_state_rent</span><span class="p">,</span>
         <span class="n">initial_state_rent_matrix</span><span class="p">,</span>
         <span class="n">initial_state_capital_land</span><span class="p">,</span>
         <span class="n">initial_state_average_income</span><span class="p">,</span>
         <span class="n">initial_state_limit_city</span><span class="p">)</span> <span class="o">=</span> <span class="n">eqcmp</span><span class="o">.</span><span class="n">compute_equilibrium</span><span class="p">(</span>
             <span class="n">fraction_capital_destroyed</span><span class="p">,</span>
             <span class="n">amenities</span><span class="p">,</span>
             <span class="n">param</span><span class="p">,</span>
             <span class="n">housing_limit</span><span class="p">,</span>
             <span class="n">population</span><span class="p">,</span>
             <span class="n">households_per_income_class</span><span class="p">,</span>
             <span class="n">total_RDP</span><span class="p">,</span>
             <span class="n">coeff_land</span><span class="p">,</span>
             <span class="n">income_net_of_commuting_costs</span><span class="p">,</span>
             <span class="n">grid</span><span class="p">,</span>
             <span class="n">options</span><span class="p">,</span>
             <span class="n">agricultural_rent</span><span class="p">,</span>
             <span class="n">interest_rate</span><span class="p">,</span>
             <span class="n">number_properties_RDP</span><span class="p">,</span>
             <span class="n">average_income</span><span class="p">,</span>
             <span class="n">mean_income</span><span class="p">,</span>
             <span class="n">income_class_by_housing_type</span><span class="p">,</span>
             <span class="n">minimum_housing_supply</span><span class="p">,</span>
             <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_A&quot;</span><span class="p">],</span>
             <span class="n">income_2011</span><span class="p">)</span>

        <span class="c1"># We fill output matrix with the total number of HHs per housing</span>
        <span class="c1"># type for given values of backyard and informal amenity parameters</span>
        <span class="n">housing_type_total</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">housing_type_total</span><span class="o">.</span><span class="n">param_backyard</span>
             <span class="o">==</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_backyard&quot;</span><span class="p">])</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">housing_type_total</span><span class="o">.</span><span class="n">param_settlement</span>
               <span class="o">==</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_settlement&quot;</span><span class="p">]),</span>
            <span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">initial_state_households_housing_types</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># We update the iteration count and print progress made</span>
        <span class="n">iteration_number</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_amenity_settlement</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;iteration </span><span class="si">{</span><span class="n">iteration_number</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">number_total_iterations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:40, 47.29it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 1/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 73/2000 [00:01&lt;00:41, 46.10it/s, error_max_abs=0.0178]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 2/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:40, 47.15it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 3/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 47.02it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 4/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.64it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 5/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 73/2000 [00:01&lt;00:41, 46.51it/s, error_max_abs=0.0183]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 6/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.39it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 7/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:42, 45.77it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 8/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:42, 45.73it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 9/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.52it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 10/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.61it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 11/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  70%|████████████████▊       | 1401/2000 [00:30&lt;00:13, 45.96it/s, error_max_abs=0.0184]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 12/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.26it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 13/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 73/2000 [00:01&lt;00:41, 46.29it/s, error_max_abs=0.0185]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 14/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:42, 45.66it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 15/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:42, 45.46it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 16/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:44, 43.68it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 17/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.00it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 18/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 74/2000 [00:01&lt;00:42, 45.71it/s, error_max_abs=0.0168]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 19/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:42, 45.58it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 20/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:42, 45.60it/s, error_max_abs=0.0199]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 21/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:44, 43.76it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 22/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:43, 44.28it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 23/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.03it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 24/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|█                         | 85/2000 [00:01&lt;00:42, 45.58it/s, error_max_abs=0.0166]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 25/25
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We compute the error between simulated and observed number of households</span>
<span class="c1"># in each housing type (without RDP, which is exogenously set equal to data)</span>
<span class="n">distance_share</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
    <span class="n">housing_type_total</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">housing_type_data</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>

<span class="c1"># We define the score that we want to minimize as the sum of the errors for</span>
<span class="c1"># informal backyards and informal settlements</span>
<span class="n">distance_share_score</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">distance_share</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">distance_share</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>

<span class="c1"># We select the arguments associated with the minimum</span>
<span class="n">which</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distance_share_score</span><span class="p">)</span>
<span class="n">min_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">distance_share_score</span><span class="p">)</span>
<span class="n">calibrated_amenities</span> <span class="o">=</span> <span class="n">housing_type_total</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">which</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[86]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We update parameter vector</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_backyard&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibrated_amenities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_settlement&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibrated_amenities</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># We print the calibrated values</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;amenity_backyard = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_backyard&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;amenity_settlement = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_settlement&quot;</span><span class="p">]))</span>

<span class="c1"># We save them</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;param_amenity_backyard.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_backyard&quot;</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;param_amenity_settlement.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_settlement&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
amenity_backyard = 0.64
amenity_settlement = 0.62
</pre></div></div>
</div>
</div>
<div class="section" id="Calibrate-location-specific-disamenity-index">
<h3>Calibrate location-specific disamenity index<a class="headerlink" href="#Calibrate-location-specific-disamenity-index" title="Permalink to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[87]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Default is set to 1 but can be changed if we fear overfit of the model</span>
<span class="kn">import</span> <span class="nn">equilibrium.compute_equilibrium</span> <span class="k">as</span> <span class="nn">eqcmp</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;location_based_calib&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

    <span class="c1"># We start from where we left (to gain time) and compute the</span>
    <span class="c1"># equilibrium again</span>

    <span class="c1"># We first initialize input values</span>

    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">index_max</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">index_max</span><span class="p">)</span>

    <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_settlement&quot;</span><span class="p">]</span>
    <span class="n">save_param_informal_settlements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">index_max</span><span class="p">,</span> <span class="mi">24014</span><span class="p">))</span>
    <span class="n">metrics_is</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">index_max</span><span class="p">)</span>
    <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_backyard&quot;</span><span class="p">]</span>
    <span class="n">save_param_backyards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">index_max</span><span class="p">,</span> <span class="mi">24014</span><span class="p">))</span>
    <span class="n">metrics_ib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">index_max</span><span class="p">)</span>

    <span class="c1"># We run the algorithm</span>
    <span class="p">(</span><span class="n">initial_state_utility</span><span class="p">,</span>
     <span class="n">initial_state_error</span><span class="p">,</span>
     <span class="n">initial_state_simulated_jobs</span><span class="p">,</span>
     <span class="n">initial_state_households_housing_types</span><span class="p">,</span>
     <span class="n">initial_state_household_centers</span><span class="p">,</span>
     <span class="n">initial_state_households</span><span class="p">,</span>
     <span class="n">initial_state_dwelling_size</span><span class="p">,</span>
     <span class="n">initial_state_housing_supply</span><span class="p">,</span>
     <span class="n">initial_state_rent</span><span class="p">,</span>
     <span class="n">initial_state_rent_matrix</span><span class="p">,</span>
     <span class="n">initial_state_capital_land</span><span class="p">,</span>
     <span class="n">initial_state_average_income</span><span class="p">,</span>
     <span class="n">initial_state_limit_city</span>
     <span class="p">)</span> <span class="o">=</span> <span class="n">eqcmp</span><span class="o">.</span><span class="n">compute_equilibrium</span><span class="p">(</span>
         <span class="n">fraction_capital_destroyed</span><span class="p">,</span>
         <span class="n">amenities</span><span class="p">,</span>
         <span class="n">param</span><span class="p">,</span>
         <span class="n">housing_limit</span><span class="p">,</span>
         <span class="n">population</span><span class="p">,</span>
         <span class="n">households_per_income_class</span><span class="p">,</span>
         <span class="n">total_RDP</span><span class="p">,</span>
         <span class="n">coeff_land</span><span class="p">,</span>
         <span class="n">income_net_of_commuting_costs</span><span class="p">,</span>
         <span class="n">grid</span><span class="p">,</span>
         <span class="n">options</span><span class="p">,</span>
         <span class="n">agricultural_rent</span><span class="p">,</span>
         <span class="n">interest_rate</span><span class="p">,</span>
         <span class="n">number_properties_RDP</span><span class="p">,</span>
         <span class="n">average_income</span><span class="p">,</span>
         <span class="n">mean_income</span><span class="p">,</span>
         <span class="n">income_class_by_housing_type</span><span class="p">,</span>
         <span class="n">minimum_housing_supply</span><span class="p">,</span>
         <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_A&quot;</span><span class="p">],</span>
         <span class="n">income_2011</span><span class="p">)</span>

    <span class="c1"># We set the maximum number of iterations</span>
    <span class="n">number_total_iterations</span> <span class="o">=</span> <span class="n">index_max</span>

    <span class="c1"># Then we optimize over the number of households per housing type</span>
    <span class="c1"># PER PIXEL, and not just on the aggregate number (to acccount for</span>
    <span class="c1"># differing disamenities per location, e.g. eviction probability,</span>
    <span class="c1"># infrastructure networks, etc.)</span>

    <span class="c1"># To do so, we use granular housing_types variable (from SAL data) instead</span>
    <span class="c1"># of aggregate housing_types variable</span>

    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index_max</span><span class="p">):</span>

        <span class="c1"># INFORMAL SETTLEMENTS</span>

        <span class="c1"># We initialize output vector</span>
        <span class="n">diff_is</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24014</span><span class="p">):</span>
            <span class="c1"># We store the error term</span>
            <span class="n">diff_is</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">housing_types</span><span class="o">.</span><span class="n">informal_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                          <span class="o">-</span> <span class="n">initial_state_households_housing_types</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:][</span><span class="n">i</span><span class="p">]</span>
                          <span class="p">)</span>
            <span class="c1"># We apply an empirical reweighting that helps convergence</span>
            <span class="n">adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff_is</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">150000</span><span class="p">)</span>
            <span class="c1"># We increase the amenity score when we underestimate the nb of</span>
            <span class="c1"># households</span>
            <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">adj</span>
        <span class="c1"># We store iteration outcome and prevent extreme sorting from</span>
        <span class="c1"># happening due to the amenity score</span>
        <span class="n">metrics_is</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff_is</span><span class="p">))</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.99</span>
        <span class="n">save_param_informal_settlements</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">]</span>

        <span class="c1"># INFORMAL BACKYARDS</span>

        <span class="c1"># We initialize output vector</span>
        <span class="n">diff_ib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24014</span><span class="p">):</span>
            <span class="c1"># Note that we add an option depending on whether we restrict</span>
            <span class="c1"># ourselves to informal backyards (default) or all kinds of</span>
            <span class="c1"># backyards (not warranted given the standardized structure</span>
            <span class="c1"># assumed in the model)</span>
            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;actual_backyards&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">diff_ib</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">housing_types</span><span class="o">.</span><span class="n">backyard_informal_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">housing_types</span><span class="o">.</span><span class="n">backyard_formal_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">initial_state_households_housing_types</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:][</span><span class="n">i</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;actual_backyards&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">diff_ib</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">housing_types</span><span class="o">.</span><span class="n">backyard_informal_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">initial_state_households_housing_types</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:][</span><span class="n">i</span><span class="p">])</span>
            <span class="c1"># We help convergence and update parameter</span>
            <span class="n">adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff_ib</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">75000</span><span class="p">)</span>
            <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">adj</span><span class="p">)</span>
        <span class="c1"># We store iteration output and prevent extreme sorting</span>
        <span class="n">metrics_ib</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff_ib</span><span class="p">))</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.99</span>
        <span class="n">save_param_backyards</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">]</span>

        <span class="c1"># We retain the sum of the errors as our minimization objective</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_is</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">metrics_ib</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># We run the equilibrium again with updated values of</span>
        <span class="c1"># informal/backyard housing disamenity indices, then go to the next</span>
        <span class="c1"># iteration</span>

        <span class="p">(</span><span class="n">initial_state_utility</span><span class="p">,</span> <span class="n">initial_state_error</span><span class="p">,</span>
         <span class="n">initial_state_simulated_jobs</span><span class="p">,</span>
         <span class="n">initial_state_households_housing_types</span><span class="p">,</span>
         <span class="n">initial_state_household_centers</span><span class="p">,</span>
         <span class="n">initial_state_households</span><span class="p">,</span> <span class="n">initial_state_dwelling_size</span><span class="p">,</span>
         <span class="n">initial_state_housing_supply</span><span class="p">,</span> <span class="n">initial_state_rent</span><span class="p">,</span>
         <span class="n">initial_state_rent_matrix</span><span class="p">,</span> <span class="n">initial_state_capital_land</span><span class="p">,</span>
         <span class="n">initial_state_average_income</span><span class="p">,</span> <span class="n">initial_state_limit_city</span>
         <span class="p">)</span> <span class="o">=</span> <span class="n">eqcmp</span><span class="o">.</span><span class="n">compute_equilibrium</span><span class="p">(</span>
             <span class="n">fraction_capital_destroyed</span><span class="p">,</span> <span class="n">amenities</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">housing_limit</span><span class="p">,</span>
             <span class="n">population</span><span class="p">,</span> <span class="n">households_per_income_class</span><span class="p">,</span> <span class="n">total_RDP</span><span class="p">,</span>
             <span class="n">coeff_land</span><span class="p">,</span> <span class="n">income_net_of_commuting_costs</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
             <span class="n">agricultural_rent</span><span class="p">,</span> <span class="n">interest_rate</span><span class="p">,</span> <span class="n">number_properties_RDP</span><span class="p">,</span>
             <span class="n">average_income</span><span class="p">,</span> <span class="n">mean_income</span><span class="p">,</span> <span class="n">income_class_by_housing_type</span><span class="p">,</span>
             <span class="n">minimum_housing_supply</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_A&quot;</span><span class="p">],</span> <span class="n">income_2011</span><span class="p">)</span>

        <span class="n">iteration_number</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;iteration </span><span class="si">{</span><span class="n">iteration_number</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">number_total_iterations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.16it/s, error_max_abs=0.0182]
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:43, 44.27it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 1/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.93it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 2/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 73/2000 [00:01&lt;00:41, 46.54it/s, error_max_abs=0.0178]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 3/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:51, 37.74it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 4/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:40, 47.53it/s, error_max_abs=0.0195]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 5/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:40, 47.62it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 6/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:43, 44.18it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 7/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:40, 47.20it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 8/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  51%|████████████▏           | 1019/2000 [00:21&lt;00:20, 46.95it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 9/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.78it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 10/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  13%|███▎                     | 265/2000 [00:05&lt;00:36, 47.23it/s, error_max_abs=0.0197]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 11/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:40, 47.61it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 12/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  27%|██████▉                   | 537/2000 [00:11&lt;00:31, 46.83it/s, error_max_abs=0.019]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 13/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  43%|██████████▋              | 851/2000 [00:18&lt;00:24, 46.62it/s, error_max_abs=0.0164]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 14/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   8%|██▏                        | 162/2000 [00:03&lt;00:39, 46.76it/s, error_max_abs=0.02]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 15/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  75%|█████████████████▉      | 1492/2000 [00:32&lt;00:10, 46.45it/s, error_max_abs=0.0107]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 16/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  39%|█████████▍              | 782/2000 [00:16&lt;00:26, 46.38it/s, error_max_abs=0.00188]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 17/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 73/2000 [00:01&lt;00:40, 47.08it/s, error_max_abs=0.0178]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 18/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  38%|█████████               | 753/2000 [00:16&lt;00:27, 46.01it/s, error_max_abs=0.00287]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 19/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  27%|██████▌                 | 547/2000 [00:12&lt;00:32, 45.02it/s, error_max_abs=0.00262]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 20/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  54%|████████████▍          | 1081/2000 [00:23&lt;00:19, 46.18it/s, error_max_abs=0.00209]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 21/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  84%|████████████████████▏   | 1686/2000 [00:37&lt;00:06, 45.51it/s, error_max_abs=0.0189]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 22/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.03it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 23/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  22%|█████▋                    | 436/2000 [00:09&lt;00:34, 45.14it/s, error_max_abs=0.013]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 24/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  39%|█████████▊               | 785/2000 [00:17&lt;00:27, 44.93it/s, error_max_abs=0.0193]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 25/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  18%|████▎                   | 355/2000 [00:07&lt;00:36, 44.90it/s, error_max_abs=0.00792]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 26/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  69%|████████████████▌       | 1376/2000 [00:30&lt;00:13, 45.02it/s, error_max_abs=0.0189]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 27/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  30%|███████▍                 | 593/2000 [00:13&lt;00:31, 44.21it/s, error_max_abs=0.0093]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 28/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  46%|███████████             | 918/2000 [00:20&lt;00:24, 44.52it/s, error_max_abs=0.00797]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 29/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  37%|█████████▏               | 737/2000 [00:16&lt;00:27, 45.15it/s, error_max_abs=0.0189]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 30/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:42, 45.89it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 31/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  87%|█████████████████████▋   | 1739/2000 [00:40&lt;00:06, 42.47it/s, error_max_abs=0.013]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 32/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  42%|██████████▍              | 837/2000 [00:24&lt;00:33, 34.43it/s, error_max_abs=0.0161]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 33/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  74%|█████████████████      | 1486/2000 [00:37&lt;00:12, 39.69it/s, error_max_abs=0.00674]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 34/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  58%|██████████████▉           | 1151/2000 [00:26&lt;00:19, 43.98it/s, error_max_abs=0.02]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 35/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02: 100%|███████████████████████▉| 1999/2000 [00:49&lt;00:00, 40.36it/s, error_max_abs=0.0294]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 36/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:47, 40.44it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 37/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:46, 41.53it/s, error_max_abs=0.0197]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 38/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  82%|████████████████████▍    | 1636/2000 [00:42&lt;00:09, 38.53it/s, error_max_abs=0.011]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 39/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  36%|█████████                | 721/2000 [00:18&lt;00:32, 39.84it/s, error_max_abs=0.0191]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 40/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:47, 40.53it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 41/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  51%|████████████▎           | 1028/2000 [00:40&lt;00:38, 25.20it/s, error_max_abs=0.0118]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 42/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:03&lt;01:42, 18.81it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 43/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  92%|█████████████████████▎ | 1848/2000 [01:00&lt;00:04, 30.67it/s, error_max_abs=0.00641]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 44/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:02&lt;00:58, 33.00it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 45/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:02&lt;00:57, 33.48it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 46/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  41%|█████████▉              | 825/2000 [00:24&lt;00:34, 34.25it/s, error_max_abs=0.00964]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 47/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  13%|███▎                     | 268/2000 [00:07&lt;00:50, 34.12it/s, error_max_abs=0.0194]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 48/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:53, 36.17it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 49/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  11%|██▊                      | 224/2000 [00:06&lt;00:52, 33.90it/s, error_max_abs=0.0199]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 50/50
0.40678920836767085
0.6194845398082257
0.8039969236529559
0.4497641257277256
0.6393183222476003
0.9200420940045734
[WinError 183] Cannot create a file when that file already exists: &#39;../Data/Precalculated inputs/&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[93]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We pick the set of parameters that minimize the sum of absolute diffs</span>
<span class="c1"># between data and simulation</span>
<span class="n">score_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
<span class="n">index_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

<span class="c1"># We update the parameter vector</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_param_informal_settlements</span><span class="p">[</span><span class="n">index_min</span><span class="p">]</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_param_backyards</span><span class="p">[</span><span class="n">index_min</span><span class="p">]</span>

<span class="c1"># We save values</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;param_pockets.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;param_backyards.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[94]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let us visualize the calibrated disamenity index for informal settlements</span>
<span class="kn">import</span> <span class="nn">outputs.export_outputs</span> <span class="k">as</span> <span class="nn">outexp</span>
<span class="n">disamenity_IS_map</span> <span class="o">=</span> <span class="n">outexp</span><span class="o">.</span><span class="n">export_map</span><span class="p">(</span>
    <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">],</span> <span class="n">grid</span><span class="p">,</span> <span class="n">geo_grid</span><span class="p">,</span> <span class="n">path_input_plots</span><span class="p">,</span> <span class="s1">&#39;disamenity_IS_map&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Map of average disamenity index for informal settlements&quot;</span><span class="p">,</span>
    <span class="n">path_input_tables</span><span class="p">,</span> <span class="n">ubnd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">]))</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;disamenity_IS_map.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
disamenity_IS_map done
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[94]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_96_1.png" src="_images/calib_nb_96_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[95]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Now for informal backyards</span>
<span class="kn">import</span> <span class="nn">outputs.export_outputs</span> <span class="k">as</span> <span class="nn">outexp</span>
<span class="n">disamenity_IB_map</span> <span class="o">=</span> <span class="n">outexp</span><span class="o">.</span><span class="n">export_map</span><span class="p">(</span>
    <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">],</span> <span class="n">grid</span><span class="p">,</span> <span class="n">geo_grid</span><span class="p">,</span> <span class="n">path_input_plots</span><span class="p">,</span> <span class="s1">&#39;disamenity_IB_map&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Map of average disamenity index for informal backyards&quot;</span><span class="p">,</span>
    <span class="n">path_input_tables</span><span class="p">,</span> <span class="n">ubnd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">]))</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;disamenity_IB_map.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
disamenity_IB_map done
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[95]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_97_1.png" src="_images/calib_nb_97_1.png" />
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="main_nb.html" class="btn btn-neutral float-left" title="Notebook: run model" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="guidelines.html" class="btn btn-neutral float-right" title="User guidelines" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Thomas Monnier.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>