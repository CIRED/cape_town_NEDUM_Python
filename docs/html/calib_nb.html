<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Notebook: run calibration &mdash; NEDUM-2D for CoCT  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="User guidelines" href="guidelines.html" />
    <link rel="prev" title="Notebook: run model" href="main_nb.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> NEDUM-2D for CoCT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="readme_link.html">Introducing NEDUM-2D</a></li>
<li class="toctree-l1"><a class="reference internal" href="license_rst.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="main_nb.html">Notebook: run model</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Notebook: run calibration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Preamble">Preamble</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Import-packages">Import packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Define-file-paths">Define file paths</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Create-associated-directories-if-needed">Create associated directories if needed</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Import-parameters-and-options">Import parameters and options</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#We-import-default-parameter-and-options">We import default parameter and options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#We-also-set-custom-options-for-this-simulation">We also set custom options for this simulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#We-first-set-options-regarding-structural-assumptions-used-in-the-model">We first set options regarding structural assumptions used in the model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Then-we-set-options-regarding-flood-data-used">Then we set options regarding flood data used</a></li>
<li class="toctree-l4"><a class="reference internal" href="#We-also-set-options-for-scenarios-on-time-moving-exogenous-variables">We also set options for scenarios on time-moving exogenous variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Finally,-we-set-options-regarding-data-processing">Finally, we set options regarding data processing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Load-data">Load data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Basic-geographic-data">Basic geographic data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Macro-data">Macro data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Households-and-income-data">Households and income data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Land-use-projections">Land use projections</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Import-flood-data-(takes-some-time-when-agents-anticipate-floods)">Import flood data (takes some time when agents anticipate floods)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Import-scenarios-(for-time-moving-variables)">Import scenarios (for time-moving variables)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Import-income-net-of-commuting-costs-(for-all-time-periods)">Import income net of commuting costs (for all time periods)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Prepare-data">Prepare data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Define-dominant-income-group-in-each-census-block-(SP)">Define dominant income group in each census block (SP)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Obtain-number-of-formal-private-housing-units-per-SP">Obtain number of formal private housing units per SP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Sample-selection">Sample selection</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Calibrate-construction-function-parameters">Calibrate construction function parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Calibrate-incomes-and-gravity-parameter">Calibrate incomes and gravity parameter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Let-us-first-visualize-inputs">Let us first visualize inputs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#We-visualize-the-associated-calibrated-outputs">We visualize the associated calibrated outputs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Calibrate-utility-function-parameters">Calibrate utility function parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Calibrate-disamenity-index-for-informal-backyards-+-settlements">Calibrate disamenity index for informal backyards + settlements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#We-start-with-a-general-(not-location-specific)-calibration">We start with a general (not location-specific) calibration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Calibrate-location-specific-disamenity-index">Calibrate location-specific disamenity index</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="guidelines.html">User guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_case.html">Use case</a></li>
<li class="toctree-l1"><a class="reference internal" href="technical_doc.html">Technical documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="input_tables.html">Input tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_bases.html">Data bases</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_sets.html">Data sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="math_appendix.html">Math appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_ref.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="install_help.html">Installation help</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">NEDUM-2D for CoCT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Notebook: run calibration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/calib_nb.nblink.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Notebook:-run-calibration">
<h1>Notebook: run calibration<a class="headerlink" href="#Notebook:-run-calibration" title="Permalink to this heading"></a></h1>
<div class="section" id="Preamble">
<h2>Preamble<a class="headerlink" href="#Preamble" title="Permalink to this heading"></a></h2>
<div class="section" id="Import-packages">
<h3>Import packages<a class="headerlink" href="#Import-packages" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We import standard Python libraries</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="c1"># We also import our own packages</span>
<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="kn">import</span> <span class="nn">inputs.parameters_and_options</span> <span class="k">as</span> <span class="nn">inpprm</span>
<span class="kn">import</span> <span class="nn">equilibrium.compute_equilibrium</span> <span class="k">as</span> <span class="nn">eqcmp</span>
<span class="kn">import</span> <span class="nn">equilibrium.functions_dynamic</span> <span class="k">as</span> <span class="nn">eqdyn</span>
<span class="kn">import</span> <span class="nn">calibration.calib_main_func</span> <span class="k">as</span> <span class="nn">calmain</span>
<span class="kn">import</span> <span class="nn">outputs.export_outputs</span> <span class="k">as</span> <span class="nn">outexp</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Define-file-paths">
<h3>Define file paths<a class="headerlink" href="#Define-file-paths" title="Permalink to this heading"></a></h3>
<p>This corresponds to the architecture described in the README file (introduction tab of the documentation): the data folder is not hosted on the Github repository and should be placed in the root folder enclosing the repo</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path_code</span> <span class="o">=</span> <span class="s1">&#39;..&#39;</span>
<span class="n">path_folder</span> <span class="o">=</span> <span class="n">path_code</span> <span class="o">+</span> <span class="s1">&#39;/Data/&#39;</span>
<span class="n">path_precalc_inp</span> <span class="o">=</span> <span class="n">path_folder</span> <span class="o">+</span> <span class="s1">&#39;Precalculated inputs/&#39;</span>
<span class="n">path_data</span> <span class="o">=</span> <span class="n">path_folder</span> <span class="o">+</span> <span class="s1">&#39;data_Cape_Town/&#39;</span>
<span class="n">path_precalc_transp</span> <span class="o">=</span> <span class="n">path_folder</span> <span class="o">+</span> <span class="s1">&#39;precalculated_transport/&#39;</span>
<span class="n">path_scenarios</span> <span class="o">=</span> <span class="n">path_data</span> <span class="o">+</span> <span class="s1">&#39;Scenarios/&#39;</span>
<span class="n">path_outputs</span> <span class="o">=</span> <span class="n">path_code</span> <span class="o">+</span> <span class="s1">&#39;/Output/&#39;</span>
<span class="n">path_floods</span> <span class="o">=</span> <span class="n">path_folder</span> <span class="o">+</span> <span class="s2">&quot;FATHOM/&quot;</span>
<span class="n">path_input_plots</span> <span class="o">=</span> <span class="n">path_outputs</span> <span class="o">+</span> <span class="s1">&#39;/input_plots/&#39;</span>
<span class="n">path_input_tables</span> <span class="o">=</span> <span class="n">path_outputs</span> <span class="o">+</span> <span class="s1">&#39;/input_tables/&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Create-associated-directories-if-needed">
<h3>Create associated directories if needed<a class="headerlink" href="#Create-associated-directories-if-needed" title="Permalink to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path_input_plots</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path_input_tables</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[WinError 183] Cannot create a file when that file already exists: &#39;../Output//input_plots/&#39;
[WinError 183] Cannot create a file when that file already exists: &#39;../Output//input_tables/&#39;
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Import-parameters-and-options">
<h2>Import parameters and options<a class="headerlink" href="#Import-parameters-and-options" title="Permalink to this heading"></a></h2>
<div class="section" id="We-import-default-parameter-and-options">
<h3>We import default parameter and options<a class="headerlink" href="#We-import-default-parameter-and-options" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inputs.parameters_and_options</span> <span class="k">as</span> <span class="nn">inpprm</span>
<span class="n">options</span> <span class="o">=</span> <span class="n">inpprm</span><span class="o">.</span><span class="n">import_options</span><span class="p">()</span>
<span class="n">param</span> <span class="o">=</span> <span class="n">inpprm</span><span class="o">.</span><span class="n">import_param</span><span class="p">(</span>
    <span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">path_outputs</span><span class="p">,</span> <span class="n">path_folder</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="We-also-set-custom-options-for-this-simulation">
<h3>We also set custom options for this simulation<a class="headerlink" href="#We-also-set-custom-options-for-this-simulation" title="Permalink to this heading"></a></h3>
<div class="section" id="We-first-set-options-regarding-structural-assumptions-used-in-the-model">
<h4>We first set options regarding structural assumptions used in the model<a class="headerlink" href="#We-first-set-options-regarding-structural-assumptions-used-in-the-model" title="Permalink to this heading"></a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dummy for taking floods into account in agents&#39; choices</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;agents_anticipate_floods&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># Dummy for preventing new informal settlement development</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;informal_land_constrained&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Then-we-set-options-regarding-flood-data-used">
<h4>Then we set options regarding flood data used<a class="headerlink" href="#Then-we-set-options-regarding-flood-data-used" title="Permalink to this heading"></a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dummy for taking pluvial floods into account (on top of fluvial floods)</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;pluvial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># Dummy for reducing pluvial risk for (better protected) formal structures</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_pluvial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># Dummy for taking coastal floods into account (on top of fluvial floods)</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;coastal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># Digital elevation model to be used with coastal floods (MERITDEM or NASADEM)</span>
<span class="c1"># NB: MERITDEM is also the DEM used for fluvial and pluvial flood data</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;dem&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MERITDEM&quot;</span>
<span class="c1"># Dummy for taking defended (vs. undefended) fluvial flood maps</span>
<span class="c1"># NB: FATHOM recommends to use undefended maps due to the high uncertainty</span>
<span class="c1"># in infrastructure modelling</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;defended&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># Dummy for taking sea-level rise into account in coastal flood data</span>
<span class="c1"># NB: Projections are up to 2050, based upon IPCC AR5 assessment for the</span>
<span class="c1"># RCP 8.5 scenario</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;slr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="We-also-set-options-for-scenarios-on-time-moving-exogenous-variables">
<h4>We also set options for scenarios on time-moving exogenous variables<a class="headerlink" href="#We-also-set-options-for-scenarios-on-time-moving-exogenous-variables" title="Permalink to this heading"></a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NB: Must be set to 1/2/3 for low/medium/high growth scenario</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;inc_ineq_scenario&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;pop_growth_scenario&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;fuel_price_scenario&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Finally,-we-set-options-regarding-data-processing">
<h4>Finally, we set options regarding data processing<a class="headerlink" href="#Finally,-we-set-options-regarding-data-processing" title="Permalink to this heading"></a></h4>
<p>Default is set at zero to save computing time (data is simply loaded in the model)</p>
<p>NB: this is only needed to create the data for the first time, or when the source is changed, so that pre-processed data is updated</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dummy for converting small-area-level (SAL) data into grid-level data</span>
<span class="c1"># (used for result validation)</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;convert_sal_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># Dummy for computing expected income net of commuting costs on the basis</span>
<span class="c1"># of calibrated wages</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;compute_net_income&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="Load-data">
<h2>Load data<a class="headerlink" href="#Load-data" title="Permalink to this heading"></a></h2>
<div class="section" id="Basic-geographic-data">
<h3>Basic geographic data<a class="headerlink" href="#Basic-geographic-data" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="n">grid</span><span class="p">,</span> <span class="n">center</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_grid</span><span class="p">(</span><span class="n">path_data</span><span class="p">)</span>
<span class="n">amenities</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_amenities</span><span class="p">(</span><span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
<span class="n">geo_grid</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">path_data</span> <span class="o">+</span> <span class="s2">&quot;grid_reference_500.shp&quot;</span><span class="p">)</span>
<span class="n">geo_TAZ</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">path_data</span> <span class="o">+</span> <span class="s2">&quot;TAZ_ampp_prod_attr_2013_2032.shp&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Macro-data">
<h3>Macro data<a class="headerlink" href="#Macro-data" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="p">(</span><span class="n">interest_rate</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">housing_type_data</span><span class="p">,</span> <span class="n">total_RDP</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_macro_data</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">path_scenarios</span><span class="p">,</span> <span class="n">path_folder</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Households-and-income-data">
<h3>Households and income data<a class="headerlink" href="#Households-and-income-data" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>

<span class="n">income_class_by_housing_type</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_hypothesis_housing_type</span><span class="p">()</span>

<span class="p">(</span><span class="n">mean_income</span><span class="p">,</span> <span class="n">households_per_income_class</span><span class="p">,</span> <span class="n">average_income</span><span class="p">,</span> <span class="n">income_mult</span><span class="p">,</span>
 <span class="n">income_2011</span><span class="p">,</span> <span class="n">households_per_income_and_housing</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_income_classes_data</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">path_data</span><span class="p">)</span>

<span class="c1"># NB: we create this parameter to maintain money illusion in simulations</span>
<span class="c1"># (see eqsim.run_simulation function)</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;income_year_reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_income</span>

<span class="c1"># Other data at SP (small place) level used for calibration and validation</span>
<span class="p">(</span><span class="n">data_rdp</span><span class="p">,</span> <span class="n">housing_types_sp</span><span class="p">,</span> <span class="n">data_sp</span><span class="p">,</span> <span class="n">mitchells_plain_grid_2011</span><span class="p">,</span>
 <span class="n">grid_formal_density_HFA</span><span class="p">,</span> <span class="n">threshold_income_distribution</span><span class="p">,</span> <span class="n">income_distribution</span><span class="p">,</span>
 <span class="n">cape_town_limits</span><span class="p">)</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_households_data</span><span class="p">(</span><span class="n">path_precalc_inp</span><span class="p">)</span>

<span class="c1"># Import nb of households per pixel, by housing type (from SAL data)</span>
<span class="c1"># NB: RDP housing is included in formal, and there are both formal and informal</span>
<span class="c1"># backyards</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;convert_sal_data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">housing_types</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_sal_data</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">path_folder</span><span class="p">,</span> <span class="n">path_data</span><span class="p">,</span>
                                          <span class="n">housing_type_data</span><span class="p">)</span>
<span class="n">housing_types</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">path_folder</span> <span class="o">+</span> <span class="s1">&#39;housing_types_grid_sal.xlsx&#39;</span><span class="p">)</span>
<span class="n">housing_types</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">housing_types</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Land-use-projections">
<h3>Land use projections<a class="headerlink" href="#Land-use-projections" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We import basic projections</span>
<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="p">(</span><span class="n">spline_RDP</span><span class="p">,</span> <span class="n">spline_estimate_RDP</span><span class="p">,</span> <span class="n">spline_land_RDP</span><span class="p">,</span>
 <span class="n">spline_land_backyard</span><span class="p">,</span> <span class="n">spline_land_informal</span><span class="p">,</span> <span class="n">spline_land_constraints</span><span class="p">,</span>
 <span class="n">number_properties_RDP</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
     <span class="n">inpdt</span><span class="o">.</span><span class="n">import_land_use</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">data_rdp</span><span class="p">,</span> <span class="n">housing_types</span><span class="p">,</span>
                           <span class="n">housing_type_data</span><span class="p">,</span> <span class="n">path_data</span><span class="p">,</span> <span class="n">path_folder</span><span class="p">)</span>
     <span class="p">)</span>

<span class="c1"># We correct areas for each housing type at baseline year for the amount of</span>
<span class="c1"># constructible land in each type</span>
<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="n">coeff_land</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_coeff_land</span><span class="p">(</span>
    <span class="n">spline_land_constraints</span><span class="p">,</span> <span class="n">spline_land_backyard</span><span class="p">,</span> <span class="n">spline_land_informal</span><span class="p">,</span>
    <span class="n">spline_land_RDP</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># We import housing heigth limits</span>
<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="n">housing_limit</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_housing_limit</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>

<span class="c1"># We update parameter vector with construction parameters</span>
<span class="c1"># (relies on loaded data) and compute other variables</span>
<span class="kn">import</span> <span class="nn">inputs.parameters_and_options</span> <span class="k">as</span> <span class="nn">inpprm</span>
<span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">minimum_housing_supply</span><span class="p">,</span> <span class="n">agricultural_rent</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">inpprm</span><span class="o">.</span><span class="n">import_construction_parameters</span><span class="p">(</span>
    <span class="n">param</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">housing_types_sp</span><span class="p">,</span> <span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;dwelling_size&quot;</span><span class="p">],</span>
    <span class="n">mitchells_plain_grid_2011</span><span class="p">,</span> <span class="n">grid_formal_density_HFA</span><span class="p">,</span> <span class="n">coeff_land</span><span class="p">,</span>
    <span class="n">interest_rate</span><span class="p">,</span> <span class="n">options</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Import-flood-data-(takes-some-time-when-agents-anticipate-floods)">
<h3>Import flood data (takes some time when agents anticipate floods)<a class="headerlink" href="#Import-flood-data-(takes-some-time-when-agents-anticipate-floods)" title="Permalink to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># If agents anticipate floods, we return output from damage functions</span>
<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;agents_anticipate_floods&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="p">(</span><span class="n">fraction_capital_destroyed</span><span class="p">,</span> <span class="n">structural_damages_small_houses</span><span class="p">,</span>
     <span class="n">structural_damages_medium_houses</span><span class="p">,</span> <span class="n">structural_damages_large_houses</span><span class="p">,</span>
     <span class="n">content_damages</span><span class="p">,</span> <span class="n">structural_damages_type1</span><span class="p">,</span> <span class="n">structural_damages_type2</span><span class="p">,</span>
     <span class="n">structural_damages_type3a</span><span class="p">,</span> <span class="n">structural_damages_type3b</span><span class="p">,</span>
     <span class="n">structural_damages_type4a</span><span class="p">,</span> <span class="n">structural_damages_type4b</span>
     <span class="p">)</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_full_floods_data</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">path_folder</span><span class="p">,</span>
                                       <span class="n">housing_type_data</span><span class="p">)</span>

<span class="c1"># Else, we set those outputs as zero</span>
<span class="c1"># NB: 24014 is the number of grid pixels</span>
<span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;agents_anticipate_floods&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">fraction_capital_destroyed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_formal_2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_formal_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_subsidized_2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_subsidized_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;contents_formal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;contents_informal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;contents_subsidized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;contents_backyard&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_backyards&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_formal_backyards&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_informal_backyards&quot;</span>
                               <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
    <span class="n">fraction_capital_destroyed</span><span class="p">[</span><span class="s2">&quot;structure_informal_settlements&quot;</span>
                               <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
FU_5yr
FU_10yr
FU_20yr
FU_50yr
FU_75yr
FU_100yr
FU_200yr
FU_250yr
FU_500yr
FU_1000yr
P_5yr
P_10yr
P_20yr
P_50yr
P_75yr
P_100yr
P_200yr
P_250yr
P_500yr
P_1000yr
C_MERITDEM_1_0000
C_MERITDEM_1_0002
C_MERITDEM_1_0005
C_MERITDEM_1_0010
C_MERITDEM_1_0025
C_MERITDEM_1_0050
C_MERITDEM_1_0100
C_MERITDEM_1_0250
Contents in private formal
Contents in informal settlements
Contents in (any) backyard
Contents in formal subsidized
Private formal structures (one floor)
Private formal structures (two floors)
Formal subsidized structures (one floor)
Formal subsidized structures (two floors)
Informal settlement structures
Informal backyard structures
Formal backyard structures (one floor)
Formal backyard structures (two floors)
</pre></div></div>
</div>
</div>
<div class="section" id="Import-scenarios-(for-time-moving-variables)">
<h3>Import scenarios (for time-moving variables)<a class="headerlink" href="#Import-scenarios-(for-time-moving-variables)" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">equilibrium.functions_dynamic</span> <span class="k">as</span> <span class="nn">eqdyn</span>
<span class="p">(</span><span class="n">spline_agricultural_rent</span><span class="p">,</span> <span class="n">spline_interest_rate</span><span class="p">,</span>
 <span class="n">spline_population_income_distribution</span><span class="p">,</span> <span class="n">spline_inflation</span><span class="p">,</span>
 <span class="n">spline_income_distribution</span><span class="p">,</span> <span class="n">spline_population</span><span class="p">,</span>
 <span class="n">spline_income</span><span class="p">,</span> <span class="n">spline_minimum_housing_supply</span><span class="p">,</span> <span class="n">spline_fuel</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">eqdyn</span><span class="o">.</span><span class="n">import_scenarios</span><span class="p">(</span><span class="n">income_2011</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">path_scenarios</span><span class="p">,</span>
                            <span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Import-income-net-of-commuting-costs-(for-all-time-periods)">
<h3>Import income net of commuting costs (for all time periods)<a class="headerlink" href="#Import-income-net-of-commuting-costs-(for-all-time-periods)" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;compute_net_income&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="p">(</span><span class="n">incomeNetOfCommuting</span><span class="p">,</span> <span class="n">modalShares</span><span class="p">,</span> <span class="n">ODflows</span><span class="p">,</span> <span class="n">averageIncome</span>
     <span class="p">)</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_transport_data</span><span class="p">(</span>
         <span class="n">grid</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">households_per_income_class</span><span class="p">,</span> <span class="n">average_income</span><span class="p">,</span>
         <span class="n">spline_inflation</span><span class="p">,</span> <span class="n">spline_fuel</span><span class="p">,</span>
         <span class="n">spline_population_income_distribution</span><span class="p">,</span> <span class="n">spline_income_distribution</span><span class="p">,</span>
         <span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">path_precalc_transp</span><span class="p">,</span> <span class="s1">&#39;GRID&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

<span class="n">income_net_of_commuting_costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="n">path_precalc_transp</span> <span class="o">+</span> <span class="s1">&#39;GRID_incomeNetOfCommuting_0.npy&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Prepare-data">
<h2>Prepare data<a class="headerlink" href="#Prepare-data" title="Permalink to this heading"></a></h2>
<div class="section" id="Define-dominant-income-group-in-each-census-block-(SP)">
<h3>Define dominant income group in each census block (SP)<a class="headerlink" href="#Define-dominant-income-group-in-each-census-block-(SP)" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In one case, we base our definition on the median income at the SP-level:</span>
<span class="c1"># we consider as dominant the group corresponding to the highest income</span>
<span class="c1"># threshold is crossed</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_dominant_incgrp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">data_income_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;income&quot;</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;nb_of_income_classes&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">data_income_group</span><span class="p">[</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;income&quot;</span><span class="p">]</span> <span class="o">&gt;</span>
                          <span class="n">threshold_income_distribution</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>

<span class="c1"># In the other case, we just consider the most numerous income group in each</span>
<span class="c1"># census block</span>
<span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_dominant_incgrp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">data_income_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">income_distribution</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">income_distribution</span><span class="p">)):</span>
        <span class="n">data_income_group</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">income_distribution</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Although the second option seems more logical, we take the first one as default since we are going to consider median SP prices, and we want associated net income to be in line with those values to avoid a sample selection bias in our regressions.</p>
</div>
<div class="section" id="Obtain-number-of-formal-private-housing-units-per-SP">
<h3>Obtain number of formal private housing units per SP<a class="headerlink" href="#Obtain-number-of-formal-private-housing-units-per-SP" title="Permalink to this heading"></a></h3>
<p>NB: it is not clear whether RDP are included in SP formal count, and if they should be taken out based on imperfect cadastral estimations. For reference, we include the two options.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;substract_RDP_from_formal&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="c1"># We retrieve number of RDP units per SP from grid-level data</span>
    <span class="n">grid_intersect</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_data</span> <span class="o">+</span> <span class="s1">&#39;grid_SP_intersect.csv&#39;</span><span class="p">,</span>
                                 <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    <span class="c1"># When pixels are associated to several SPs, we allocate them to the</span>
    <span class="c1"># one with the biggest intersection area.</span>
    <span class="c1"># NB: it would be more rigorous to split the number of RDP across</span>
    <span class="c1"># SPs according to their respective intersection areas, but this is</span>
    <span class="c1"># unlikely to change much</span>
    <span class="n">grid_intersect</span> <span class="o">=</span> <span class="n">grid_intersect</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;ID_grille&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="s1">&#39;Area&#39;</span><span class="p">)</span>
    <span class="n">data_rdp</span><span class="p">[</span><span class="s2">&quot;ID_grille&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_rdp</span><span class="o">.</span><span class="n">index</span>
    <span class="n">data_rdp</span><span class="p">[</span><span class="s2">&quot;ID_grille&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_rdp</span><span class="p">[</span><span class="s2">&quot;ID_grille&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">rdp_grid</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_rdp</span><span class="p">,</span> <span class="n">grid_intersect</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;ID_grille&quot;</span><span class="p">,</span>
                        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>
    <span class="n">rdp_sp</span> <span class="o">=</span> <span class="n">rdp_grid</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;SP_CODE&#39;</span><span class="p">)[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">rdp_sp</span> <span class="o">=</span> <span class="n">rdp_sp</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">rdp_sp</span> <span class="o">=</span> <span class="n">rdp_sp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;SP_CODE&#39;</span><span class="p">:</span> <span class="s1">&#39;sp_code&#39;</span><span class="p">})</span>
    <span class="c1"># We just fill the list with unmatched SPs to get the full SP vector</span>
    <span class="n">rdp_sp_fill</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">rdp_sp</span><span class="p">,</span> <span class="n">data_sp</span><span class="p">[</span><span class="s1">&#39;sp_code&#39;</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;sp_code&quot;</span><span class="p">,</span>
                           <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>
    <span class="n">rdp_sp_fill</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdp_sp_fill</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rdp_sp_fill</span> <span class="o">=</span> <span class="n">rdp_sp_fill</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;sp_code&#39;</span><span class="p">)</span>

    <span class="n">data_number_formal</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">total_dwellings_SP_2011</span>
        <span class="o">-</span> <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">backyard_SP_2011</span>
        <span class="o">-</span> <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">informal_SP_2011</span>
        <span class="o">-</span> <span class="n">rdp_sp_fill</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>

<span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;substract_RDP_from_formal&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">data_number_formal</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">total_dwellings_SP_2011</span>
        <span class="o">-</span> <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">backyard_SP_2011</span>
        <span class="o">-</span> <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">informal_SP_2011</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<p>Given the uncertainty surrounding RDP counts, we take the second option as default and prefer to rely on sample selection (see below) to exclude the SPs where RDP housing is likely to drive most of our results</p>
</div>
<div class="section" id="Sample-selection">
<h3>Sample selection<a class="headerlink" href="#Sample-selection" title="Permalink to this heading"></a></h3>
<p>As the relations we are going to estimate are only true for the formal private sector, we exclude SPs in the bottom quintile of property prices and for which more than 5% of households are reported to live in informal housing (settlements + backyards). We also exclude “rural” SPs (i.e., those that are large, with a small share than can be urbanized).</p>
<p>We also add options to consider other criteria, namely we offer to exclude poorest income group (which is in effect crowded out from the formal sector), as well as Mitchell’s Plain (as its housing market is very specific) and far-away land (for which we have few observations).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_selected_density&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">selected_density</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="mf">0.2</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_number_formal</span>
           <span class="o">&gt;</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">total_dwellings_SP_2011</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">]</span>
            <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">],</span> <span class="mf">0.8</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">])</span>
        <span class="p">)</span>

<span class="k">elif</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_selected_density&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_mitchells_plain&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">selected_density</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="mf">0.2</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_number_formal</span>
           <span class="o">&gt;</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">total_dwellings_SP_2011</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">]</span>
            <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">],</span> <span class="mf">0.8</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">])</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_income_group</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span>
        <span class="p">)</span>

<span class="k">elif</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_selected_density&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;correct_mitchells_plain&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">selected_density</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="mf">0.2</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_number_formal</span>
           <span class="o">&gt;</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">housing_types_sp</span><span class="o">.</span><span class="n">total_dwellings_SP_2011</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">]</span>
            <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">],</span> <span class="mf">0.8</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;unconstrained_area&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">])</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_income_group</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;mitchells_plain&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_sp</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<p>We pick the second choice as our default since it is more conservative than the first, and less ad hoc than the third one.</p>
</div>
</div>
<div class="section" id="Calibrate-construction-function-parameters">
<h2>Calibrate construction function parameters<a class="headerlink" href="#Calibrate-construction-function-parameters" title="Permalink to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We estimate construction function parameters based on a log-linearization</span>
<span class="c1"># of the housing market clearing condition</span>
<span class="kn">import</span> <span class="nn">calibration.calib_main_func</span> <span class="k">as</span> <span class="nn">calmain</span>
<span class="n">coeff_b</span><span class="p">,</span> <span class="n">coeff_a</span><span class="p">,</span> <span class="n">coeffKappa</span> <span class="o">=</span> <span class="n">calmain</span><span class="o">.</span><span class="n">estim_construct_func_param</span><span class="p">(</span>
    <span class="n">options</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">data_sp</span><span class="p">,</span> <span class="n">threshold_income_distribution</span><span class="p">,</span>
    <span class="n">income_distribution</span><span class="p">,</span> <span class="n">data_rdp</span><span class="p">,</span> <span class="n">housing_types_sp</span><span class="p">,</span>
    <span class="n">data_number_formal</span><span class="p">,</span> <span class="n">data_income_group</span><span class="p">,</span> <span class="n">selected_density</span><span class="p">,</span>
    <span class="n">path_data</span><span class="p">,</span> <span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">path_folder</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
                            OLS Regression Results
==============================================================================
Dep. Variable:                      y   R-squared:                       0.665
Model:                            OLS   Adj. R-squared:                  0.657
Method:                 Least Squares   F-statistic:                     89.87
Date:                Wed, 21 Sep 2022   Prob (F-statistic):           4.10e-32
Time:                        17:50:31   Log-Likelihood:                -52.613
No. Observations:                 140   AIC:                             113.2
Df Residuals:                     136   BIC:                             125.0
Df Model:                           3
Covariance Type:            nonrobust
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
const         -3.7633      0.981     -3.837      0.000      -5.703      -1.824
x1             0.2415      0.069      3.483      0.001       0.104       0.379
x2            -0.8950      0.094     -9.533      0.000      -1.081      -0.709
x3             0.9949      0.070     14.283      0.000       0.857       1.133
==============================================================================
Omnibus:                       50.298   Durbin-Watson:                   1.587
Prob(Omnibus):                  0.000   Jarque-Bera (JB):              164.414
Skew:                          -1.329   Prob(JB):                     1.99e-36
Kurtosis:                       7.596   Cond. No.                         514.
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
[WinError 183] Cannot create a file when that file already exists: &#39;../Data/Precalculated inputs/&#39;
</pre></div></div>
</div>
<p>NB: The results are automatically saved for later use in simulations</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We update parameter vector</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_a&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeff_a</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_b&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeff_b</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeffKappa</span>

<span class="c1"># We print the calibrated values</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coeff_a = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_a&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coeff_b = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_b&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coeff_A = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_A&quot;</span><span class="p">]))</span>

<span class="c1"># We save them</span>
<span class="c1"># NB: coeff_a = 1 - coeff_b</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;calibratedHousing_b.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_b&quot;</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;calibratedHousing_kappa.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_A&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
coeff_a = 0.758489277045013
coeff_b = 0.241510722954987
coeff_A = 0.030595011996082885
</pre></div></div>
</div>
</div>
<div class="section" id="Calibrate-incomes-and-gravity-parameter">
<h2>Calibrate incomes and gravity parameter<a class="headerlink" href="#Calibrate-incomes-and-gravity-parameter" title="Permalink to this heading"></a></h2>
<p>We scan values for the gravity parameter to estimate incomes as a function of it. The value range is set by trial and error: the wider the range you want to test, the longer. In principle, we should find a value within a coarse interval before going to the finer level: this may require several iterations if the underlying data changes.</p>
<p>NB: we do that as it is too long and complex to run a solver directly.</p>
<p>Then, we select the income-gravity pair that best fits the distribution of commuters over distance from the CBD.</p>
<p>NB: we need to proceed in two steps as there is no separate identification of the gravity parameter and the net incomes.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We start by selecting the range over which we want to scan</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;scan_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rough&quot;</span><span class="p">:</span>
    <span class="n">list_lambda</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.51</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;scan_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
    <span class="n">list_lambda</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.42</span><span class="p">,</span> <span class="mf">0.441</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;scan_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fine&quot;</span><span class="p">:</span>
    <span class="n">list_lambda</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.427</span><span class="p">,</span> <span class="mf">0.4291</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We then run the function that returns the calibrated outputs</span>
<span class="kn">import</span> <span class="nn">calibration.calib_main_func</span> <span class="k">as</span> <span class="nn">calmain</span>
<span class="p">(</span><span class="n">incomeCentersKeep</span><span class="p">,</span> <span class="n">lambdaKeep</span><span class="p">,</span> <span class="n">cal_avg_income</span><span class="p">,</span> <span class="n">scoreKeep</span><span class="p">,</span>
 <span class="n">bhattacharyyaDistances</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">calmain</span><span class="o">.</span><span class="n">estim_incomes_and_gravity</span><span class="p">(</span>
        <span class="n">param</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">list_lambda</span><span class="p">,</span> <span class="n">households_per_income_class</span><span class="p">,</span>
        <span class="n">average_income</span><span class="p">,</span> <span class="n">income_distribution</span><span class="p">,</span> <span class="n">spline_inflation</span><span class="p">,</span> <span class="n">spline_fuel</span><span class="p">,</span>
        <span class="n">spline_population_income_distribution</span><span class="p">,</span> <span class="n">spline_income_distribution</span><span class="p">,</span>
        <span class="n">path_data</span><span class="p">,</span> <span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">path_precalc_transp</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Estimating for lambda =  2.673006408663311
incomes for group  0
1851.7384884125106
1726.922556291415
1607.5855723642817
1499.6984956805861
1395.0965082630237
1303.8191873740016
1228.6379305965968
1156.4325103341434
1089.3663955825516
1025.8606565696914
963.5330608546107
903.5374307944659
846.4372063236628
792.131638943886
741.6200628171991
695.2195263362236
651.5481684448284
611.2358037674336
574.5427732818285
541.2240942327214
511.3427540192505
483.595414491217
457.8622315267028
434.80863265833585
413.6399491044775
393.8085722231319
375.16481164114055
357.80698581414043
342.120509542107
327.4088688689164
313.68571021235607
301.02383176316556
289.3345249706213
278.8829888505457
269.09068531626707
259.8457888845183
251.08238928292946
242.74433033863917
234.71379758641208
226.95233233418995
219.45635294469483
212.24191943713708
205.2952559116232
198.59057716136866
192.1020484829186
185.81715348763868
179.7283020493135
173.8284191312132
168.11090449921932
162.57860352383275
157.23293205720572
152.05541717328182
147.03504425714246
142.1669880997488
137.4466842372118
132.86979872464212
128.43220181677427
124.12994533557928
119.95924337407318
115.91645591930579
111.99807496126415
108.20071267357159
104.5210912937535
100.95603438422677
97.5024592123279
94.15737004239591
90.91785218168799
87.78106666297366
84.74424547901117
81.8046873088056
78.95975369245785
76.20686562306733
73.54350053036168
70.96718963405894
68.47551564553764
66.06611079577368
63.73665516594497
61.48487529547408
59.308543040962654
57.20547465821158
55.17353007928785
53.21061235651449
51.314667246011865
49.48368290463725
47.71568967558951
46.00875994003579
44.36100801409343
42.77059007279841
41.237101127112126
39.7598246930405
38.33439010548097
36.960088094730224
35.63421831966018
34.35559042025312
33.12298557882621
31.934126124171428
30.787622641161665
29.683331929000154
28.61840957771573
27.59151938276578
26.601371264191258
25.64671210323246
24.726325234015633
23.83902989987467
22.98368067728613
22.159491359074945
21.36535952420705
20.59989948585978
19.862103404940484
19.150995371733035
18.465630710039207
17.805095269633718
17.168504709767806
16.55500377616009
15.963972882405297
15.394800414972426
14.846280216803185
14.317894278753537
13.809605496680426
13.319909988393567
12.848367052755192
12.393937670178149
11.956420497256946
11.535013409034807
11.129081840405217
10.737809383616263
10.360995462871077
9.998591939959313
9.64990114775381
9.314779156137483
8.991721210957781
8.680222385919542
8.380624977977805
8.091997811331277
7.8136493773563735
7.545206916261336
7.286817624967759
7.037715895293085
6.798187980697841
6.567206064888894
6.345342467099031
6.133446766047807
5.930762124346731
5.735142703094438
5.547038263576788
5.370002703349855
5.19997537121507
5.0360761931396825
4.878131801231489
4.72560570884972
4.578832441421091
4.436842052098054
4.2997733660283375
4.1673336737539275
4.039496199748664
3.917132304618481
3.79976616033487
3.686756928260492
3.578664390375101
3.4744177844504742
3.3749261030858855
3.2800273435087326
3.1892846236682857
3.1024408684838254
3.018541449394656
2.937613152862886
2.8593031781183074
2.7835048309821637
2.7099033135453485
2.6383515667120983
2.5692120379260857
2.5029425832704395
2.438495016326943
2.375862895229218
2.3149352304085045
2.255663798340279
2.1980645825057405
2.1421890131019916
2.0879230371682582
2.0351198501359784
1.9837324239169971
1.9337293565198372
1.8851382571037685
1.837842591374195
1.791806431761398
1.7469948696244946
1.7033739862769848
1.660977273467866
1.6197055096917865
1.5795239838651411
1.5404177748925012
1.502362898565538
1.4658051090695465
1.4308696119848192
1.3968216391546895
1.3636698702068248
1.3313843172960138
1.2999332964410777
1.2693671938741466
1.239586276315433
 - max iteration reached - mean error 0.0006624700558935639
incomes for group  1
1681.176398327469
1547.9612352051947
1440.8395806248652
1369.37414038316
1295.2014419431296
1226.8957165090656
1161.4129351524798
1101.5970091122135
1048.7224752401387
994.0961133732139
942.2067521828072
903.6245770406024
864.9020671852618
827.4153922389349
791.5607266453867
755.6243018729351
719.9333743675763
684.9848435850852
652.7477865744913
623.518616963453
596.5062593996347
572.2816012984842
549.5429416046732
527.7653815706125
506.858317606873
486.811269158208
467.60467495939156
449.77539442949296
432.73286291128886
417.5010748330062
403.18457326652816
389.99621759691405
378.8611868224526
368.2251257902987
357.8941116042897
347.636483190885
337.530651170394
327.4798424982776
317.49633647624563
307.5961956046683
297.79483678530505
288.10493644397513
278.6281094021227
269.27976576631835
260.24922993822975
251.3477951140682
242.58407934266688
233.9639047131494
225.49008473137738
217.1634081785791
208.9843141493124
200.95462592870177
193.0788405507566
185.36465800682248
177.82265755828035
170.46527842942677
163.30545475556679
156.35530004338386
149.6251271947143
143.12290728797967
136.85411415241484
130.82182622723428
125.02695719071971
119.46852645934788
114.14392512622797
109.04916373987888
104.17910253618012
99.52766746632184
95.08805312963736
90.85291100437665
86.81452006044613
82.96493706428265
79.2961250371415
75.80005973699592
72.46881525739471
69.29463068294473
66.26996019460931
63.387509152113935
60.64025859357748
58.02148037490671
55.524744892409004
53.14392303821203
50.873183757628325
48.706988325151
46.64008223690099
44.66748543293036
42.784481410013285
40.986605660899144
39.26963377543771
37.62956945837003
36.06263265457612
34.56524792193346
33.13403315221311
31.765788709322933
30.4574870301989
29.20626271490044
28.009403118533733
26.864339446668104
25.76863834808714
24.719993992900903
23.716220619840684
22.75524553383296
21.835102533121884
20.953925744143007
20.109943842093415
19.30147463502636
18.52691998974998
17.785153271047232
17.078375878623874
16.40099560191976
15.75171220930795
15.129288212366873
14.5325454634519
13.96036196369456
13.411668866995882
12.885447666582534
12.380727551672567
11.896582922603512
11.432131053668629
10.986529893695984
10.558975995077903
10.148702562664704
9.754977614593
9.377102247671653
9.014409000489746
8.666260307915387
8.332047041117775
8.011187127705496
7.703124246880143
7.407326594954307
7.123285716903991
6.850515399840871
6.5885506247509475
6.336946572898327
6.095277683742735
5.863136761250781
5.640134125827718
5.4258968092459945
5.220067790062259
5.022305267262603
4.832281969979007
4.649684501291031
4.474212714160656
4.305579117845007
4.1435083130478585
3.987736454304016
3.8380107381312123
3.6941899258805457
3.55632705797764
3.423768930159304
3.2963054571982204
3.1737351679470027
3.055864835130685
2.9425091221555784
2.833490246023958
2.728637655621202
2.6277877245520624
2.530783457825783
2.437474211717886
2.3477154261887074
2.2613683691640727
2.178299892243942
2.0983821971579033
2.0215362534925436
1.949383407050056
1.8815343152662207
1.8162065303179655
1.7539019555833795
1.6942005011733825
1.6368208957651689
1.5815806792521192
1.5283256953101112
1.4769822731486153
1.4277154846835838
1.380348243706897
1.334667079315709
1.2906097679656026
1.2481164212052107
1.2071293975185031
1.1675932174835628
1.1294544821364398
1.0926617944049326
1.0571656835153915
1.022918532272524
0.9898745070509484
0.9579894904600713
0.9272210165428463
0.8975282084165299
0.868871718293835
0.8412136697395359
0.8145176021500001
0.7887484172794674
0.7638723278554286
0.7398568080812393
0.7166705460332644
0.6942833978732637
0.6726663437705187
0.6517914455061913
0.6316318056762955
0.6123805568458826
 - max iteration reached - mean error 0.0005235262734921129
incomes for group  2
2996.5145301288576
2708.4533359413776
2528.3354570084834
2382.6512319896424
2279.78625634597
2170.067174906168
2093.8208386875026
2028.0536428752548
1974.9463108539808
1903.6794929832663
1792.1794878140295
1683.9837465104567
1576.6294595794805
1466.5680912699274
1372.4757358764766
1293.7386761054474
1225.8829877234261
1161.3938344081553
1094.2625662933503
1028.6259369943207
971.6733117908556
922.765229027667
886.9909408414131
854.452843121737
831.1483909125474
815.3440847849678
803.850303778077
790.5691378421768
773.9844720165327
757.1271759426114
739.9460367781376
721.3651474362566
699.5595414465582
675.3833397657646
649.9787188470214
624.1392617733827
600.4401989038308
578.4850150775262
558.8161707504003
539.2108439409282
521.7379145158867
503.4779134671552
485.6120142091088
467.7327150855181
450.6238642430418
434.07715487326726
417.92026200386414
402.5024825360564
388.06265424118294
374.6451530772711
361.70549281637983
348.8294038717887
336.1038078737447
323.7784116351502
311.8424980076344
300.39111701186044
289.4907332664892
279.1573630125776
269.3554820413932
259.94724606031957
250.91636179104862
242.2578844733284
233.97453689130927
226.0679551993371
218.55956660052217
211.51036907205594
204.87163499029867
198.68700322685683
192.845879870775
187.28309490719764
181.9900626686336
176.96309250567276
172.15250960023695
167.5181350614052
163.04378048752423
158.72933605049033
154.5917764291651
150.5493995108014
146.35908368826426
142.42486826924022
138.34910919457283
134.26523677613838
130.2107617832587
126.1476723081086
122.15589172517818
118.24243207779364
114.45651483042187
110.83109555504613
107.45783407471664
104.29338948426889
101.44098013059583
98.81264222511645
96.42692206467251
94.22552846278353
92.16732267283784
90.23057179625292
88.40492338217484
86.76819592983179
85.26532657328936
83.78997168828293
82.30480925253335
80.79818285026371
79.28344166056068
77.75688077888111
76.21452354582307
74.65521104934696
73.08094776541618
71.47893001125374
69.85030733457523
68.19810574005403
66.5248886041842
64.83735219428685
63.139689393298134
61.43131537578587
59.731482674018864
58.01116357180341
56.26877380145926
54.51200215211148
52.739902719568455
50.945111497124586
49.146119200068966
47.33607903465595
45.51310715837753
43.677802765900026
41.836182786277675
39.99520007656984
38.16642284432767
36.35315341585875
34.562918399785744
32.810046345558945
31.096926996065076
29.426370423380664
27.803784644489582
26.23284895223472
24.717217198119478
23.259717175666314
21.862386441851644
20.529885169194955
19.26181079209035
18.058682821911813
16.92152095066744
15.84993416752058
14.83518850670806
13.875944096007439
12.97175854167341
12.12039008389026
11.321552997451672
10.579132090131935
9.887049449804849
9.236724650820658
8.63219029388522
8.06870489862934
7.540680484903575
7.045963713103577
6.583919487392376
6.1526201250666785
5.7484839339926515
5.3699820234252655
5.01564426624182
4.684061442698501
4.373886439381042
4.083834665833343
3.812683829542709
3.5592731904739354
3.322502399023826
3.1013300060308278
2.8947717199827223
2.7018984749681225
2.5223059825226346
2.3549383197393645
2.1986904027207075
2.052840522096775
1.9168539997451983
1.790393936643248
1.6734882050510682
1.564656157645323
1.4635656553467373
1.3697925390713857
1.2824497339617709
1.200956339255688
1.1247778202644023
1.0536979253676142
0.9876109823694873
0.9259547173616189
0.8682551888536212
0.8142703366352237
0.7637989381518006
0.7165816400650581
0.6723774283337077
0.6309910340127415
0.5922398655638704
0.5559531989948948
0.5220118175023205
0.49027600524168846
0.460545601831751
0.4326911816486478
0.4065917433524398
0.3821543489658686
0.3592831710333687
0.3378433327712597
 - max iteration reached - mean error 0.0002078651226041427
incomes for group  3
2826.7313834927218
2779.785146470289
2698.9341411419928
2620.4483035769476
2587.0230917014987
2578.4646343960612
2558.5381596445077
2543.1687494882103
2531.023801401285
2525.2353094460555
2514.502918847283
2489.722313162223
2460.249029475309
2448.412993410477
2441.7372922821305
2435.5334407606306
2429.557643985796
2426.0010152721347
2423.0956412687237
2408.54163477042
2356.4155664620266
2306.88851527419
2276.3697778009496
2207.9965439883044
2147.6758810940228
2083.3115311948527
2040.974183477673
2003.5011870464914
1970.48463936993
1936.262571543251
1906.9141026690793
1874.485204332836
1845.444024948693
1820.0857906299605
1793.6829327771252
1752.7170836383248
1721.814029327629
1707.5672914033737
1703.0700880595414
1692.1877234753888
1682.2089459630208
1674.1357018780986
1659.844264094626
1641.8587544382706
1627.2229806618275
1616.74264283989
1606.944717149258
1594.4279953425155
1579.7231329171434
1561.5736551710356
1534.6254491500413
1501.2492255375453
1478.4073858770523
1436.8776742591563
1389.9339940820578
1342.0290280624201
1276.192930284429
1249.5224690600955
1220.4333983136526
1204.8817246583465
1196.472935717453
1187.4815090661166
1165.8867359396138
1124.7801767282533
1068.5809446788696
1020.4058229268775
992.9954650024487
985.0796933860609
977.9547009606681
970.6844996447738
962.2020103583227
953.2680375262436
947.6155056034086
943.668806647184
940.4886447058819
937.0005557764277
932.1532327025931
924.5720912663995
911.7927149552426
896.1404083904238
875.9232383676917
854.9403756684126
833.9296631346386
812.0584896325432
785.7391248366677
757.1124258219905
736.2266856884836
715.6434186859965
691.7096234273581
668.502331500229
647.2700405457059
629.002517822955
613.7972870652723
598.0336854624057
582.8556590733357
570.1548164134797
559.1926414562272
550.3031352955999
543.1472276649113
537.6146170959805
532.6769347196647
528.3400596999396
522.3185507971609
514.470356359093
507.81469757218514
502.04266769244424
497.87213309207254
494.23072796300227
491.7888730216399
490.85373548805853
490.0986229448544
488.6121068439296
485.34314111432
480.1952048445928
474.99032178232596
471.3101267034834
468.9496565524894
467.3623454389895
466.1263275743227
464.94151708148416
463.20059193416995
458.59254619212936
449.92055411273856
438.9554840016306
428.12241917278317
413.1860998542155
395.2976134793038
380.0825420013172
367.3773052877107
355.02491729954744
343.3210203267077
332.6371530259369
323.546815222849
315.41281378510496
308.30223014804864
302.46371061426885
297.2966316106766
292.6747388840461
288.8488973368803
285.3584062842229
282.31716678280617
279.7248412902697
277.29047897363785
275.1795478838122
273.1261083574112
271.0735367331999
268.9152491890172
266.42905777720864
262.86416363132867
259.1888325185533
255.52964196970672
251.8520330552989
248.5494894994551
245.7605702709467
243.11550459552146
240.40996124010826
237.4370129320174
233.84929706450504
228.67845032501077
220.20885275906065
207.46553789994596
196.14721998898793
189.16447240039892
183.67794335315597
179.0582147244574
175.12650459811246
171.36192829669332
167.76125702508088
164.5391345715675
161.29687448005143
157.98814453410148
154.74761239240414
151.88768109482479
148.88712238703567
146.33818085438045
143.82508775652994
141.34752052300962
138.99495127409807
136.7699133088758
134.67544075745536
132.642291474214
130.62136182185785
128.63372046210077
126.69545866547121
124.8309504197586
123.17530337096439
121.57946629316379
120.03533773903902
118.55707281881021
117.15623695643528
115.79632583740683
114.44264382852336
113.08299500162315
111.69024215300091
110.23620704234419
108.72554709374394
107.17548364623978
105.6190459063265
104.09611235366592
102.63781778210382
 - max iteration reached - mean error 0.07736566807365537
Estimating for lambda =  2.679168324819032
incomes for group  0
1853.2389060683768
1728.4308816476348
1608.9893719293696
1501.0335751937841
1396.3026118191563
1304.9844925009872
1229.7143259076756
1157.4607138966753
1090.3391661847177
1026.7791380889967
964.3695462096222
904.2811061106976
847.0812318988701
792.6820429546362
742.0304626038675
695.5536999097767
651.8078203958048
611.4133633457918
574.6675513430134
541.3038116670845
511.39109452100934
483.6163504086372
457.8650859850811
434.8013977285166
413.62765355550783
393.79340673143855
375.14624872195935
357.79742646001296
342.11562942752624
327.40695875783814
313.6931057764245
301.04201773945306
289.3753424127137
278.9527371614974
269.16514445342716
259.926850676337
251.16938298760397
242.83600863930747
234.807729047123
227.04836488983202
219.55605618857166
212.3407102566207
205.39586248380243
198.69410187061553
192.20687204487092
185.92304856273526
179.83504162711034
173.9357802558202
168.21867135407714
162.68642302976372
157.34154879541913
152.16398299976234
147.14337538503628
142.2749132528399
137.55404482514368
132.9764487098297
128.53800735156403
124.23478424123724
120.06300452317957
116.01903857190305
112.09938809355474
108.30067432707628
104.61962796322919
101.05308045462323
97.59795644876776
94.25126713235333
91.0101043254851
87.8716352066032
84.83309758249041
81.89179564292265
79.04509615736886
76.29042508273191
73.62526455790693
71.04715026406643
68.55366913036947
66.1424573638959
63.81119878109741
61.55762341622162
59.37950638070313
57.274666946182286
55.24096782333739
53.27631460870432
51.378655372124356
49.5459803587194
47.776321780634746
46.06775367584846
44.418391813163915
42.8263936250636
41.291381675948244
39.812588878704375
38.3856865887822
37.0099400667366
35.68265895295688
34.40246781533366
33.168526723524685
31.97836461339951
30.830691958497333
29.725175721148425
28.659051651284116
27.630991992900892
26.639706351749002
25.68394123321051
24.76247954137184
23.874140042264163
23.017776794215052
22.19254677213175
21.397463793273648
20.631080839222978
19.8923894486383
19.18041307412204
18.49420639016024
17.832854589045247
17.195472667501196
16.581204706484762
15.989488232768238
15.41959567642108
14.870377671036929
14.341357249525473
13.832416633238317
13.342145228172491
12.86999045225516
12.414984830198218
11.976894789860806
11.554971909066547
11.148502673274566
10.75670901260302
10.379478537376785
10.01658714559373
9.667499216322646
9.331924630368443
9.00842676495808
8.696501056630115
8.396554618467361
8.107527924419674
7.828791579266966
7.560012020995588
7.301279261974498
7.051922057362901
6.812050255113802
6.580725811942467
6.358913665009813
6.146950735370624
5.943998654273862
5.748081963117687
5.560104582192155
5.383244903331108
5.213017659958919
5.048925090346702
4.890787225812928
4.7381180122923
4.59109459331252
4.448859460129177
4.311618630624822
4.178944742894523
4.051084731664127
3.9287891205915537
3.8112022380177306
3.6983057750559487
3.590028182722621
3.485711832020534
3.3863656191895077
3.2916540612890164
3.200745761991285
3.1137370095354764
3.029753123275462
2.9487019862319737
2.870265486476984
2.7943353232410884
2.720550755132088
2.6488186399687526
2.5795566435146666
2.5131141673117185
2.4485139541381287
2.3857135327382175
2.3246199772939904
2.2651850439197956
2.207474805839922
2.1514577889486795
2.0970413267864108
2.0440835272379103
1.9925437450798078
1.9424137941049056
1.8936745668697201
1.8462329638779953
1.8000530369363488
1.7550998565499452
1.7113591676291422
1.6688287394162988
1.6274215138904637
1.587106582227654
1.5478807436724014
1.509696378730804
1.4730772400994452
1.4380189714728984
1.4038500113635684
1.3705979527556145
1.3381947601923354
1.3066634388334482
1.2759942071094295
1.2461002635009164
 - max iteration reached - mean error 0.0006656752480600432
incomes for group  1
1681.6123381442717
1548.4092939516077
1441.131121826362
1369.7140711431723
1295.5155772694245
1227.2070867410887
1161.674728633351
1101.8342431368433
1048.9541879843632
994.2978885045421
942.312515950461
903.7384424674547
865.0170801304539
827.5112743538958
791.6625897717146
755.7300497178587
720.0392009404455
685.0869352362006
652.8279281976719
623.602791867077
596.6105815376662
572.3845649721055
549.6589859880844
527.8875382536066
506.9859377557753
486.94374280341134
467.74142223325606
449.91492820688114
432.85908178603626
417.62193040936984
403.30286420305504
390.12789647049937
378.99888332779506
368.3590344498462
358.03341442807675
347.77821346722016
337.6761151662101
327.62801843729994
317.64619772851796
307.7467718115019
297.9452429920359
288.2543814890157
278.77510498806913
269.42139998042643
260.38514356855984
251.4811019946035
242.71469399151516
234.09186483206835
225.61548618660694
217.28633908342624
209.10480428253737
201.0726211603695
193.1942054096232
185.47720217634352
177.93217528859117
170.57158694645963
163.40842052271773
156.45484847003263
149.7212382287727
143.21560316131965
136.9434456935445
130.9078619344871
125.1097765153883
119.54821674067858
114.22058073667264
109.12288601484543
104.24999953312857
99.59585314081806
95.15364591998714
90.91603202742188
86.87529117567783
83.02347902604295
79.35255588206651
75.85449348090128
72.52136091919517
69.3453916161431
66.31903368700813
63.4349862466937
60.68622408364715
58.06601293093843
55.56791728412816
53.18580242206311
50.91383200586116
48.74646237804481
46.67843446419161
44.70476399409089
42.82073060592437
41.02186627167389
39.30394338095461
37.66296273934456
36.09514167301725
34.59690238058849
33.16486063312976
31.795814892072016
30.486735890532607
29.23475670487983
28.037163329175378
26.89138575431159
25.79498954566547
24.745667907265116
23.741234216343027
22.779615009223626
21.85884339785171
20.97705289506607
20.13247162649522
19.32341690685624
18.54829015885303
17.807108970840034
17.099735050091365
16.421771834874104
15.771918816686318
15.148938246908093
14.551651731744142
13.978937037930882
13.429725094764226
12.902997179008832
12.39778227010556
11.913154564104953
11.448231135506978
11.002169736980933
10.57416672769597
10.163455121657453
9.76930274808677
9.39101051642752
9.027910779196738
8.679365786253623
8.344766224700951
8.023529838903547
7.715100125603273
7.418945099413798
7.134556124370716
6.861446807458972
6.599151950382801
6.347226556064011
6.105244886600122
5.872799569686663
5.649500750646398
5.434975287430872
5.228865986151842
5.030830874809207
4.840542513136033
4.657687336430761
4.481965031652288
4.313087943871401
4.150780511518399
3.9947787288550085
3.844829634169375
3.7008904929612942
3.5628128373705135
3.4300461637023383
3.3023802314374993
3.1796134166870993
3.0615523420077153
2.9480115232383293
2.8388130324460783
2.7337861762202555
2.632767188526562
2.5355989373973733
2.442130644824047
2.3522176191243824
2.2657209992787717
2.1825075105867757
2.1024492311385123
2.0254233685622958
1.9528762783466789
1.8849006992801316
1.8194505220332755
1.7571809982954296
1.6973585289407
1.639900076773843
1.5845449979317279
1.5311789865146135
1.4797282554142126
1.4303745688067535
1.3829053735382137
1.33712572838943
1.2929733015799547
1.2503880993866925
1.2093123779229495
1.1696905582149684
1.1314691445475296
1.0945966458041028
1.0590234998574397
1.0247020007385208
0.9915862286161174
0.9596319823858026
0.9287967148014644
0.8990394700829398
0.8703208238615632
0.8426028253865339
0.815848941946009
0.7900240053566642
0.7650941604871172
0.7410268157419261
0.7177905953972201
0.6953552937527626
0.6736918310049715
0.6527722108076515
0.6325694794184784
0.6132334444763532
 - max iteration reached - mean error 0.0005238922833288978
incomes for group  2
2996.900715260266
2708.726917938498
2528.6467209858693
2382.899768333831
2280.0531416175495
2170.2467226875674
2093.9395171836327
2028.1981640511856
1975.1920633700306
1903.9794539732977
1792.4784648927407
1684.2213549947637
1576.8577922861764
1466.823482057834
1372.6537096689465
1293.9362424181836
1226.084851449511
1161.6170991757458
1094.4654850475072
1028.787040331172
971.8338880693443
922.8783090943226
887.0842123214547
854.5044053777918
831.1746160693599
815.3752728893467
803.9002528950278
790.6258917984729
774.0414302728481
757.1855512608305
740.0243225260152
721.4630249869886
699.677724937526
675.5198323575308
650.1396814521233
624.3069215652403
600.5869918907879
578.6188899437805
558.9542968476252
539.3457094317753
521.861860152615
503.5955055240937
485.72345701378674
467.8387490169742
450.73258937662615
434.1782728131994
418.0149538091987
402.5891041570196
388.14341441972323
374.72558238797177
361.78283095551535
348.90103613939084
336.16944747086353
323.8371993050322
311.8945123001416
300.4371282105305
289.5312452690137
279.20153798942886
269.39619661907375
259.9847194749141
250.95064114723414
242.28889400592402
234.00222248262727
226.0923669378528
218.58068477885286
211.52373752545986
204.88137305107986
198.69198543743641
192.8494944699909
187.28563961262498
181.9907876672805
176.96390509712498
172.15318694275953
167.5189341898942
163.04524227185215
158.7314627960196
154.5946033229656
150.55394585018303
146.36097504496544
142.42777902984125
138.35193171911536
134.2651228461381
130.20882344994973
126.14478763934576
122.15055887476326
118.23481246265072
114.44665601184902
110.819276074733
107.44533213992611
104.28030235910771
101.42801314783104
98.8009729397052
96.41612703311534
94.21587524654285
92.15874149541983
90.22336022446736
88.4014736346088
86.7683716425107
85.26703175979854
83.792827540508
82.30853597707151
80.8029147916106
79.28870093251102
77.76170953984764
76.22078535646793
74.66230610786151
73.09011251856599
71.48886060607182
69.86095761467335
68.20944144447007
66.53689042197522
64.84994536700431
63.15292816721029
61.444907365010785
59.745671696198066
58.02593493870355
56.284088537146104
54.527463575976746
52.755750962436835
50.961624058032605
49.1617935675607
47.351650221890225
45.528403126988
43.69262399775267
41.85033704623633
40.00841290075178
38.17808735609303
36.363708524488445
34.57227269412235
32.81722099614514
31.102842844734948
29.431354330734493
27.807522730935275
26.235383180124433
24.718605944741558
23.260031367517772
21.861705951715173
20.528417545335923
19.259521708221204
18.055345250656075
16.917302880165504
15.84517905965818
14.8299748420251
13.870346101477711
12.965675322330199
12.11406483453909
11.31453786157932
10.571845698027584
9.879428431541616
9.22910366854213
8.624392585492858
8.060965649209328
7.533004490233232
7.038398685187055
6.5761450442862115
6.145027220984257
5.741084656624399
5.362785979607449
5.008658838160892
4.677292028109285
4.367336675143325
4.077506634654874
3.806578250171524
3.553389591700679
3.31683927828351
3.0958849733200204
2.889541627934576
2.6968795360677413
2.517439850301228
2.3502761279365565
2.194226964390234
2.0485703714275436
1.9127249714397945
1.7864165909780665
1.6696110961336217
1.5608736797381673
1.4599569240261823
1.3662764159848018
1.2790972190633365
1.197745183763717
1.121718133035611
1.0507460814626741
0.9847817889117227
0.92326068105793
0.865690477244653
0.8118331754750624
0.7614814761924446
0.7143766268326728
0.6702797792029621
0.6289958467469314
0.5903424192890219
0.5541489523628196
0.5202937972935329
0.4886407999250488
0.45899102168716926
0.43121338383934066
0.40518704671418554
0.3808162149415982
0.3580112817702332
0.336634468058249
 - max iteration reached - mean error 0.00020713382723845457
incomes for group  3
2826.7506290717615
2779.8039970686095
2698.925941976287
2620.4374323501056
2587.032038056813
2578.4815502315564
2558.530294791567
2543.164940766239
2531.0263796311347
2525.2440222675527
2514.523220864382
2489.748839469888
2460.2483584438983
2448.412770045109
2441.7400222633
2435.5325492025618
2429.551466083081
2425.9986628382208
2423.109769180832
2408.579861029219
2356.424405858469
2306.8902018246363
2276.4104135280545
2208.0209558031274
2147.6899527745168
2083.3420210027116
2040.9996109311935
2003.5509367274053
1970.5056805304807
1936.257600747747
1906.91540781191
1874.4735344422395
1845.4413896336414
1820.1198231996216
1793.7980499070845
1752.8717155961085
1721.8971224676498
1707.5698394294557
1703.08064273608
1692.2030586557437
1682.221757290682
1674.1477275567497
1659.8355808755848
1641.83880031218
1627.2008602979347
1616.7291542546247
1606.9387106261722
1594.419556201386
1579.72382799246
1561.590989166266
1534.6625069235845
1501.2743692759443
1478.4817542886942
1436.9530948092424
1390.0394900716847
1342.124446401816
1276.1658170669646
1249.5767517975328
1220.464776148551
1204.8829792562908
1196.4911422239102
1187.538778729876
1165.961026332729
1124.8295987783326
1068.5651858183037
1020.2981525375076
992.9749874249437
985.071465326109
977.9569698057257
970.6936510211927
962.2076066146086
953.2532546411189
947.5972178541209
943.6549941910703
940.481584567502
937.0008393479844
932.164581489203
924.605701201034
911.8335045933065
896.1886545233369
875.9600382938474
854.97701459998
834.0011451704289
812.1549127528123
785.8356973613497
757.2049907043156
736.312773852389
715.7244624140078
691.7711746469079
668.5505954013533
647.316030348348
629.0772900814303
613.8513238066796
598.081839702977
582.873333072861
570.1660621366342
559.2017702724515
550.3135132319727
543.1604981299629
537.6265692486337
532.7016998288389
528.3587834111792
522.3355787215557
514.4748695614784
507.8227534966154
502.04063455174577
497.86692563216945
494.2247793762371
491.78286576154795
490.85268373124126
490.10159322573224
488.61746163235273
485.3475440710227
480.1880108131645
474.9751413025165
471.29599655294294
468.9395132103574
467.3566858751729
466.12628376825614
464.9542370716817
463.22953835531183
458.65020354851794
449.98005092170973
439.0297407360218
428.18253699181446
413.23905778814685
395.3224415037146
380.10256827946824
367.3898934622944
355.0343106375495
343.32686010022087
332.63875210858697
323.54455779113755
315.407462167243
308.2978496198875
302.45969032506986
297.29400488338774
292.6741557717274
288.8551526873795
285.3669184291344
282.33361564460324
279.7430412312403
277.3136776889086
275.20417680056767
273.1524437656418
271.1023453794138
268.9445991256288
266.46419002648076
262.89816121360303
259.2238422868257
255.56022971195628
251.8792289788919
248.56264238963547
245.7713946540889
243.12578018324544
240.42078691498986
237.44951246596145
233.8714686618171
228.71920682610627
220.2745763828882
207.5400377816933
196.18393438934484
189.20920059438214
183.72657279379723
179.10186798114384
175.16912075714984
171.4043988206682
167.80032364174235
164.57748878671933
161.33370302218444
158.02396019953898
154.7867006323776
151.92634448163028
148.92196469093892
146.37361519486328
143.85884287522802
141.37986885584428
139.02569616263014
136.7995109963078
134.7045232200571
132.67066051412385
130.6488266977013
128.6598227939592
126.71999663595346
124.8534862966439
123.19562968428582
121.59866485672931
120.05361414793715
118.5743758231507
117.17239894975762
115.81217328862176
114.45786727943005
113.09762643185353
111.70458191105772
110.25008179126408
108.7387544074349
107.18782558489676
105.63040104345517
104.10648048732808
102.64735588554007
 - max iteration reached - mean error 0.07737078820051123
Estimating for lambda =  2.685344445658507
incomes for group  0
1854.734188159512
1729.9346751549779
1610.3938462299302
1502.3649134857894
1397.5052516715618
1306.1467375583877
1230.7881513350687
1158.4868258734623
1091.3103251022997
1027.6964226239904
965.2090891865425
905.0241046751601
847.7246891615828
793.2320130891205
742.4405361697113
695.8875966854677
652.0672043947451
611.5905890228638
574.7920325693822
541.3832186085617
511.43916318072536
483.63704533419696
457.8677558429587
434.79395359500865
413.61518060948487
393.7780953937605
375.1275804423386
357.78807422700964
342.11061327067307
327.40491364140007
313.7007183206737
301.06003799321
289.42020358204564
279.0222867947652
269.23938304890476
260.0076809234202
251.25612540346677
242.92743581480664
234.90142503891508
227.1441771225519
219.65554787645104
212.43929504011092
205.4962774600099
198.79744566963592
192.31152798731466
186.02878856184287
179.94163793751224
174.04300922476835
168.32631652917019
162.79413001966216
157.45006222504028
152.2724554005769
147.25162260993247
142.38276374178548
137.66133977384217
133.0830419266668
128.64376488263107
124.33958383601522
120.16673500346579
116.12159915520714
112.20068771028231
108.40063095986496
104.71816802699084
101.15013822761749
97.69347355861343
94.3451920961101
91.10239213961101
87.96224698061648
84.9220002092529
81.97896149821456
79.13050282187803
76.37405508031537
73.70710510495297
71.12719302589308
68.63190998150633
66.21889615023336
63.88583908261228
61.6304723097585
59.45057420290965
57.34396705702079
55.30851637107381
53.34213029731288
51.442759232286676
49.608395523534476
47.83707326721259
46.126868173723956
44.47589748062181
42.88231989402245
41.345781254552165
39.865472520744476
38.43710275463275
37.0599117608892
35.731219177279655
34.44946244250851
33.214184734664244
32.02271946968829
30.87388734161391
29.7671361221286
28.699809466846574
27.67057938473771
26.678155176563415
25.721282980566475
24.798745278987806
23.909360368216593
23.05198179558322
22.22570890608547
21.429673434284336
20.66236618046509
19.922778066373883
19.209931911854312
18.52288174661314
17.860712109645522
17.22253733897121
16.60750085428633
16.015096907146
15.444482767877325
14.894565461382943
14.364907839721955
13.855313955024359
13.364464867424685
12.891696839594697
12.436113343778674
11.997449052040231
11.575008682857906
11.168000429342515
10.775684227507742
10.398035129910685
10.034654598208359
9.685166948217415
9.349138470685357
9.02519952419688
8.71284578608389
8.412548370494271
8.123121070700874
7.843995750306442
7.574899456080365
7.3158004705942625
7.066186304469512
6.825969655153108
6.594301466674772
6.372538555310002
6.160506251931705
5.957285823471123
5.761075380878746
5.573531744679321
5.396532368937842
5.226104472681206
5.061817812042245
4.903485834985572
4.750672714829941
4.603398733480517
4.460928403600973
4.3235048613091855
4.190596385976291
4.062755885456854
3.9404845512840807
3.822703171027517
3.709891825541908
3.6014716377185967
3.497054138155206
3.3979632404942155
3.3033478712831266
3.212244149846723
3.125072141218293
3.0410429008938973
2.9598485269049566
2.8812935440280705
2.805203827591734
2.7312360376965215
2.65935043037456
2.589940240621133
2.523324514949441
2.4585714379265173
2.3956024782828163
2.334342788676675
2.2747441051602846
2.216922572562196
2.1607702502720785
2.1061966477135967
2.053083979534177
2.0013915808373715
1.9511344815048226
1.9022468608589673
1.8546590511223693
1.808335083727968
1.7632400085463167
1.7193830965322907
1.676714849411472
1.6351718790469005
1.5947243266044002
1.5553775127849638
1.5170633699426355
1.4803830004974536
1.445201677098449
1.410920670496475
1.3775588464463255
1.345037726754711
1.3134283329259184
1.2826532910135806
1.2526460324173951
 - max iteration reached - mean error 0.0006688967994940419
incomes for group  1
1682.0461147636022
1548.8557428802449
1441.421451894352
1370.0528708082106
1295.828666199376
1227.5174730534495
1161.9354381015805
1102.0719424098793
1049.1849758085643
994.498761499303
942.4173235731955
903.851405100131
865.1312530789031
827.606360886727
791.7637355628616
755.8351759074295
720.1445019634726
685.1885770138166
652.9076139178474
623.6865514287053
596.7145179750012
572.487153015768
549.7746695679663
528.0093662065527
507.1132625641312
487.0759558920666
467.8779449269453
450.0542712913567
432.9968261898527
417.74264851231356
403.4210187229001
390.25936086585705
379.13638414440476
368.49276655515064
358.1725587686499
347.919805819425
337.82146122375264
327.7760958222981
317.79597791965705
307.897281317019
298.0955925220638
288.4037744279715
278.9220620802268
269.5661790594278
260.5210021849598
251.6143350668404
242.84521381784285
234.21970922434645
225.74075303245016
217.40911970751398
209.22513203503163
201.1904450924826
193.30939236670827
185.5895632227561
178.04150542034026
170.6777039854238
163.51119180640353
156.5542007621114
149.81715325474775
143.3081051197055
137.0325872828666
130.99371319507856
125.19241798910733
119.62773639271781
114.29707316757487
109.19645249631532
104.32074787772319
99.66389697139003
95.21910332163347
90.97902378486589
86.93593885815356
83.08190314586075
79.408874279599
75.90882001458039
72.57380448091584
69.39605545432589
66.36801499882556
63.48237599276298
60.73210697831605
58.11046756547179
55.61101634621937
53.22761298155674
50.954415842778516
48.785876334294954
46.71673080489556
44.74199076804817
42.85693199768406
41.05708293993959
39.33821277976975
37.69631941987697
36.127617564775235
34.62852705160363
33.19566152926902
31.82581755593456
30.515964160792432
29.263232897006333
28.06490839866694
26.91841944355195
25.82133051565315
24.771333855352623
23.766241981150714
22.803980663852883
21.88258233242952
21.000179889663187
20.155000915324383
19.345362234615227
18.569664830074935
17.829071896081896
17.12110262639912
16.442557557521198
15.792135908522981
15.168599674969576
14.570770221190685
13.997525083706858
13.447794971299162
12.920560948207456
12.414851787928926
11.929741485938258
11.464346920508747
11.017825651589913
10.589373848435613
10.178224337388137
9.783644761788427
9.40493584663166
9.041429761133939
8.692488572808578
8.357502787216593
8.035889967888599
7.727093431391672
7.430581012808267
7.145843897310062
6.872395513700088
6.609770486254523
6.357523641290655
6.115229065198772
5.882479210975412
5.658884050316898
5.444070268746755
5.237680501229093
5.039372606019815
4.848818974571101
4.6657058755182685
4.489732830805066
4.320612022272268
4.1580677269724555
4.001835779705033
3.8516630613273293
3.7076052516546887
3.569312563449996
3.436337096106573
3.308468454419898
3.185504862318246
3.0672527927063857
2.953526614337952
2.8441482547856003
2.738946878754886
2.6377585809520463
2.540426092793311
2.4467985022855836
2.3567309864157773
2.2700845554792246
2.1867258087240486
2.1065267008222985
2.0293643186106984
1.9563776903922714
1.888275379076352
1.822702568535577
1.7604677978301533
1.700526362500745
1.6429865063258104
1.5875163513424029
1.534039102190887
1.4824808555260869
1.4330404200515625
1.3854690553356888
1.3395907186361202
1.29534296996778
1.2526657103379695
1.2115010934682493
1.1717934408494162
1.1334891599791552
1.096536665694106
1.06088630445604
1.0264902815173036
0.9933025907929552
0.9612789474193764
0.9303767228320036
0.9005548822990508
0.8717739248136667
0.8439958252670168
0.8171839787812556
0.7913031471665479
0.7663194073868753
0.7422001019909001
0.7189137913795776
0.6964302079319822
0.6747202118132078
0.653755748475223
0.6335098077796507
0.6140886675070428
 - max iteration reached - mean error 0.000524258736779616
incomes for group  2
2997.2854319977205
2708.999374686977
2528.9569797495556
2383.147584749622
2280.319473309183
2170.4257728284456
2094.0574317142305
2028.3416751399002
1975.4367649377375
1904.2783890041894
1792.7766313754435
1684.4579728650372
1577.0852567591512
1467.078127286859
1372.830891389658
1294.1332697425719
1226.286285471712
1161.8399346788312
1094.6680386113528
1028.9479335794515
971.994313358572
922.9912052158884
887.1773528240295
854.5558225994595
831.2006361603109
815.4062471671464
803.9498812926441
790.6823097776648
774.0979980398844
757.2434220718396
740.1020669406603
721.5603244384225
699.7953085469841
675.6556985078685
650.3001095796357
624.4741436673593
600.733364643008
578.7523906360332
559.0920799171921
539.4802613370109
521.9855909138355
503.7129447492903
485.83476565031634
467.9446764788741
450.84322582055967
434.2793749118818
418.10964294996273
402.6756951399427
388.2241186648068
374.8059379169542
361.86009494571226
348.97259116082165
336.2350024838459
323.8958948721844
311.94642563237204
300.48303278303575
289.5716504880217
279.24560590924636
269.436806153406
260.02209411367903
250.98483081433815
242.31982317252687
234.02983589075708
226.11671330320237
218.60174214119363
211.5370529459062
204.8910619391043
198.69693540448569
192.85307948034875
187.28815675101566
181.99148602048214
176.9646922146666
172.15383848903986
167.51970732706837
163.04667614976682
158.73356500693944
154.59741268733802
150.5584807777634
146.36285494846064
142.43068136655728
138.35474710823038
134.26499891623874
130.20687109061961
126.14187893941063
122.14519848023937
118.22716426437506
114.43676749808719
110.80742328554436
107.43280409653123
104.26719531804258
101.41502584035965
98.78928536143408
96.40531889241625
94.20621163050059
92.1501520791692
90.21613960868626
88.39832494488473
86.76852077070122
85.26870376630286
83.79564416330396
82.31221812622573
80.80759652666426
79.29390737333908
77.76648843041997
76.2269933071847
74.6699934818082
73.09921648737985
71.4987297887795
69.87154600657755
68.22071479610331
66.54882941233538
64.86247598395045
63.16610406239834
61.45843750681635
59.75979905551837
58.04064556019501
56.299344270925666
54.54286815046125
52.771545441440836
50.97808640737939
49.17821822419654
47.36718428948401
45.543665260346906
43.70741431171899
41.86446284505671
40.021697839641654
38.189728220782136
36.37424104453626
34.581605168843275
32.824374734237075
31.10873821791293
29.436319039340706
27.81124209669158
26.237899293505926
24.719977338517555
23.26032913346556
21.861010123407993
20.526936279963714
19.257220295878767
18.051995974927703
16.913074240678352
15.840414892453214
14.824753655153787
13.864742123644136
12.959587324842099
12.107736311650907
11.307519935985516
10.564720866897686
9.871806710680337
9.221483199004696
8.616595501526053
8.053249663749806
7.525331079982048
7.030836942920203
6.5685793275756525
6.13743898743244
5.733690734593162
5.355595899714428
5.0016799093991615
4.670529578463002
4.360794275487601
4.071186305686814
3.8004806526632464
3.547514200594811
3.3111845412409178
3.090448454542262
2.884320138181593
2.6918692496934957
2.512582307085941
2.3456225143167355
2.1897720655791417
2.0443086967870228
1.9086348094592493
1.782478059406627
1.6657419326221266
1.5570988854836931
1.456355752815394
1.362767591102739
1.27575186779296
1.1945410238280814
1.1186652929191165
1.0478078280675762
0.9819605310632665
0.9205729381740595
0.8631319010809317
0.8094019841147505
0.7591698278797422
0.7121772640721066
0.6681876173236163
0.6270059840320422
0.5884501358273031
0.5523497082181892
0.5185806608898543
0.48701028564896603
0.45744097912107107
0.4297399727478289
0.4037865887477315
0.37948217352298824
0.35674334384059747
0.33542941660749886
 - max iteration reached - mean error 0.00020640488375267075
incomes for group  3
2826.7697906310827
2779.822795600549
2698.9177237562503
2620.426466483148
2587.0409382467697
2578.4984690498527
2558.5224129791454
2543.1611330032047
2531.028935349942
2525.2526807840018
2514.5434534618817
2489.775365741873
2460.247696938799
2448.412559295621
2441.742743922382
2435.5316678888057
2429.545287111439
2425.9962969668964
2423.123823613768
2408.617963976424
2356.4331009465322
2306.891789559457
2276.450978756613
2208.045014351506
2147.7037810040274
2083.372418168942
2041.0249067967802
2003.6006543428932
1970.526675102726
1936.2525731504506
1906.916703827182
1874.4617731632097
1845.4385546718556
1820.153464250957
1793.9127731722933
1753.026296314752
1721.9800873879858
1707.5723640138492
1703.0911457021946
1692.2183851701661
1682.2345501565956
1674.1597519635025
1659.8268496411836
1641.818820593695
1627.1787822247063
1616.7156982051931
1606.932689397229
1594.4110487551836
1579.724418265224
1561.6081256110901
1534.6993863850294
1501.2992765023419
1478.555940307587
1437.028191798509
1390.1447333297317
1342.2198418183898
1276.1383199963975
1249.630768075389
1220.4960944462348
1204.8841610278862
1196.5091870080225
1187.5958216452407
1166.0350826975473
1124.8787749930611
1068.5493502424233
1020.1901506399331
992.9544536004914
985.0631892008372
977.9592200581259
970.7028287223187
962.2132445257125
953.2384389212618
947.5789056152092
943.6411627624535
940.4744820125557
937.0010192496502
932.1757433684803
924.6390894408229
911.8741742264759
896.2368307226751
875.9966764165264
855.0134441013781
834.0723946290384
812.2510894713587
785.932077331964
757.2974744463918
736.3987697624128
715.8054355710716
691.8326462962597
668.6007057499851
647.3618778531119
629.1518810647136
613.9051930397457
598.1299225235874
582.8909218635586
570.1772346629076
559.2108394390001
550.323836909675
543.1737114534099
537.6384771015532
532.7264013519447
528.3774990607768
522.3526300533897
514.4793927344086
507.830824375406
502.03859576697874
497.86170974616357
494.2188262376448
491.7768781097191
490.85162486413077
490.1045380868645
488.6227987808587
485.3519382307302
480.1807759761906
474.95992442720484
471.2818533143441
468.9293553033165
467.3509904578024
466.12616118774645
464.96680925522463
463.25822885192974
458.70752525309615
450.0393213052441
439.10388067374953
428.24253220646193
413.29187332510537
395.3470670659289
380.12236694257587
367.4022538814281
355.0435128363049
343.33256051699465
332.64021015006125
323.54216003725156
315.40195070886216
308.29332188816284
302.45552556499626
297.2912391907567
292.6734406038767
288.86128041038376
285.3753114661544
282.34995330124366
279.7611375982205
277.33678015265554
275.2287141158444
273.17868835630503
271.13105750396215
268.97383419501614
266.4991948013292
262.9333703694931
259.25880381440334
255.59076625878555
251.9063742841206
248.57576275957084
245.78217889445622
243.135998390155
240.4315176345198
237.461857350854
233.89340248081174
228.75964224468999
220.3399318599269
207.61417329909045
196.22039737300207
189.25378567804498
183.77511363655188
179.1454598825958
175.21168380843113
171.44681561249584
167.83935263613563
164.61580347966043
161.37048911300283
158.05972788854658
154.8257292671206
151.9649562460947
148.9567570827051
146.40900419559563
143.89255530363326
141.41217547197655
139.05640162409554
136.8290724990587
134.73357277245302
132.6990009533923
130.67626737840072
128.6859049405173
126.74451492110867
124.87600063720897
123.21593163013392
121.61783939186566
120.07186698011303
118.59165591019891
117.18854147674253
115.82800154758014
114.47307202755702
113.11224027193398
111.71890540945044
110.26394142821094
108.75194754309327
107.20015425202685
105.64174414576344
104.11683856422675
102.65750124493822
 - max iteration reached - mean error 0.07737683643195799
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We update the parameter vector</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lambdaKeep</span><span class="p">)</span>

<span class="c1"># We print the calibrated values (when possible)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lambda = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">]))</span>

<span class="c1"># We save them</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;lambdaKeep.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;incomeCentersKeep.npy&#39;</span><span class="p">,</span>
        <span class="n">incomeCentersKeep</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
lambda = 2.679168324819032
</pre></div></div>
</div>
<p>Note that incomes are fitted to reproduce the observed distribution of jobs across income groups (in selected job centers), based on commuting choice model.</p>
<div class="section" id="Let-us-first-visualize-inputs">
<h3>Let us first visualize inputs<a class="headerlink" href="#Let-us-first-visualize-inputs" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We import the employment data at the TAZ (transport zone) level</span>
<span class="kn">import</span> <span class="nn">outputs.export_outputs</span> <span class="k">as</span> <span class="nn">outexp</span>
<span class="n">jobsTable</span><span class="p">,</span> <span class="n">selected_centers</span> <span class="o">=</span> <span class="n">outexp</span><span class="o">.</span><span class="n">import_employment_geodata</span><span class="p">(</span>
    <span class="n">households_per_income_class</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">path_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Then, we visualize number of jobs for income group 1</span>
<span class="n">jobs_poor_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geo_TAZ</span><span class="p">,</span> <span class="n">jobsTable</span><span class="p">[</span><span class="s2">&quot;poor_jobs&quot;</span><span class="p">],</span>
                        <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">jobs_poor_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jobs_poor_2d</span><span class="p">,</span> <span class="n">selected_centers</span><span class="p">,</span>
                        <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">jobs_poor_2d</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="n">path_input_tables</span> <span class="o">+</span> <span class="s1">&#39;jobs_poor&#39;</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
<span class="n">jobs_poor_2d_select</span> <span class="o">=</span> <span class="n">jobs_poor_2d</span><span class="p">[</span>
    <span class="p">(</span><span class="n">jobs_poor_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3740000</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">jobs_poor_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10000</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">jobs_poor_2d_select</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">jobs_poor_2d_select</span><span class="p">[</span><span class="s2">&quot;selected_centers&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;jobs_poor&#39;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Number of poor jobs in selected job centers (data)&quot;</span><span class="p">)</span>
<span class="n">jobs_poor_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;poor_jobs&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                         <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;jobs_poor_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;jobs_poor_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_62_0.png" src="_images/calib_nb_62_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Then for income group 2</span>
<span class="n">jobs_midpoor_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geo_TAZ</span><span class="p">,</span> <span class="n">jobsTable</span><span class="p">[</span><span class="s2">&quot;midpoor_jobs&quot;</span><span class="p">],</span>
                           <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">jobs_midpoor_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jobs_midpoor_2d</span><span class="p">,</span> <span class="n">selected_centers</span><span class="p">,</span>
                           <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># jobs_midpoor_2d.to_file(path_tables + &#39;jobs_midpoor&#39; + &#39;.shp&#39;)</span>
<span class="n">jobs_midpoor_2d</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="n">path_input_tables</span> <span class="o">+</span> <span class="s1">&#39;jobs_midpoor&#39;</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
<span class="n">jobs_midpoor_2d_select</span> <span class="o">=</span> <span class="n">jobs_midpoor_2d</span><span class="p">[</span>
    <span class="p">(</span><span class="n">jobs_midpoor_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3740000</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">jobs_midpoor_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10000</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">jobs_midpoor_2d_select</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">jobs_midpoor_2d_select</span><span class="p">[</span><span class="s2">&quot;selected_centers&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;jobs_midpoor&#39;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Number of midpoor jobs in selected job centers (data)&quot;</span><span class="p">)</span>
<span class="n">jobs_midpoor_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;midpoor_jobs&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;jobs_midpoor_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;jobs_midpoor_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_63_0.png" src="_images/calib_nb_63_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For income group 3</span>
<span class="n">jobs_midrich_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geo_TAZ</span><span class="p">,</span> <span class="n">jobsTable</span><span class="p">[</span><span class="s2">&quot;midrich_jobs&quot;</span><span class="p">],</span>
                           <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">jobs_midrich_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jobs_midrich_2d</span><span class="p">,</span> <span class="n">selected_centers</span><span class="p">,</span>
                           <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># jobs_midrich_2d.to_file(path_tables + &#39;jobs_midrich&#39; + &#39;.shp&#39;)</span>
<span class="n">jobs_midrich_2d</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="n">path_input_tables</span> <span class="o">+</span> <span class="s1">&#39;jobs_midrich&#39;</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
<span class="n">jobs_midrich_2d_select</span> <span class="o">=</span> <span class="n">jobs_midrich_2d</span><span class="p">[</span>
    <span class="p">(</span><span class="n">jobs_midrich_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3740000</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">jobs_midrich_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10000</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">jobs_midrich_2d_select</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">jobs_midrich_2d_select</span><span class="p">[</span><span class="s2">&quot;selected_centers&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;jobs_midrich&#39;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Number of midrich jobs in selected job centers (data)&quot;</span><span class="p">)</span>
<span class="n">jobs_midrich_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;midrich_jobs&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;jobs_midrich_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;jobs_midrich_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_64_0.png" src="_images/calib_nb_64_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For income group 4</span>
<span class="n">jobs_rich_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geo_TAZ</span><span class="p">,</span> <span class="n">jobsTable</span><span class="p">[</span><span class="s2">&quot;rich_jobs&quot;</span><span class="p">],</span>
                        <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">jobs_rich_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jobs_rich_2d</span><span class="p">,</span> <span class="n">selected_centers</span><span class="p">,</span>
                        <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># jobs_rich_2d.to_file(path_tables + &#39;jobs_rich&#39; + &#39;.shp&#39;)</span>
<span class="n">jobs_rich_2d</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="n">path_input_tables</span> <span class="o">+</span> <span class="s1">&#39;jobs_rich&#39;</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
<span class="n">jobs_rich_2d_select</span> <span class="o">=</span> <span class="n">jobs_rich_2d</span><span class="p">[</span>
    <span class="p">(</span><span class="n">jobs_rich_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3740000</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">jobs_rich_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10000</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">jobs_rich_2d_select</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">jobs_rich_2d_select</span><span class="p">[</span><span class="s2">&quot;selected_centers&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;jobs_rich&#39;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Number of rich jobs in selected job centers (data)&quot;</span><span class="p">)</span>
<span class="n">jobs_rich_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;rich_jobs&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                         <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;jobs_rich_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;jobs_rich_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_65_0.png" src="_images/calib_nb_65_0.png" />
</div>
</div>
</div>
<div class="section" id="We-visualize-the-associated-calibrated-outputs">
<h3>We visualize the associated calibrated outputs<a class="headerlink" href="#We-visualize-the-associated-calibrated-outputs" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We first load and rearrange the data that we just computed</span>
<span class="n">income_centers_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;incomeCentersKeep.npy&#39;</span><span class="p">)</span>
<span class="n">income_centers_init</span><span class="p">[</span><span class="n">income_centers_init</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">income_centers_init_merge</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">income_centers_init</span><span class="p">)</span>
<span class="n">income_centers_init_merge</span> <span class="o">=</span> <span class="n">income_centers_init_merge</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">income_centers_init_merge</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="s1">&#39;poor_income&#39;</span><span class="p">,</span>
             <span class="n">income_centers_init_merge</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="s1">&#39;midpoor_income&#39;</span><span class="p">,</span>
             <span class="n">income_centers_init_merge</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="s1">&#39;midrich_income&#39;</span><span class="p">,</span>
             <span class="n">income_centers_init_merge</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="s1">&#39;rich_income&#39;</span><span class="p">})</span>
<span class="n">income_centers_init_merge</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">income_centers_init_merge</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We prepare, execute, and clean the merge with geographic grid</span>
<span class="n">selected_centers_merge</span> <span class="o">=</span> <span class="n">selected_centers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="p">(</span><span class="n">selected_centers_merge</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">selected_centers_merge</span><span class="o">.</span><span class="n">selected_centers</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<span class="n">selected_centers_merge</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">selected_centers_merge</span><span class="o">.</span><span class="n">selected_centers</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">income_centers_TAZ</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">income_centers_init_merge</span><span class="p">,</span>
                              <span class="n">selected_centers_merge</span><span class="p">,</span>
                              <span class="n">how</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
<span class="n">income_centers_TAZ</span> <span class="o">=</span> <span class="n">income_centers_TAZ</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">income_centers_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geo_TAZ</span><span class="p">,</span> <span class="n">income_centers_TAZ</span><span class="p">,</span>
                             <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">income_centers_2d</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="n">path_input_tables</span> <span class="o">+</span> <span class="s1">&#39;income_centers_2d&#39;</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>

<span class="n">income_centers_2d_select</span> <span class="o">=</span> <span class="n">income_centers_2d</span><span class="p">[</span>
    <span class="p">(</span><span class="n">income_centers_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxy</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3740000</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">income_centers_2d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">maxx</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10000</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We then visualize calibrated incomes for income group 1</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Average calibrated incomes per job center for poor households&quot;</span><span class="p">)</span>
<span class="n">income_centers_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;poor_income&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                              <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;poor_income_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;poor_income_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_69_0.png" src="_images/calib_nb_69_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For income group 2</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Average calibrated incomes per job center for mid-poor households&quot;</span><span class="p">)</span>
<span class="n">income_centers_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;midpoor_income&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                              <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;midpoor_income_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;midpoor_income_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_70_0.png" src="_images/calib_nb_70_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For income group 3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Average calibrated incomes per job center for mid-rich households&quot;</span><span class="p">)</span>
<span class="n">income_centers_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;midrich_income&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                              <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;midrich_income_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;midrich_income_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_71_0.png" src="_images/calib_nb_71_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For income group 4</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Average calibrated incomes per job center for rich households&quot;</span><span class="p">)</span>
<span class="n">income_centers_2d_select</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;rich_income&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                              <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s1">&#39;rich_income_in_selected_centers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;rich_income_in_selected_centers.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_72_0.png" src="_images/calib_nb_72_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Calibrate-utility-function-parameters">
<h2>Calibrate utility function parameters<a class="headerlink" href="#Calibrate-utility-function-parameters" title="Permalink to this heading"></a></h2>
<p>We compute local incomes net of commuting costs at the SP (not grid) level that is used in calibration.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note that lambda and calibrated incomes have an impact here: from now on,</span>
<span class="c1"># we will stop loading precalibrated parameters to rely on the newly</span>
<span class="c1"># calibrated parameters that we just saved</span>
<span class="n">options</span><span class="p">[</span><span class="s2">&quot;load_precal_param&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="p">(</span><span class="n">incomeNetOfCommuting</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_transport_data</span><span class="p">(</span>
     <span class="n">grid</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">households_per_income_class</span><span class="p">,</span> <span class="n">average_income</span><span class="p">,</span>
     <span class="n">spline_inflation</span><span class="p">,</span> <span class="n">spline_fuel</span><span class="p">,</span>
     <span class="n">spline_population_income_distribution</span><span class="p">,</span> <span class="n">spline_income_distribution</span><span class="p">,</span>
     <span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">path_precalc_transp</span><span class="p">,</span> <span class="s1">&#39;SP&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then we calibrate utility function parameters based on the maximization of a composite likelihood that reproduces the fit on exogenous amenities, dwelling sizes, and income sorting.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NB: Here, we also have an impact from construction parameters and sample</span>
<span class="c1"># selection (+ number of formal units)</span>
<span class="kn">import</span> <span class="nn">calibration.calib_main_func</span> <span class="k">as</span> <span class="nn">calmain</span>
<span class="p">(</span><span class="n">calibratedUtility_beta</span><span class="p">,</span> <span class="n">calibratedUtility_q0</span><span class="p">,</span> <span class="n">cal_amenities</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">calmain</span><span class="o">.</span><span class="n">estim_util_func_param</span><span class="p">(</span>
     <span class="n">data_number_formal</span><span class="p">,</span> <span class="n">data_income_group</span><span class="p">,</span> <span class="n">housing_types_sp</span><span class="p">,</span> <span class="n">data_sp</span><span class="p">,</span>
     <span class="n">coeff_a</span><span class="p">,</span> <span class="n">coeff_b</span><span class="p">,</span> <span class="n">coeffKappa</span><span class="p">,</span> <span class="n">interest_rate</span><span class="p">,</span>
     <span class="n">incomeNetOfCommuting</span><span class="p">,</span> <span class="n">selected_density</span><span class="p">,</span> <span class="n">path_data</span><span class="p">,</span> <span class="n">path_precalc_inp</span><span class="p">,</span>
     <span class="n">options</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Done:
0
1
2
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4135075811199389978199064576.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4151181453875466981517295616.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4164405745802764940939886592.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4175314171060144829827645440.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4184350814514795725147078656.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
3
4
5
6
7
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4191866421404378334391959552.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4198139653459922484067303424.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4203393215966142488079499264.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
8
9
10
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4207806130058528315060256768.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4211523109752039516105867264.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4214661761741174136966742016.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274

Scanning complete


                            OLS Regression Results
==============================================================================
Dep. Variable:                      y   R-squared:                       0.115
Model:                            OLS   Adj. R-squared:                  0.088
Method:                 Least Squares   F-statistic:                     4.281
Date:                Wed, 21 Sep 2022   Prob (F-statistic):           3.04e-05
Time:                        18:21:56   Log-Likelihood:                -4.0681
No. Observations:                 307   AIC:                             28.14
Df Residuals:                     297   BIC:                             65.40
Df Model:                           9
Covariance Type:            nonrobust
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
const          0.4173      0.039     10.587      0.000       0.340       0.495
x1             0.1299      0.042      3.068      0.002       0.047       0.213
x2             0.0495      0.047      1.050      0.294      -0.043       0.142
x3             0.1614      0.035      4.612      0.000       0.093       0.230
x4             0.1612      0.050      3.220      0.001       0.063       0.260
x5            -0.0304      0.069     -0.443      0.658      -0.165       0.105
x6             0.0208      0.045      0.467      0.641      -0.067       0.108
x7             0.0576      0.039      1.473      0.142      -0.019       0.135
x8             0.0588      0.036      1.629      0.104      -0.012       0.130
x9            -0.0096      0.053     -0.180      0.857      -0.115       0.095
==============================================================================
Omnibus:                      198.009   Durbin-Watson:                   1.238
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             1700.919
Skew:                          -2.619   Prob(JB):                         0.00
Kurtosis:                      13.273   Cond. No.                         6.56
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4175314171060144829827645440.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4175314180967254769484693504.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
C:\Users\monni\miniconda3\envs\doc\lib\site-packages\scipy\interpolate\_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the additional knot would
coincide with an old one. Probable cause: s too small or too large
a weight to an inaccurate data point. (fp&gt;s)
        kx,ky=1,1 nx,ny=4,4 m=8096 fp=4175314150033100403158024192.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
      fun: 430.5308837454141
 hess_inv: &lt;4x4 LbfgsInvHessProduct with dtype=float64&gt;
      jac: array([5.68434189e-06, 5.68434192e-06, 5.68388505e-06, 5.68595342e-06])
  message: &#39;CONVERGENCE: NORM_OF_PROJECTED_GRADIENT_&lt;=_PGTOL&#39;
     nfev: 5
      nit: 0
     njev: 1
   status: 0
  success: True
        x: array([2.60000000e-01, 3.97137219e+00, 1.44000000e+04, 6.72000000e+04])
*** Estimation of beta and q0 done ***
                            OLS Regression Results
==============================================================================
Dep. Variable:                      y   R-squared:                       0.109
Model:                            OLS   Adj. R-squared:                  0.082
Method:                 Least Squares   F-statistic:                     4.029
Date:                Wed, 21 Sep 2022   Prob (F-statistic):           6.98e-05
Time:                        18:21:57   Log-Likelihood:                 49.539
No. Observations:                 307   AIC:                            -79.08
Df Residuals:                     297   BIC:                            -41.81
Df Model:                           9
Covariance Type:            nonrobust
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
const         -0.1516      0.033     -4.580      0.000      -0.217      -0.086
x1             0.1172      0.036      3.296      0.001       0.047       0.187
x2             0.0475      0.040      1.201      0.231      -0.030       0.125
x3             0.1333      0.029      4.536      0.000       0.075       0.191
x4             0.1378      0.042      3.278      0.001       0.055       0.221
x5            -0.0302      0.058     -0.525      0.600      -0.144       0.083
x6             0.0317      0.037      0.846      0.398      -0.042       0.105
x7             0.0380      0.033      1.158      0.248      -0.027       0.103
x8             0.0510      0.030      1.684      0.093      -0.009       0.111
x9            -0.0482      0.045     -1.075      0.283      -0.136       0.040
==============================================================================
Omnibus:                      176.557   Durbin-Watson:                   1.161
Prob(Omnibus):                  0.000   Jarque-Bera (JB):             1306.206
Skew:                          -2.307   Prob(JB):                    2.30e-284
Kurtosis:                      11.991   Cond. No.                         6.56
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</pre></div></div>
</div>
<p>The warnings in the execution come from the fact that rent interpolation is discountinuous when underlying data is scattered. This is not a big issue to the extent that we are not interested in the shape of the rent function per se, but it causes optimization solver to break down when the associated likelihood function is not smooth. The calibration therefore essentially relies on parameter scanning.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We update parameter vector</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibratedUtility_beta</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;q0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibratedUtility_q0</span>

<span class="c1"># We print calibrated values (when possible)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;beta = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;q0 = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;q0&quot;</span><span class="p">]))</span>

<span class="c1"># We save them</span>
<span class="c1"># NB : alpha = 1 - beta</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;calibratedUtility_beta.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;calibratedUtility_q0.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;q0&quot;</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;calibratedAmenities.npy&#39;</span><span class="p">,</span>
        <span class="n">cal_amenities</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
beta = 0.26
q0 = 3.9713721908703206
</pre></div></div>
</div>
</div>
<div class="section" id="Calibrate-disamenity-index-for-informal-backyards-+-settlements">
<h2>Calibrate disamenity index for informal backyards + settlements<a class="headerlink" href="#Calibrate-disamenity-index-for-informal-backyards-+-settlements" title="Permalink to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We first need to recompute income net of commuting costs at baseline</span>
<span class="c1"># year since calibrated income has changed</span>

<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="p">(</span><span class="n">incomeNetOfCommuting</span><span class="p">,</span> <span class="n">modalShares</span><span class="p">,</span> <span class="n">ODflows</span><span class="p">,</span> <span class="n">averageIncome</span>
 <span class="p">)</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_transport_data</span><span class="p">(</span>
     <span class="n">grid</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">households_per_income_class</span><span class="p">,</span> <span class="n">average_income</span><span class="p">,</span>
     <span class="n">spline_inflation</span><span class="p">,</span> <span class="n">spline_fuel</span><span class="p">,</span>
     <span class="n">spline_population_income_distribution</span><span class="p">,</span> <span class="n">spline_income_distribution</span><span class="p">,</span>
     <span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">path_precalc_transp</span><span class="p">,</span> <span class="s1">&#39;GRID&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

<span class="n">income_net_of_commuting_costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="n">path_precalc_transp</span> <span class="o">+</span> <span class="s1">&#39;GRID_incomeNetOfCommuting_0.npy&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Then, we do the same for the amenity index (calibrated values normalized around 1)</span>
<span class="kn">import</span> <span class="nn">inputs.data</span> <span class="k">as</span> <span class="nn">inpdt</span>
<span class="n">amenities</span> <span class="o">=</span> <span class="n">inpdt</span><span class="o">.</span><span class="n">import_amenities</span><span class="p">(</span><span class="n">path_precalc_inp</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let us visualize the calibrated amenity index</span>
<span class="kn">import</span> <span class="nn">outputs.export_outputs</span> <span class="k">as</span> <span class="nn">outexp</span>
<span class="n">amenity_map</span> <span class="o">=</span> <span class="n">outexp</span><span class="o">.</span><span class="n">export_map</span><span class="p">(</span>
    <span class="n">amenities</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">geo_grid</span><span class="p">,</span> <span class="n">path_input_plots</span><span class="p">,</span> <span class="s1">&#39;amenity_map&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Map of average amenity index per location&quot;</span><span class="p">,</span>
    <span class="n">path_input_tables</span><span class="p">,</span>
    <span class="n">ubnd</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">lbnd</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;amenity_map.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
amenity_map done
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_83_1.png" src="_images/calib_nb_83_1.png" />
</div>
</div>
<p>NB: Since disamenity index calibration relies on the model fit and is not computed a priori (contrary to other parameters), the options set in the preamble should be the same as the ones used in the main script, so that the calibrated values are in line with the structural assumptions used</p>
<div class="section" id="We-start-with-a-general-(not-location-specific)-calibration">
<h3>We start with a general (not location-specific) calibration<a class="headerlink" href="#We-start-with-a-general-(not-location-specific)-calibration" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We define a range of disamenity values which we would like to scan,</span>
<span class="c1"># and arrange them in a grid</span>
<span class="n">list_amenity_backyard</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.62</span><span class="p">,</span> <span class="mf">0.661</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">list_amenity_settlement</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.641</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">housing_type_total</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
    <span class="n">list_amenity_backyard</span><span class="p">,</span> <span class="n">list_amenity_settlement</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">housing_type_total</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;param_backyard&quot;</span><span class="p">,</span> <span class="s2">&quot;param_settlement&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We initialize output vector</span>
<span class="n">housing_type_total</span><span class="p">[</span><span class="s2">&quot;formal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">housing_type_total</span><span class="o">.</span><span class="n">param_backyard</span><span class="p">))</span>
<span class="n">housing_type_total</span><span class="p">[</span><span class="s2">&quot;backyard&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">housing_type_total</span><span class="o">.</span><span class="n">param_backyard</span><span class="p">))</span>
<span class="n">housing_type_total</span><span class="p">[</span><span class="s2">&quot;informal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">housing_type_total</span><span class="o">.</span><span class="n">param_backyard</span><span class="p">))</span>
<span class="n">housing_type_total</span><span class="p">[</span><span class="s2">&quot;subsidized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">housing_type_total</span><span class="o">.</span><span class="n">param_backyard</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[83]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We print the number of total iterations (to have an intuition of how long</span>
<span class="c1"># the process will take)</span>
<span class="n">number_total_iterations</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">list_amenity_backyard</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_amenity_settlement</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;** Calibration: </span><span class="si">{</span><span class="n">number_total_iterations</span><span class="si">}</span><span class="s2"> iterations **&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
** Calibration: 25 iterations **
</pre></div></div>
</div>
<p>We are going to compute the initial state equilibrium for each pair of parameters, and retain the one that best fits the observed number of households in informal settlements + backyards</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[84]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">equilibrium.compute_equilibrium</span> <span class="k">as</span> <span class="nn">eqcmp</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_amenity_backyard</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_amenity_settlement</span><span class="p">)):</span>

        <span class="c1"># We set input values</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_backyard&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_amenity_backyard</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_settlement&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_amenity_settlement</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_settlement&quot;</span><span class="p">]</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
                                     <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_backyard&quot;</span><span class="p">])</span>

        <span class="c1"># We run the algorithm</span>
        <span class="p">(</span><span class="n">initial_state_utility</span><span class="p">,</span>
         <span class="n">initial_state_error</span><span class="p">,</span>
         <span class="n">initial_state_simulated_jobs</span><span class="p">,</span>
         <span class="n">initial_state_households_housing_types</span><span class="p">,</span>
         <span class="n">initial_state_household_centers</span><span class="p">,</span>
         <span class="n">initial_state_households</span><span class="p">,</span>
         <span class="n">initial_state_dwelling_size</span><span class="p">,</span>
         <span class="n">initial_state_housing_supply</span><span class="p">,</span>
         <span class="n">initial_state_rent</span><span class="p">,</span>
         <span class="n">initial_state_rent_matrix</span><span class="p">,</span>
         <span class="n">initial_state_capital_land</span><span class="p">,</span>
         <span class="n">initial_state_average_income</span><span class="p">,</span>
         <span class="n">initial_state_limit_city</span><span class="p">)</span> <span class="o">=</span> <span class="n">eqcmp</span><span class="o">.</span><span class="n">compute_equilibrium</span><span class="p">(</span>
             <span class="n">fraction_capital_destroyed</span><span class="p">,</span>
             <span class="n">amenities</span><span class="p">,</span>
             <span class="n">param</span><span class="p">,</span>
             <span class="n">housing_limit</span><span class="p">,</span>
             <span class="n">population</span><span class="p">,</span>
             <span class="n">households_per_income_class</span><span class="p">,</span>
             <span class="n">total_RDP</span><span class="p">,</span>
             <span class="n">coeff_land</span><span class="p">,</span>
             <span class="n">income_net_of_commuting_costs</span><span class="p">,</span>
             <span class="n">grid</span><span class="p">,</span>
             <span class="n">options</span><span class="p">,</span>
             <span class="n">agricultural_rent</span><span class="p">,</span>
             <span class="n">interest_rate</span><span class="p">,</span>
             <span class="n">number_properties_RDP</span><span class="p">,</span>
             <span class="n">average_income</span><span class="p">,</span>
             <span class="n">mean_income</span><span class="p">,</span>
             <span class="n">income_class_by_housing_type</span><span class="p">,</span>
             <span class="n">minimum_housing_supply</span><span class="p">,</span>
             <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_A&quot;</span><span class="p">],</span>
             <span class="n">income_2011</span><span class="p">)</span>

        <span class="c1"># We fill output matrix with the total number of HHs per housing</span>
        <span class="c1"># type for given values of backyard and informal amenity parameters</span>
        <span class="n">housing_type_total</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">housing_type_total</span><span class="o">.</span><span class="n">param_backyard</span>
             <span class="o">==</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_backyard&quot;</span><span class="p">])</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">housing_type_total</span><span class="o">.</span><span class="n">param_settlement</span>
               <span class="o">==</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_settlement&quot;</span><span class="p">]),</span>
            <span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">initial_state_households_housing_types</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># We update the iteration count and print progress made</span>
        <span class="n">iteration_number</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_amenity_settlement</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;iteration </span><span class="si">{</span><span class="n">iteration_number</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">number_total_iterations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:40, 47.29it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 1/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 73/2000 [00:01&lt;00:41, 46.10it/s, error_max_abs=0.0178]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 2/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:40, 47.15it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 3/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 47.02it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 4/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.64it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 5/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 73/2000 [00:01&lt;00:41, 46.51it/s, error_max_abs=0.0183]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 6/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.39it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 7/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:42, 45.77it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 8/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:42, 45.73it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 9/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.52it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 10/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.61it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 11/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  70%|████████████████▊       | 1401/2000 [00:30&lt;00:13, 45.96it/s, error_max_abs=0.0184]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 12/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.26it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 13/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 73/2000 [00:01&lt;00:41, 46.29it/s, error_max_abs=0.0185]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 14/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:42, 45.66it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 15/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:42, 45.46it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 16/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:44, 43.68it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 17/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.00it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 18/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 74/2000 [00:01&lt;00:42, 45.71it/s, error_max_abs=0.0168]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 19/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:42, 45.58it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 20/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:42, 45.60it/s, error_max_abs=0.0199]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 21/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:44, 43.76it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 22/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:43, 44.28it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 23/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.03it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 24/25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|█                         | 85/2000 [00:01&lt;00:42, 45.58it/s, error_max_abs=0.0166]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 25/25
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We compute the error between simulated and observed number of households</span>
<span class="c1"># in each housing type (without RDP, which is exogenously set equal to data)</span>
<span class="n">distance_share</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
    <span class="n">housing_type_total</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">housing_type_data</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>

<span class="c1"># We define the score that we want to minimize as the sum of the errors for</span>
<span class="c1"># informal backyards and informal settlements</span>
<span class="n">distance_share_score</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">distance_share</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">distance_share</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>

<span class="c1"># We select the arguments associated with the minimum</span>
<span class="n">which</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distance_share_score</span><span class="p">)</span>
<span class="n">min_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">distance_share_score</span><span class="p">)</span>
<span class="n">calibrated_amenities</span> <span class="o">=</span> <span class="n">housing_type_total</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">which</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[86]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We update parameter vector</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_backyard&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibrated_amenities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_settlement&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibrated_amenities</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># We print the calibrated values</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;amenity_backyard = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_backyard&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;amenity_settlement = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_settlement&quot;</span><span class="p">]))</span>

<span class="c1"># We save them</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;param_amenity_backyard.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_backyard&quot;</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;param_amenity_settlement.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_settlement&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
amenity_backyard = 0.64
amenity_settlement = 0.62
</pre></div></div>
</div>
</div>
<div class="section" id="Calibrate-location-specific-disamenity-index">
<h3>Calibrate location-specific disamenity index<a class="headerlink" href="#Calibrate-location-specific-disamenity-index" title="Permalink to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[87]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Default is set to 1 but can be changed if we fear overfit of the model</span>
<span class="kn">import</span> <span class="nn">equilibrium.compute_equilibrium</span> <span class="k">as</span> <span class="nn">eqcmp</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;location_based_calib&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

    <span class="c1"># We start from where we left (to gain time) and compute the</span>
    <span class="c1"># equilibrium again</span>

    <span class="c1"># We first initialize input values</span>

    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">index_max</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">index_max</span><span class="p">)</span>

    <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_settlement&quot;</span><span class="p">]</span>
    <span class="n">save_param_informal_settlements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">index_max</span><span class="p">,</span> <span class="mi">24014</span><span class="p">))</span>
    <span class="n">metrics_is</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">index_max</span><span class="p">)</span>
    <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;amenity_backyard&quot;</span><span class="p">]</span>
    <span class="n">save_param_backyards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">index_max</span><span class="p">,</span> <span class="mi">24014</span><span class="p">))</span>
    <span class="n">metrics_ib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">index_max</span><span class="p">)</span>

    <span class="c1"># We run the algorithm</span>
    <span class="p">(</span><span class="n">initial_state_utility</span><span class="p">,</span>
     <span class="n">initial_state_error</span><span class="p">,</span>
     <span class="n">initial_state_simulated_jobs</span><span class="p">,</span>
     <span class="n">initial_state_households_housing_types</span><span class="p">,</span>
     <span class="n">initial_state_household_centers</span><span class="p">,</span>
     <span class="n">initial_state_households</span><span class="p">,</span>
     <span class="n">initial_state_dwelling_size</span><span class="p">,</span>
     <span class="n">initial_state_housing_supply</span><span class="p">,</span>
     <span class="n">initial_state_rent</span><span class="p">,</span>
     <span class="n">initial_state_rent_matrix</span><span class="p">,</span>
     <span class="n">initial_state_capital_land</span><span class="p">,</span>
     <span class="n">initial_state_average_income</span><span class="p">,</span>
     <span class="n">initial_state_limit_city</span>
     <span class="p">)</span> <span class="o">=</span> <span class="n">eqcmp</span><span class="o">.</span><span class="n">compute_equilibrium</span><span class="p">(</span>
         <span class="n">fraction_capital_destroyed</span><span class="p">,</span>
         <span class="n">amenities</span><span class="p">,</span>
         <span class="n">param</span><span class="p">,</span>
         <span class="n">housing_limit</span><span class="p">,</span>
         <span class="n">population</span><span class="p">,</span>
         <span class="n">households_per_income_class</span><span class="p">,</span>
         <span class="n">total_RDP</span><span class="p">,</span>
         <span class="n">coeff_land</span><span class="p">,</span>
         <span class="n">income_net_of_commuting_costs</span><span class="p">,</span>
         <span class="n">grid</span><span class="p">,</span>
         <span class="n">options</span><span class="p">,</span>
         <span class="n">agricultural_rent</span><span class="p">,</span>
         <span class="n">interest_rate</span><span class="p">,</span>
         <span class="n">number_properties_RDP</span><span class="p">,</span>
         <span class="n">average_income</span><span class="p">,</span>
         <span class="n">mean_income</span><span class="p">,</span>
         <span class="n">income_class_by_housing_type</span><span class="p">,</span>
         <span class="n">minimum_housing_supply</span><span class="p">,</span>
         <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_A&quot;</span><span class="p">],</span>
         <span class="n">income_2011</span><span class="p">)</span>

    <span class="c1"># We set the maximum number of iterations</span>
    <span class="n">number_total_iterations</span> <span class="o">=</span> <span class="n">index_max</span>

    <span class="c1"># Then we optimize over the number of households per housing type</span>
    <span class="c1"># PER PIXEL, and not just on the aggregate number (to acccount for</span>
    <span class="c1"># differing disamenities per location, e.g. eviction probability,</span>
    <span class="c1"># infrastructure networks, etc.)</span>

    <span class="c1"># To do so, we use granular housing_types variable (from SAL data) instead</span>
    <span class="c1"># of aggregate housing_types variable</span>

    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index_max</span><span class="p">):</span>

        <span class="c1"># INFORMAL SETTLEMENTS</span>

        <span class="c1"># We initialize output vector</span>
        <span class="n">diff_is</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24014</span><span class="p">):</span>
            <span class="c1"># We store the error term</span>
            <span class="n">diff_is</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">housing_types</span><span class="o">.</span><span class="n">informal_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                          <span class="o">-</span> <span class="n">initial_state_households_housing_types</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:][</span><span class="n">i</span><span class="p">]</span>
                          <span class="p">)</span>
            <span class="c1"># We apply an empirical reweighting that helps convergence</span>
            <span class="n">adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff_is</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">150000</span><span class="p">)</span>
            <span class="c1"># We increase the amenity score when we underestimate the nb of</span>
            <span class="c1"># households</span>
            <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">adj</span>
        <span class="c1"># We store iteration outcome and prevent extreme sorting from</span>
        <span class="c1"># happening due to the amenity score</span>
        <span class="n">metrics_is</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff_is</span><span class="p">))</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.99</span>
        <span class="n">save_param_informal_settlements</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">]</span>

        <span class="c1"># INFORMAL BACKYARDS</span>

        <span class="c1"># We initialize output vector</span>
        <span class="n">diff_ib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">24014</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24014</span><span class="p">):</span>
            <span class="c1"># Note that we add an option depending on whether we restrict</span>
            <span class="c1"># ourselves to informal backyards (default) or all kinds of</span>
            <span class="c1"># backyards (not warranted given the standardized structure</span>
            <span class="c1"># assumed in the model)</span>
            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;actual_backyards&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">diff_ib</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">housing_types</span><span class="o">.</span><span class="n">backyard_informal_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">housing_types</span><span class="o">.</span><span class="n">backyard_formal_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">initial_state_households_housing_types</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:][</span><span class="n">i</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;actual_backyards&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">diff_ib</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">housing_types</span><span class="o">.</span><span class="n">backyard_informal_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">initial_state_households_housing_types</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:][</span><span class="n">i</span><span class="p">])</span>
            <span class="c1"># We help convergence and update parameter</span>
            <span class="n">adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff_ib</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">75000</span><span class="p">)</span>
            <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">adj</span><span class="p">)</span>
        <span class="c1"># We store iteration output and prevent extreme sorting</span>
        <span class="n">metrics_ib</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff_ib</span><span class="p">))</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.99</span>
        <span class="n">save_param_backyards</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">]</span>

        <span class="c1"># We retain the sum of the errors as our minimization objective</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_is</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">metrics_ib</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># We run the equilibrium again with updated values of</span>
        <span class="c1"># informal/backyard housing disamenity indices, then go to the next</span>
        <span class="c1"># iteration</span>

        <span class="p">(</span><span class="n">initial_state_utility</span><span class="p">,</span> <span class="n">initial_state_error</span><span class="p">,</span>
         <span class="n">initial_state_simulated_jobs</span><span class="p">,</span>
         <span class="n">initial_state_households_housing_types</span><span class="p">,</span>
         <span class="n">initial_state_household_centers</span><span class="p">,</span>
         <span class="n">initial_state_households</span><span class="p">,</span> <span class="n">initial_state_dwelling_size</span><span class="p">,</span>
         <span class="n">initial_state_housing_supply</span><span class="p">,</span> <span class="n">initial_state_rent</span><span class="p">,</span>
         <span class="n">initial_state_rent_matrix</span><span class="p">,</span> <span class="n">initial_state_capital_land</span><span class="p">,</span>
         <span class="n">initial_state_average_income</span><span class="p">,</span> <span class="n">initial_state_limit_city</span>
         <span class="p">)</span> <span class="o">=</span> <span class="n">eqcmp</span><span class="o">.</span><span class="n">compute_equilibrium</span><span class="p">(</span>
             <span class="n">fraction_capital_destroyed</span><span class="p">,</span> <span class="n">amenities</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">housing_limit</span><span class="p">,</span>
             <span class="n">population</span><span class="p">,</span> <span class="n">households_per_income_class</span><span class="p">,</span> <span class="n">total_RDP</span><span class="p">,</span>
             <span class="n">coeff_land</span><span class="p">,</span> <span class="n">income_net_of_commuting_costs</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
             <span class="n">agricultural_rent</span><span class="p">,</span> <span class="n">interest_rate</span><span class="p">,</span> <span class="n">number_properties_RDP</span><span class="p">,</span>
             <span class="n">average_income</span><span class="p">,</span> <span class="n">mean_income</span><span class="p">,</span> <span class="n">income_class_by_housing_type</span><span class="p">,</span>
             <span class="n">minimum_housing_supply</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;coeff_A&quot;</span><span class="p">],</span> <span class="n">income_2011</span><span class="p">)</span>

        <span class="n">iteration_number</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;iteration </span><span class="si">{</span><span class="n">iteration_number</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">number_total_iterations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.16it/s, error_max_abs=0.0182]
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:43, 44.27it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 1/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.93it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 2/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 73/2000 [00:01&lt;00:41, 46.54it/s, error_max_abs=0.0178]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 3/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:51, 37.74it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 4/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:40, 47.53it/s, error_max_abs=0.0195]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 5/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:40, 47.62it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 6/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:43, 44.18it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 7/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:40, 47.20it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 8/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  51%|████████████▏           | 1019/2000 [00:21&lt;00:20, 46.95it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 9/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.78it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 10/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  13%|███▎                     | 265/2000 [00:05&lt;00:36, 47.23it/s, error_max_abs=0.0197]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 11/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:40, 47.61it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 12/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  27%|██████▉                   | 537/2000 [00:11&lt;00:31, 46.83it/s, error_max_abs=0.019]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 13/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  43%|██████████▋              | 851/2000 [00:18&lt;00:24, 46.62it/s, error_max_abs=0.0164]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 14/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   8%|██▏                        | 162/2000 [00:03&lt;00:39, 46.76it/s, error_max_abs=0.02]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 15/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  75%|█████████████████▉      | 1492/2000 [00:32&lt;00:10, 46.45it/s, error_max_abs=0.0107]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 16/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  39%|█████████▍              | 782/2000 [00:16&lt;00:26, 46.38it/s, error_max_abs=0.00188]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 17/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 73/2000 [00:01&lt;00:40, 47.08it/s, error_max_abs=0.0178]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 18/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  38%|█████████               | 753/2000 [00:16&lt;00:27, 46.01it/s, error_max_abs=0.00287]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 19/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  27%|██████▌                 | 547/2000 [00:12&lt;00:32, 45.02it/s, error_max_abs=0.00262]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 20/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  54%|████████████▍          | 1081/2000 [00:23&lt;00:19, 46.18it/s, error_max_abs=0.00209]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 21/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  84%|████████████████████▏   | 1686/2000 [00:37&lt;00:06, 45.51it/s, error_max_abs=0.0189]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 22/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:41, 46.03it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 23/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  22%|█████▋                    | 436/2000 [00:09&lt;00:34, 45.14it/s, error_max_abs=0.013]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 24/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  39%|█████████▊               | 785/2000 [00:17&lt;00:27, 44.93it/s, error_max_abs=0.0193]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 25/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  18%|████▎                   | 355/2000 [00:07&lt;00:36, 44.90it/s, error_max_abs=0.00792]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 26/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  69%|████████████████▌       | 1376/2000 [00:30&lt;00:13, 45.02it/s, error_max_abs=0.0189]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 27/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  30%|███████▍                 | 593/2000 [00:13&lt;00:31, 44.21it/s, error_max_abs=0.0093]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 28/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  46%|███████████             | 918/2000 [00:20&lt;00:24, 44.52it/s, error_max_abs=0.00797]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 29/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  37%|█████████▏               | 737/2000 [00:16&lt;00:27, 45.15it/s, error_max_abs=0.0189]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 30/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:42, 45.89it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 31/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  87%|█████████████████████▋   | 1739/2000 [00:40&lt;00:06, 42.47it/s, error_max_abs=0.013]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 32/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  42%|██████████▍              | 837/2000 [00:24&lt;00:33, 34.43it/s, error_max_abs=0.0161]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 33/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  74%|█████████████████      | 1486/2000 [00:37&lt;00:12, 39.69it/s, error_max_abs=0.00674]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 34/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  58%|██████████████▉           | 1151/2000 [00:26&lt;00:19, 43.98it/s, error_max_abs=0.02]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 35/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02: 100%|███████████████████████▉| 1999/2000 [00:49&lt;00:00, 40.36it/s, error_max_abs=0.0294]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 36/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:47, 40.44it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 37/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:46, 41.53it/s, error_max_abs=0.0197]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 38/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  82%|████████████████████▍    | 1636/2000 [00:42&lt;00:09, 38.53it/s, error_max_abs=0.011]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 39/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  36%|█████████                | 721/2000 [00:18&lt;00:32, 39.84it/s, error_max_abs=0.0191]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 40/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:47, 40.53it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 41/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  51%|████████████▎           | 1028/2000 [00:40&lt;00:38, 25.20it/s, error_max_abs=0.0118]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 42/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:03&lt;01:42, 18.81it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 43/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  92%|█████████████████████▎ | 1848/2000 [01:00&lt;00:04, 30.67it/s, error_max_abs=0.00641]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 44/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:02&lt;00:58, 33.00it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 45/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:02&lt;00:57, 33.48it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 46/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  41%|█████████▉              | 825/2000 [00:24&lt;00:34, 34.25it/s, error_max_abs=0.00964]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 47/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  13%|███▎                     | 268/2000 [00:07&lt;00:50, 34.12it/s, error_max_abs=0.0194]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 48/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:   4%|▉                         | 72/2000 [00:01&lt;00:53, 36.17it/s, error_max_abs=0.0182]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 49/50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
stops when error_max_abs &lt;0.02:  11%|██▊                      | 224/2000 [00:06&lt;00:52, 33.90it/s, error_max_abs=0.0199]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
iteration 50/50
0.40678920836767085
0.6194845398082257
0.8039969236529559
0.4497641257277256
0.6393183222476003
0.9200420940045734
[WinError 183] Cannot create a file when that file already exists: &#39;../Data/Precalculated inputs/&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[93]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We pick the set of parameters that minimize the sum of absolute diffs</span>
<span class="c1"># between data and simulation</span>
<span class="n">score_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
<span class="n">index_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

<span class="c1"># We update the parameter vector</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_param_informal_settlements</span><span class="p">[</span><span class="n">index_min</span><span class="p">]</span>
<span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_param_backyards</span><span class="p">[</span><span class="n">index_min</span><span class="p">]</span>

<span class="c1"># We save values</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;param_pockets.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_precalc_inp</span> <span class="o">+</span> <span class="s1">&#39;param_backyards.npy&#39;</span><span class="p">,</span>
        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[94]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let us visualize the calibrated disamenity index for informal settlements</span>
<span class="kn">import</span> <span class="nn">outputs.export_outputs</span> <span class="k">as</span> <span class="nn">outexp</span>
<span class="n">disamenity_IS_map</span> <span class="o">=</span> <span class="n">outexp</span><span class="o">.</span><span class="n">export_map</span><span class="p">(</span>
    <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">],</span> <span class="n">grid</span><span class="p">,</span> <span class="n">geo_grid</span><span class="p">,</span> <span class="n">path_input_plots</span><span class="p">,</span> <span class="s1">&#39;disamenity_IS_map&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Map of average disamenity index for informal settlements&quot;</span><span class="p">,</span>
    <span class="n">path_input_tables</span><span class="p">,</span> <span class="n">ubnd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;pockets&quot;</span><span class="p">]))</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;disamenity_IS_map.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
disamenity_IS_map done
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[94]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_96_1.png" src="_images/calib_nb_96_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[95]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Now for informal backyards</span>
<span class="kn">import</span> <span class="nn">outputs.export_outputs</span> <span class="k">as</span> <span class="nn">outexp</span>
<span class="n">disamenity_IB_map</span> <span class="o">=</span> <span class="n">outexp</span><span class="o">.</span><span class="n">export_map</span><span class="p">(</span>
    <span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">],</span> <span class="n">grid</span><span class="p">,</span> <span class="n">geo_grid</span><span class="p">,</span> <span class="n">path_input_plots</span><span class="p">,</span> <span class="s1">&#39;disamenity_IB_map&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Map of average disamenity index for informal backyards&quot;</span><span class="p">,</span>
    <span class="n">path_input_tables</span><span class="p">,</span> <span class="n">ubnd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;backyard_pockets&quot;</span><span class="p">]))</span>

<span class="n">Image</span><span class="p">(</span><span class="n">path_input_plots</span> <span class="o">+</span> <span class="s2">&quot;disamenity_IB_map.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
disamenity_IB_map done
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[95]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/calib_nb_97_1.png" src="_images/calib_nb_97_1.png" />
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="main_nb.html" class="btn btn-neutral float-left" title="Notebook: run model" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="guidelines.html" class="btn btn-neutral float-right" title="User guidelines" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Thomas Monnier.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>